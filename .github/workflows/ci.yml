name: CI

on:
  workflow_dispatch:
  push:
    branches: [main]
    tags:
      - 'v*'
  pull_request:
    branches: [main]

jobs:
  pr-title:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - name: Validate PR title follows conventional commit format
        env:
          PR_TITLE: ${{ github.event.pull_request.title }}
        run: |
          echo "Checking PR title: '$PR_TITLE'"
          # Allow release-please PRs (chore(main): release ...)
          if echo "$PR_TITLE" | grep -qP '^(feat|fix|refactor|test|docs|chore|wip|perf|ci|build|revert)(\([a-zA-Z0-9_./-]+\))?!?: .+'; then
            echo "✅ PR title follows conventional commit format"
          else
            echo ""
            echo "❌ PR title does not follow conventional commit format!"
            echo ""
            echo "Required format: {type}({scope}): {description}"
            echo ""
            echo "  Types: feat, fix, refactor, test, docs, chore, wip, perf, ci, build, revert"
            echo "  Scope: tools, planning, or a descriptive word (optional but recommended)"
            echo ""
            echo "Examples:"
            echo "  fix(tools): remove --local flag from Copilot install"
            echo "  feat(tools): add dark mode to dashboard"
            echo "  docs: update README with new install steps"
            echo ""
            echo "WHY: Release-please uses this to generate the changelog."
            echo "Non-conventional titles are silently ignored and your"
            echo "change won't appear in any release."
            exit 1
          fi

  test:
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        node-version: [18, 20, 22]
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'
      - run: npm install
      - run: npm test -- --coverage
      - run: npm run validate
      - name: Upload test artifacts on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: test-failure-${{ matrix.os }}-node${{ matrix.node-version }}
          path: coverage/
          retention-days: 7

  audit:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: 'npm'
      - run: npm install
      - run: npm audit --audit-level=critical

  dashboard-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: 'npm'
      - run: npm install
      - name: Install dashboard dependencies
        run: npm --prefix dashboard install
      - name: Run dashboard tests
        run: npm --prefix dashboard test

  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: 'npm'
      - run: npm install
      - run: npm run lint
      - name: Lint markdown files
        uses: DavidAnson/markdownlint-cli2-action@v19
        with:
          globs: |
            plugins/pbr/agents/*.md
            plugins/pbr/skills/**/SKILL.md
            plugins/pbr/references/*.md
            plugins/pbr/commands/*.md
