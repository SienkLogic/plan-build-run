---
phase: "03-ui-shell"
plan: "03-02"
type: "feature"
wave: 2
depends_on: ["03-01"]
files_modified:
  - "src/views/index.ejs"
  - "src/views/error.ejs"
  - "src/views/coming-soon.ejs"
  - "src/routes/pages.routes.js"
  - "src/app.js"
  - "src/middleware/errorHandler.js"
  - "src/routes/index.routes.js"
autonomous: true
discovery: 0
must_haves:
  truths:
    - "GET / returns HTTP 200 with sidebar, header, and dashboard content rendered in the grid layout"
    - "index.ejs uses the content variable (not message) from getHomepage() service"
    - "GET /phases, GET /todos, GET /roadmap all return HTTP 200 with Coming Soon message"
    - "All pages share the layout-top/layout-bottom wrapper and display the sidebar"
    - "Error pages also render within the layout with sidebar navigation"
    - "Each route passes the correct activePage value so the sidebar highlights the current page"
  artifacts:
    - "src/views/index.ejs restructured to use layout-top/layout-bottom partials"
    - "src/views/error.ejs restructured to use layout-top/layout-bottom partials"
    - "src/views/coming-soon.ejs for placeholder pages"
    - "src/routes/pages.routes.js with GET /phases, /todos, /roadmap routes"
    - "src/app.js updated to register pagesRouter"
    - "src/middleware/errorHandler.js updated to pass activePage to error template"
    - "src/routes/index.routes.js updated to pass activePage to index template"
  key_links:
    - "index.routes.js passes activePage:'dashboard' to the index template"
    - "pages.routes.js passes correct activePage for each placeholder route"
    - "app.js imports and registers pagesRouter after indexRouter"
    - "errorHandler.js passes activePage:'' so no sidebar link is highlighted on errors"
    - "index.ejs renders <%- content %> (unescaped HTML from marked) instead of <%= message %>"
consumes:
  - "layout-top.ejs and layout-bottom.ejs partials (from plan 03-01)"
  - "sidebar.ejs with activePage support (from plan 03-01)"
  - "layout.css and status-colors.css (from plan 03-01)"
  - "getHomepage() returning {title, projectDir, content} (from Phase 02)"
  - "createApp() with Express routes and error handler (from Phase 01)"
---

# Plan 03-02: Page Template Restructuring and Placeholder Routes

## Overview

Restructure all existing page templates (index.ejs, error.ejs) from the Phase 01
"complete HTML document" pattern to the new "layout-top/layout-bottom" pattern
created in Plan 03-01. Create a coming-soon.ejs template for placeholder pages.
Add routes for /phases, /todos, and /roadmap that render coming-soon pages.
Fix the template variable mismatch where index.ejs uses `message` but the
service now returns `content`.

After this plan, all pages render within the grid layout with sidebar navigation,
and navigating to any sidebar link works (either showing real content or "Coming Soon").

## Tasks

<task id="03-02-T1" type="auto">
  <name>Restructure page templates to use layout-top/layout-bottom partials</name>
  <files>
    src/views/index.ejs
    src/views/error.ejs
    src/views/coming-soon.ejs
  </files>
  <action>
    All file paths are relative to `D:\Repos\towline-test-project`.

    1. Replace the entire contents of `src/views/index.ejs` with:
       ```html
       <%- include('partials/layout-top', { title: title, activePage: 'dashboard' }) %>

       <h1><%= title %></h1>
       <%- content %>

       <section>
         <h2>Project Configuration</h2>
         <table>
           <tbody>
             <tr>
               <td><strong>Project Directory</strong></td>
               <td><code><%= projectDir %></code></td>
             </tr>
             <tr>
               <td><strong>Status</strong></td>
               <td>Server running</td>
             </tr>
           </tbody>
         </table>
       </section>

       <%- include('partials/layout-bottom') %>
       ```

       Key changes from Phase 01 version:
       - Removed the full HTML document wrapper (DOCTYPE, html, body tags)
       - Replaced with layout-top and layout-bottom includes
       - Changed `<%= message %>` to `<%- content %>` (unescaped, since content is HTML from marked)
       - activePage is hardcoded to 'dashboard' (this is the dashboard page)
       - Removed `<main class="container">` wrapper (layout-top opens `<main>`, layout-bottom closes it)

    2. Replace the entire contents of `src/views/error.ejs` with:
       ```html
       <%- include('partials/layout-top', { title: 'Error', activePage: '' }) %>

       <h1>Error <%= status %></h1>
       <p><%= message %></p>
       <p><a href="/">Return to Dashboard</a></p>

       <%- include('partials/layout-bottom') %>
       ```

       Key changes:
       - Removed full HTML document wrapper
       - Replaced with layout-top/layout-bottom includes
       - activePage is empty string so no sidebar link is highlighted on error pages

    3. Create `src/views/coming-soon.ejs` for placeholder pages:
       ```html
       <%- include('partials/layout-top', { title: title, activePage: activePage }) %>

       <h1><%= featureName %></h1>
       <p>This feature is coming soon.</p>
       <p>
         The <strong><%= featureName %></strong> view is planned but not yet implemented.
         Check back in a future phase.
       </p>
       <p><a href="/">Back to Dashboard</a></p>

       <%- include('partials/layout-bottom') %>
       ```

       Key points:
       - Receives `featureName`, `title`, and `activePage` from the route handler
       - Uses the same layout-top/layout-bottom wrapper as all other pages
       - Provides a link back to the dashboard
       - Returns with HTTP 200 (not 501) since the route exists
  </action>
  <verify>
    node -e "const fs = require('fs'); const idx = fs.readFileSync('D:/Repos/towline-test-project/src/views/index.ejs','utf8'); if (idx.includes('<!DOCTYPE')) throw new Error('index.ejs still has DOCTYPE -- not restructured'); if (!idx.includes('layout-top')) throw new Error('index.ejs missing layout-top'); if (!idx.includes('layout-bottom')) throw new Error('index.ejs missing layout-bottom'); if (idx.includes('<%= message %>')) throw new Error('index.ejs still uses message variable'); if (!idx.includes('<%- content %>')) throw new Error('index.ejs missing content variable'); const err = fs.readFileSync('D:/Repos/towline-test-project/src/views/error.ejs','utf8'); if (err.includes('<!DOCTYPE')) throw new Error('error.ejs still has DOCTYPE'); if (!err.includes('layout-top')) throw new Error('error.ejs missing layout-top'); const cs = fs.readFileSync('D:/Repos/towline-test-project/src/views/coming-soon.ejs','utf8'); if (!cs.includes('layout-top')) throw new Error('coming-soon.ejs missing layout-top'); if (!cs.includes('featureName')) throw new Error('coming-soon.ejs missing featureName'); console.log('PASS: all 3 templates restructured correctly');"
  </verify>
  <done>All page templates use layout-top/layout-bottom partials instead of full HTML documents; index.ejs uses content variable instead of message; coming-soon.ejs exists for placeholder pages</done>
</task>

<task id="03-02-T2" type="auto">
  <name>Add placeholder routes and wire up the page router</name>
  <files>
    src/routes/pages.routes.js
    src/routes/index.routes.js
    src/app.js
    src/middleware/errorHandler.js
  </files>
  <action>
    All file paths are relative to `D:\Repos\towline-test-project`.

    1. Create `src/routes/pages.routes.js` -- routes for placeholder pages:
       ```javascript
       import { Router } from 'express';

       const router = Router();

       router.get('/phases', (req, res) => {
         res.render('coming-soon', {
           title: 'Phases',
           activePage: 'phases',
           featureName: 'Phases'
         });
       });

       router.get('/todos', (req, res) => {
         res.render('coming-soon', {
           title: 'Todos',
           activePage: 'todos',
           featureName: 'Todos'
         });
       });

       router.get('/roadmap', (req, res) => {
         res.render('coming-soon', {
           title: 'Roadmap',
           activePage: 'roadmap',
           featureName: 'Roadmap'
         });
       });

       export default router;
       ```

       Key points:
       - Each route passes the correct activePage for sidebar highlighting
       - All routes return HTTP 200 (Express default)
       - featureName is displayed in the coming-soon template
       - These routes will be replaced with real implementations in later phases
         (Phase 04 for dashboard, Phase 05/06 for phases/roadmap, Phase 08 for todos)

    2. Update `src/routes/index.routes.js` to pass activePage to the index template.
       Change the render call to include activePage:
       ```javascript
       import { Router } from 'express';
       import { getHomepage } from '../services/project.service.js';

       const router = Router();

       router.get('/', async (req, res) => {
         const data = await getHomepage(req.app.locals.projectDir);
         res.render('index', { ...data, activePage: 'dashboard' });
       });

       export default router;
       ```

       Key change: Added `activePage: 'dashboard'` to the render data by spreading
       the service response and adding the activePage property. This is a route-layer
       concern (which page is active) not a service-layer concern.

    3. Update `src/app.js` to import and register the pages router.
       Add the import after the existing indexRouter import:
       ```javascript
       import pagesRouter from './routes/pages.routes.js';
       ```

       And register it after the indexRouter in the routes section:
       ```javascript
       // Routes
       app.use('/', indexRouter);
       app.use('/', pagesRouter);
       ```

       Key points:
       - pagesRouter is registered on '/' (not '/pages') because routes like /phases
         are top-level paths
       - Order matters: indexRouter first (handles /), pagesRouter second
       - Error handler MUST remain registered LAST (after both routers)

    4. Update `src/middleware/errorHandler.js` to pass activePage to the error template.
       Replace the render call to include activePage:
       ```javascript
       /**
        * Express error-handling middleware.
        * MUST have exactly 4 parameters for Express to recognize it as an error handler.
        */

       // eslint-disable-next-line no-unused-vars
       export default function errorHandler(err, req, res, next) {
         console.error('Unhandled error:', err.message);
         if (err.stack) {
           console.error(err.stack);
         }

         const status = err.status || err.statusCode || 500;

         res.status(status).render('error', {
           title: 'Error',
           status,
           message: err.message || 'Internal Server Error',
           activePage: ''
         });
       }
       ```

       Key change: Added `activePage: ''` so the sidebar renders with no link highlighted.
  </action>
  <verify>
    node -e "import('./D:/Repos/towline-test-project/src/app.js').then(async m => { const app = m.createApp({projectDir: 'D:/Repos/towline-test-project'}); const server = app.listen(0, '127.0.0.1', async () => { const port = server.address().port; try { const pages = ['/', '/phases', '/todos', '/roadmap']; for (const p of pages) { const res = await fetch('http://127.0.0.1:' + port + p); if (res.status !== 200) throw new Error(p + ' returned ' + res.status); const body = await res.text(); if (!body.includes('page-wrapper')) throw new Error(p + ' missing page-wrapper grid'); if (!body.includes('sidebar')) throw new Error(p + ' missing sidebar'); if (!body.includes('aria-current')) throw new Error(p + ' missing aria-current'); } const idx = await (await fetch('http://127.0.0.1:' + port + '/')).text(); if (!idx.includes('Dashboard')) throw new Error('/ missing Dashboard content'); const ph = await (await fetch('http://127.0.0.1:' + port + '/phases')).text(); if (!ph.includes('coming soon') && !ph.includes('Coming Soon') && !ph.includes('coming Soon')) throw new Error('/phases missing coming soon'); console.log('PASS: all routes return 200 with layout, sidebar, and correct content'); } finally { server.close(); } }); })"
  </verify>
  <done>All four navigation routes (/, /phases, /todos, /roadmap) return HTTP 200 with the grid layout and sidebar; sidebar correctly highlights the active page; placeholder pages show "Coming Soon" message</done>
</task>

<task id="03-02-T3" type="auto">
  <name>Verify status color CSS renders correctly via a test element</name>
  <files>
    src/views/index.ejs
  </files>
  <action>
    This task adds a small status color demo section to the dashboard page to verify
    that the status color CSS system works end-to-end. This section will be useful
    during development and will be replaced with real status data in Phase 04.

    1. In `src/views/index.ejs`, add a status color demo section after the
       "Project Configuration" table and before the layout-bottom include:
       ```html

       <section>
         <h2>Status Legend</h2>
         <p>
           <span class="status-badge" data-status="complete">Complete</span>
           <span class="status-badge" data-status="in-progress">In Progress</span>
           <span class="status-badge" data-status="blocked">Blocked</span>
           <span class="status-badge" data-status="not-started">Not Started</span>
         </p>
       </section>
       ```

       Key points:
       - Each badge uses data-status attribute + status-badge class
       - Text label is always present alongside the color (accessibility requirement)
       - This section serves as a visual reference for the status color system
       - It will be replaced by real phase status data in Phase 04
  </action>
  <verify>
    node -e "import('./D:/Repos/towline-test-project/src/app.js').then(async m => { const app = m.createApp({projectDir: 'D:/Repos/towline-test-project'}); const server = app.listen(0, '127.0.0.1', async () => { const port = server.address().port; try { const res = await fetch('http://127.0.0.1:' + port + '/'); const body = await res.text(); if (!body.includes('status-badge')) throw new Error('missing status-badge class'); if (!body.includes('data-status=\"complete\"')) throw new Error('missing complete status'); if (!body.includes('data-status=\"in-progress\"')) throw new Error('missing in-progress status'); if (!body.includes('data-status=\"blocked\"')) throw new Error('missing blocked status'); if (!body.includes('data-status=\"not-started\"')) throw new Error('missing not-started status'); if (!body.includes('status-colors.css')) throw new Error('missing status-colors.css link'); if (!body.includes('layout.css')) throw new Error('missing layout.css link'); console.log('PASS: status badges render with data-status attributes and CSS is linked'); } finally { server.close(); } }); })"
  </verify>
  <done>Status color badges render on the dashboard with all four statuses (complete, in-progress, blocked, not-started), each paired with a text label; status-colors.css and layout.css are loaded via the head partial</done>
</task>
