---
phase: "05-phase-detail-view"
plan: "05-02"
type: "feature"
wave: 2
depends_on: ["05-01"]
files_modified:
  - "src/views/phase-detail.ejs"
  - "src/routes/pages.routes.js"
  - "src/views/index.ejs"
  - "public/css/status-colors.css"
autonomous: true
discovery: 0
must_haves:
  truths:
    - "GET /phases/:phaseId renders phase-detail.ejs with plan cards and verification status"
    - "Invalid phaseId format (non-two-digit) returns 404"
    - "Phase with no plans shows an appropriate empty state message"
    - "Verification status badge maps passed->complete, failed->blocked, partial->in-progress for CSS styling"
    - "Dashboard phase table rows link to /phases/:phaseId"
    - "Plan cards show status, subsystem, key decisions, key files, and metrics from SUMMARY.md frontmatter"
  artifacts:
    - "src/views/phase-detail.ejs"
  key_links:
    - "pages.routes.js imports getPhaseDetail from phase.service.js"
    - "pages.routes.js GET /phases/:phaseId calls getPhaseDetail and renders phase-detail.ejs"
    - "index.ejs phase name column wraps text in anchor tag linking to /phases/:phaseId"
    - "status-colors.css adds passed status mapping for verification badges"
---

# Plan 05-02: Phase Detail Template and Route Wiring

## Overview

Create the `phase-detail.ejs` template with plan cards showing SUMMARY.md data and verification status. Wire the route in `pages.routes.js` to call `getPhaseDetail` and render the template. Update the dashboard `index.ejs` to link phase names to the detail view. Add "passed" and "partial" status mappings to `status-colors.css`.

## Tasks

<task id="05-02-T1" type="auto" tdd="false">
  <name>Create phase-detail.ejs template and add verification status mappings to CSS</name>
  <files>
    src/views/phase-detail.ejs
    public/css/status-colors.css
  </files>
  <action>
1. Create file `src/views/phase-detail.ejs` with the following structure:

```ejs
<%- include('partials/layout-top', { title: title, activePage: 'phases' }) %>

<h1>Phase <%= phaseId %>: <%= phaseName %></h1>

<p><a href="/">&larr; Back to Dashboard</a></p>

<% if (verification) { %>
<!-- Verification Summary Card -->
<article>
  <header>
    <strong>Verification Status</strong>
  </header>
  <%
    // Map verification status to CSS status-badge data-status values
    var verificationCssStatus = 'not-started';
    if (verification.status === 'passed') verificationCssStatus = 'complete';
    else if (verification.status === 'failed') verificationCssStatus = 'blocked';
    else if (verification.status === 'partial') verificationCssStatus = 'in-progress';
  %>
  <p>
    <span class="status-badge" data-status="<%= verificationCssStatus %>">
      <%= verification.status.toUpperCase() %>
    </span>
    <% if (verification.verified) { %>
      &nbsp; Verified: <%= new Date(verification.verified).toLocaleString() %>
    <% } %>
  </p>
  <% if (verification.score) { %>
    <p>
      Score: <%= verification.score.verified %>/<%= verification.score.total_must_haves %> must-haves verified
    </p>
    <% if (verification.score.failed > 0) { %>
      <p><strong><%= verification.score.failed %> must-haves FAILED</strong></p>
    <% } %>
  <% } %>
  <% if (verification.gaps && verification.gaps.length > 0) { %>
    <details>
      <summary>Verification Gaps (<%= verification.gaps.length %>)</summary>
      <ul>
        <% verification.gaps.forEach(function(gap) { %>
          <li><%= gap %></li>
        <% }); %>
      </ul>
    </details>
  <% } %>
</article>
<% } %>

<% if (plans.length === 0) { %>
<!-- Empty State -->
<article>
  <p>No plans found for this phase. This phase may not have been planned yet.</p>
</article>
<% } else { %>

<h2>Plans (<%= plans.length %>)</h2>

<!-- Plan Cards -->
<% plans.forEach(function(plan) { %>
<article>
  <header>
    <strong>Plan <%= plan.planId %></strong>
    <% if (plan.summary && plan.summary.status) { %>
      &nbsp;
      <span class="status-badge" data-status="<%= plan.summary.status %>">
        <%= plan.summary.status.replace('-', ' ') %>
      </span>
    <% } %>
  </header>

  <% if (plan.summary) { %>

    <% if (plan.summary.subsystem) { %>
      <p><strong>Subsystem:</strong> <%= plan.summary.subsystem %></p>
    <% } %>

    <% if (plan.summary.key_decisions && plan.summary.key_decisions.length > 0) { %>
      <details>
        <summary>Key Decisions (<%= plan.summary.key_decisions.length %>)</summary>
        <ul>
          <% plan.summary.key_decisions.forEach(function(decision) { %>
            <li><%= decision %></li>
          <% }); %>
        </ul>
      </details>
    <% } %>

    <% if (plan.summary.key_files && plan.summary.key_files.length > 0) { %>
      <details>
        <summary>Key Files (<%= plan.summary.key_files.length %>)</summary>
        <ul>
          <% plan.summary.key_files.forEach(function(file) { %>
            <li><code><%= file %></code></li>
          <% }); %>
        </ul>
      </details>
    <% } %>

    <% if (plan.summary.deferred && plan.summary.deferred.length > 0) { %>
      <details>
        <summary>Deferred Items (<%= plan.summary.deferred.length %>)</summary>
        <ul>
          <% plan.summary.deferred.forEach(function(item) { %>
            <li><%= item %></li>
          <% }); %>
        </ul>
      </details>
    <% } %>

    <% if (plan.summary.metrics) { %>
      <p>
        <small>
          <% if (plan.summary.metrics.duration_minutes != null) { %>
            Duration: <%= plan.summary.metrics.duration_minutes %> min
          <% } %>
          <% if (plan.summary.metrics.commits != null) { %>
            | Commits: <%= plan.summary.metrics.commits %>
          <% } %>
          <% if (plan.summary.metrics.files_created != null || plan.summary.metrics.files_modified != null) { %>
            | Files: <%= plan.summary.metrics.files_created || 0 %> created, <%= plan.summary.metrics.files_modified || 0 %> modified
          <% } %>
        </small>
      </p>
    <% } %>

  <% } else { %>
    <!-- Plan exists but not executed yet -->
    <p><em>Plan file exists but has not been executed yet. No summary available.</em></p>
  <% } %>
</article>
<% }); %>

<% } %>

<%- include('partials/layout-bottom') %>
```

2. Update `public/css/status-colors.css` to add "passed" and "partial" status mappings.

   After the existing `[data-status="not-started"]` text color rule (around line 24-26), add:
   ```css
   [data-status="passed"] {
     color: var(--status-complete);
   }

   [data-status="partial"] {
     color: var(--status-in-progress);
   }
   ```

   After the existing `.status-badge[data-status="not-started"]` rule (around line 54-58), add:
   ```css
   .status-badge[data-status="passed"] {
     background-color: #dcfce7;
     color: #14532d;
   }

   .status-badge[data-status="partial"] {
     background-color: #fef9c3;
     color: #713f12;
   }
   ```

   NOTE: These CSS additions are defensive -- the template ALSO maps verification statuses to existing CSS values via JavaScript in the EJS. Both approaches coexist so that if any code uses the raw verification status as a data-status attribute, it will render correctly.
  </action>
  <verify>
node -e "const fs = require('fs'); const ejs = fs.readFileSync('D:/Repos/towline-test-project/src/views/phase-detail.ejs','utf-8'); const css = fs.readFileSync('D:/Repos/towline-test-project/public/css/status-colors.css','utf-8'); if (!ejs.includes('phases.forEach') && !ejs.includes('plans.forEach')) throw new Error('template missing plan loop'); if (!ejs.includes('verification')) throw new Error('template missing verification'); if (!css.includes('data-status=\"passed\"')) throw new Error('CSS missing passed status'); console.log('PASS: template has plan cards + verification, CSS has passed status');"
  </verify>
  <done>
phase-detail.ejs template exists and renders plan cards with status badges, key decisions/files in collapsible details elements, metrics, verification summary card with status-to-CSS mapping, and an empty state for phases with no plans. status-colors.css includes "passed" and "partial" badge styling.
  </done>
</task>

<task id="05-02-T2" type="auto" tdd="false">
  <name>Wire GET /phases/:phaseId route and add dashboard phase links</name>
  <files>
    src/routes/pages.routes.js
    src/views/index.ejs
  </files>
  <action>
1. Update `src/routes/pages.routes.js`:

   a. Add import at top of file:
   ```javascript
   import { getPhaseDetail } from '../services/phase.service.js';
   ```

   b. Replace the existing `router.get('/phases', ...)` route (lines 5-11) with TWO routes:

   First, the phase list route (keep the existing one but it will serve as a redirect or overview later; for now keep it as-is since it still shows "coming soon" for the full phases list page -- Phase 05 only adds the detail route):

   Keep the existing `/phases` route UNCHANGED.

   c. Add the new detail route AFTER the existing `/phases` route and BEFORE the `/todos` route:
   ```javascript
   router.get('/phases/:phaseId', async (req, res) => {
     const { phaseId } = req.params;

     // Validate phaseId is exactly two digits
     if (!/^\d{2}$/.test(phaseId)) {
       const err = new Error('Phase ID must be a two-digit number (e.g., 01, 05, 12)');
       err.status = 404;
       throw err;
     }

     const projectDir = req.app.locals.projectDir;
     const phaseData = await getPhaseDetail(projectDir, phaseId);

     res.render('phase-detail', {
       title: `Phase ${phaseId}: ${phaseData.phaseName}`,
       activePage: 'phases',
       ...phaseData
     });
   });
   ```

   NOTE on error handling: Express 5.x auto-catches async rejections and passes them to the error handler middleware. The `throw err` pattern works without an async wrapper. If phaseId is invalid format, we throw a 404 error. If getPhaseDetail throws an unexpected error, Express 5.x catches it and routes to the error handler.

2. Update `src/views/index.ejs`:

   In the phase table tbody (around line 52-53), change the phase name cell from:
   ```ejs
   <td><%= phase.name %></td>
   ```
   to:
   ```ejs
   <td><a href="/phases/<%= String(phase.id).padStart(2, '0') %>"><%= phase.name %></a></td>
   ```

   This wraps each phase name in a link to its detail page. `String(phase.id).padStart(2, '0')` ensures single-digit IDs like 1 become "01" (matching the two-digit route parameter format). Pico.css automatically styles anchor tags in tables with standard link styling.
  </action>
  <verify>
node -e "const fs = require('fs'); const r = fs.readFileSync('D:/Repos/towline-test-project/src/routes/pages.routes.js','utf-8'); const idx = fs.readFileSync('D:/Repos/towline-test-project/src/views/index.ejs','utf-8'); if (!r.includes('getPhaseDetail')) throw new Error('route missing getPhaseDetail import'); if (!r.includes('phaseId')) throw new Error('route missing phaseId param'); if (!idx.includes('/phases/')) throw new Error('dashboard missing phase links'); console.log('PASS: route imports service and has phaseId param, dashboard has phase links');"
  </verify>
  <done>
GET /phases/:phaseId route validates the phaseId format, calls getPhaseDetail, and renders phase-detail.ejs. Invalid phaseId formats return 404. Dashboard phase table names are clickable links to /phases/:phaseId.
  </done>
</task>
