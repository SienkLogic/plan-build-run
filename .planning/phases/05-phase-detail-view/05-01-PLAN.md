---
phase: "05-phase-detail-view"
plan: "05-01"
type: "feature"
wave: 1
depends_on: []
files_modified:
  - "src/services/phase.service.js"
  - "tests/services/phase.service.test.js"
autonomous: true
discovery: 0
must_haves:
  truths:
    - "getPhaseDetail returns all plans in a phase directory with SUMMARY.md frontmatter and rendered HTML"
    - "getPhaseDetail returns VERIFICATION.md frontmatter when present"
    - "getPhaseDetail returns empty plans array and null verification when phase directory does not exist"
    - "getPhaseDetail returns null summary for plans that have no corresponding SUMMARY.md"
    - "getPhaseDetail gracefully handles missing .planning/phases/ directory"
    - "Phase name is derived from directory name (strip numeric prefix, title-case words)"
  artifacts:
    - "src/services/phase.service.js"
    - "tests/services/phase.service.test.js"
  key_links:
    - "phase.service.js imports readMarkdownFile from planning.repository.js"
---

# Plan 05-01: Phase Detail Service Layer

## Overview

Create `phase.service.js` with `getPhaseDetail(projectDir, phaseId)` that reads a phase directory, discovers PLAN.md files, reads corresponding SUMMARY.md files using `readMarkdownFile` from the repository layer, and reads VERIFICATION.md if present. Unit tests use memfs mocking following the established dashboard.service.test.js pattern.

## Tasks

<task id="05-01-T1" type="auto" tdd="false">
  <name>Create phase.service.js with getPhaseDetail function</name>
  <files>
    src/services/phase.service.js
  </files>
  <action>
1. Create file `src/services/phase.service.js`
2. Import `readdir` from `node:fs/promises` and `join` from `node:path`
3. Import `readMarkdownFile` from `../repositories/planning.repository.js`
4. Create helper function `formatPhaseName(dirName)`:
   - Takes a directory name like "04-dashboard-landing-page"
   - Splits on '-', removes the first element (numeric prefix)
   - Title-cases each remaining word (first letter uppercase, rest lowercase)
   - Joins with spaces: "Dashboard Landing Page"
   - Returns the formatted name
5. Export async function `getPhaseDetail(projectDir, phaseId)`:
   - `phaseId` is a two-digit string like "04"
   - Build phasesDir path: `join(projectDir, '.planning', 'phases')`
   - Wrap entire body in try/catch -- if phasesDir readdir throws ENOENT, return empty state
   - Read directory entries with `readdir(phasesDir, { withFileTypes: true })`
   - Filter for directories whose name starts with `${phaseId}-`
   - Take the first match (there should be exactly one). If none, return empty state:
     ```javascript
     { phaseId, phaseName: 'Unknown', phaseDir: null, plans: [], verification: null }
     ```
   - Derive `phaseName` using `formatPhaseName(phaseDir.name)`
   - Build `phaseFullPath = join(phasesDir, phaseDir.name)`
   - Read files in phase directory with `readdir(phaseFullPath)`
   - Filter for PLAN.md files matching regex `/^\d{2}-\d{2}-PLAN\.md$/` and sort lexicographically
   - For each plan file, extract the plan number: match `/^(\d{2}-\d{2})-PLAN\.md$/` to get planId (e.g., "04-01")
   - Build array of SUMMARY.md paths: for each planId, the summary is `join(phaseFullPath, 'SUMMARY-' + planId + '.md')`
   - Use `Promise.allSettled` to read all summary files in parallel via `readMarkdownFile(summaryPath)`
   - Map results to plan objects:
     - If status is 'fulfilled': `{ planId, planFile, summary: value.frontmatter, content: value.html }`
     - If status is 'rejected' and reason.code === 'ENOENT': `{ planId, planFile, summary: null, content: null }`
     - If status is 'rejected' with other error: re-throw (unexpected error)
   - Read VERIFICATION.md: `join(phaseFullPath, 'VERIFICATION.md')`
     - Wrap in try/catch, catch ENOENT -> verification = null
     - On success: `verification = verDoc.frontmatter`
   - Return:
     ```javascript
     {
       phaseId,
       phaseName,
       phaseDir: phaseDir.name,
       plans,
       verification
     }
     ```
6. The function must use `join()` for ALL path construction (cross-platform requirement)
7. Do NOT use `readFile` directly -- use `readMarkdownFile` from the repository for SUMMARY.md and VERIFICATION.md (consistent with the three-layer architecture pattern)
  </action>
  <verify>
node -e "import('./src/services/phase.service.js').then(m => { if (typeof m.getPhaseDetail !== 'function') throw new Error('getPhaseDetail not exported as function'); console.log('PASS: getPhaseDetail exported as function'); })"
  </verify>
  <done>
phase.service.js exports getPhaseDetail and can be imported without errors. Function returns the expected data structure for phase directories containing plan files, summary files, and verification files.
  </done>
</task>

<task id="05-01-T2" type="auto" tdd="false">
  <name>Create unit tests for phase.service.js</name>
  <files>
    tests/services/phase.service.test.js
  </files>
  <action>
1. Create file `tests/services/phase.service.test.js`
2. Follow the exact memfs mocking pattern from `tests/services/dashboard.service.test.js`:
   ```javascript
   import { describe, it, expect, beforeEach, vi } from 'vitest';
   import { vol } from 'memfs';

   // Mock BOTH node:fs/promises (used by phase.service.js for readdir)
   // AND by planning.repository.js (used by readMarkdownFile for readFile)
   vi.mock('node:fs/promises', async () => {
     const memfs = await import('memfs');
     return memfs.fs.promises;
   });

   const { getPhaseDetail } = await import('../../src/services/phase.service.js');
   ```
3. Create test fixtures as constants at module level:

   VALID_SUMMARY_FM: A string with YAML frontmatter that gray-matter can parse:
   ```
   ---
   phase: "04-dashboard-landing-page"
   plan: "04-01"
   status: "complete"
   subsystem: "services"
   tags: ["parsing", "dashboard"]
   key_files: ["src/services/dashboard.service.js"]
   key_decisions: ["Separate dashboard.service.js"]
   metrics:
     duration_minutes: 2
     commits: 3
     files_created: 2
     files_modified: 1
   ---

   # Plan Summary: 04-01

   Dashboard service implementation.
   ```

   VALID_VERIFICATION_FM: A string with YAML frontmatter for VERIFICATION.md:
   ```
   ---
   phase: "04-dashboard-landing-page"
   verified: "2026-02-08T12:23:00Z"
   status: "passed"
   score:
     total_must_haves: 18
     verified: 18
     failed: 0
     partial: 0
     human_needed: 0
   gaps: []
   ---

   # Verification Report
   All must-haves verified.
   ```

4. Write the following test cases inside `describe('PhaseService', () => { ... })`:

   **Test 1**: "should return all plans with summaries for a valid phase"
   - Set up memfs vol with:
     - `/project/.planning/phases/04-dashboard-landing-page/04-01-PLAN.md` (any content)
     - `/project/.planning/phases/04-dashboard-landing-page/04-02-PLAN.md` (any content)
     - `/project/.planning/phases/04-dashboard-landing-page/SUMMARY-04-01.md` (VALID_SUMMARY_FM)
     - `/project/.planning/phases/04-dashboard-landing-page/SUMMARY-04-02.md` (similar content with plan: "04-02")
     - `/project/.planning/phases/04-dashboard-landing-page/VERIFICATION.md` (VALID_VERIFICATION_FM)
   - Call `getPhaseDetail('/project', '04')`
   - Assert: phaseId === '04', phaseName === 'Dashboard Landing Page'
   - Assert: plans.length === 2
   - Assert: plans[0].planId === '04-01', plans[0].summary.status === 'complete'
   - Assert: plans[0].content contains 'Plan Summary'
   - Assert: plans[1].planId === '04-02'
   - Assert: verification.status === 'passed'
   - Assert: verification.score.total_must_haves === 18

   **Test 2**: "should return empty state when phase directory does not exist"
   - Set up memfs vol with:
     - `/project/.planning/phases/01-setup/01-01-PLAN.md` (any content)
   - Call `getPhaseDetail('/project', '99')`
   - Assert: phaseId === '99', phaseName === 'Unknown'
   - Assert: phaseDir === null, plans === [], verification === null

   **Test 3**: "should return empty plans for phase directory with no PLAN.md files"
   - Set up memfs vol with:
     - `/project/.planning/phases/04-dashboard-landing-page/RESEARCH.md` (any content)
   - Call `getPhaseDetail('/project', '04')`
   - Assert: phaseId === '04', phaseName === 'Dashboard Landing Page'
   - Assert: plans.length === 0, verification === null

   **Test 4**: "should return null summary when SUMMARY.md is missing for a plan"
   - Set up memfs vol with:
     - `/project/.planning/phases/04-dashboard-landing-page/04-01-PLAN.md` (any content)
     - (no SUMMARY-04-01.md)
   - Call `getPhaseDetail('/project', '04')`
   - Assert: plans.length === 1
   - Assert: plans[0].planId === '04-01', plans[0].summary === null, plans[0].content === null

   **Test 5**: "should return null verification when VERIFICATION.md is missing"
   - Set up memfs vol with:
     - `/project/.planning/phases/04-dashboard-landing-page/04-01-PLAN.md` (any content)
     - `/project/.planning/phases/04-dashboard-landing-page/SUMMARY-04-01.md` (VALID_SUMMARY_FM)
     - (no VERIFICATION.md)
   - Call `getPhaseDetail('/project', '04')`
   - Assert: plans.length === 1, plans[0].summary !== null
   - Assert: verification === null

   **Test 6**: "should handle missing .planning/phases/ directory gracefully"
   - Set up memfs vol with:
     - `/project/package.json` (any JSON)
   - Call `getPhaseDetail('/project', '04')`
   - Assert: does NOT throw
   - Assert: plans === [], verification === null

   **Test 7**: "should handle mixed results (one summary exists, one missing)"
   - Set up memfs vol with:
     - `/project/.planning/phases/04-dashboard-landing-page/04-01-PLAN.md`
     - `/project/.planning/phases/04-dashboard-landing-page/04-02-PLAN.md`
     - `/project/.planning/phases/04-dashboard-landing-page/SUMMARY-04-01.md` (VALID_SUMMARY_FM)
     - (no SUMMARY-04-02.md)
   - Call `getPhaseDetail('/project', '04')`
   - Assert: plans.length === 2
   - Assert: plans[0].summary !== null (has summary)
   - Assert: plans[1].summary === null (missing summary)

   **Test 8**: "should sort plans in lexicographic order"
   - Set up memfs vol with plans 04-03, 04-01, 04-02 (create in non-sorted order)
   - Call `getPhaseDetail('/project', '04')`
   - Assert: plans[0].planId === '04-01', plans[1].planId === '04-02', plans[2].planId === '04-03'

   **Test 9**: "should ignore non-PLAN files in directory"
   - Set up memfs vol with:
     - `/project/.planning/phases/04-dashboard-landing-page/04-01-PLAN.md`
     - `/project/.planning/phases/04-dashboard-landing-page/RESEARCH.md`
     - `/project/.planning/phases/04-dashboard-landing-page/NOTES.md`
   - Call `getPhaseDetail('/project', '04')`
   - Assert: plans.length === 1 (only 04-01-PLAN.md counted)

5. Each test must call `vol.reset()` in `beforeEach`
6. Run tests: `npx vitest run tests/services/phase.service.test.js`
  </action>
  <verify>
npx vitest run tests/services/phase.service.test.js
  </verify>
  <done>
All 9 unit tests pass, covering: valid phase with plans and verification, missing phase, empty phase, missing summary, missing verification, missing phases directory, mixed results, sort order, and non-PLAN file filtering.
  </done>
</task>
