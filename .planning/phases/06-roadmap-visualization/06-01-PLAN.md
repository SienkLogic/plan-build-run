---
phase: "06-roadmap-visualization"
plan: "06-01"
type: "feature"
wave: 1
depends_on: []
files_modified:
  - "src/services/roadmap.service.js"
  - "tests/services/roadmap.service.test.js"
  - "src/views/roadmap.ejs"
  - "src/routes/pages.routes.js"
autonomous: true
discovery: 0
must_haves:
  truths:
    - "GET /roadmap renders a table of all project phases with name, plan count, status badge, and dependencies"
    - "Each phase row displays a color-coded status badge using the existing status-colors.css system"
    - "Phase names in the roadmap table link to /phases/:phaseId"
    - "Dependencies column shows phase numbers parsed from ROADMAP.md Phase Details sections"
    - "Plan count per phase is derived from counting NN-NN-PLAN.md files in each phase directory"
    - "Missing phase directories result in plan count of 0 without throwing errors"
    - "Missing ROADMAP.md renders a graceful empty state message"
  artifacts:
    - "src/services/roadmap.service.js"
    - "tests/services/roadmap.service.test.js"
    - "src/views/roadmap.ejs"
  key_links:
    - "roadmap.service.js imports parseRoadmapFile from dashboard.service.js for base phase data"
    - "roadmap.service.js reads raw ROADMAP.md for dependency extraction via readFile"
    - "roadmap.service.js reads phase directories via readdir to count PLAN.md files"
    - "pages.routes.js imports getRoadmapData from roadmap.service.js"
    - "pages.routes.js replaces coming-soon /roadmap route with real roadmap rendering"
---

# Plan 06-01: Roadmap Visualization Service, Template, and Route

## Overview

Create the roadmap visualization feature end-to-end: a `roadmap.service.js` that
enhances the base phase data from `parseRoadmapFile` with plan counts (from phase
directories) and dependency information (parsed from ROADMAP.md Phase Details sections),
unit tests with memfs mocking, an EJS template with an enhanced table layout using
Pico.css and existing status badges, and route wiring in `pages.routes.js` to replace
the current coming-soon placeholder.

The service reads ROADMAP.md twice: once via `parseRoadmapFile` for the proven
checkbox-to-phase parsing, and once via raw `readFile` for dependency extraction from
the Phase Details section. This avoids duplicating parsing logic while keeping
dependency extraction isolated. Both reads hit OS cache so performance impact is
negligible for a local dev tool.

## Tasks

<task id="06-01-T1" type="auto" tdd="false">
  <name>Create roadmap.service.js with getRoadmapData and unit tests</name>
  <files>
    src/services/roadmap.service.js
    tests/services/roadmap.service.test.js
  </files>
  <action>
1. Create file `src/services/roadmap.service.js`

2. Add imports:
   ```javascript
   import { readFile, readdir } from 'node:fs/promises';
   import { join } from 'node:path';
   import { parseRoadmapFile } from './dashboard.service.js';
   ```

3. Create internal helper `stripBOM(content)`:
   ```javascript
   function stripBOM(content) {
     return content.replace(/^\uFEFF/, '');
   }
   ```
   Duplicated intentionally -- this service reads raw text, not via the repository layer.

4. Create internal async function `countPlansForPhase(projectDir, phaseId)`:
   ```javascript
   async function countPlansForPhase(projectDir, phaseId) {
     const phaseIdPadded = String(phaseId).padStart(2, '0');
     const phasesDir = join(projectDir, '.planning', 'phases');

     try {
       const entries = await readdir(phasesDir, { withFileTypes: true });
       const phaseDir = entries.find(e =>
         e.isDirectory() && e.name.startsWith(`${phaseIdPadded}-`)
       );

       if (!phaseDir) return 0;

       const phaseFiles = await readdir(join(phasesDir, phaseDir.name));
       return phaseFiles.filter(f => /^\d{2}-\d{2}-PLAN\.md$/.test(f)).length;
     } catch (err) {
       if (err.code === 'ENOENT') return 0;
       throw err;
     }
   }
   ```
   Key points:
   - Phase ID is zero-padded to match directory naming convention (e.g., "01-project-scaffolding")
   - Returns 0 if the phases directory doesn't exist or the specific phase directory is not found
   - Only counts files matching the exact `NN-NN-PLAN.md` pattern (same regex as phase.service.js)
   - ENOENT is caught for both the phases directory and the phase subdirectory

5. Create internal function `extractAllDependencies(roadmapContent)`:
   ```javascript
   function extractAllDependencies(roadmapContent) {
     const dependencyMap = new Map();

     // Match Phase Details sections: "### Phase NN: ..." followed by "**Depends on**: ..."
     const sectionRegex = /### Phase (\d+):[\s\S]*?\*\*Depends on\*\*:\s*([^\n]+)/g;
     let match;

     while ((match = sectionRegex.exec(roadmapContent)) !== null) {
       const phaseId = parseInt(match[1], 10);
       const depText = match[2].trim();

       if (depText.toLowerCase().includes('none')) {
         dependencyMap.set(phaseId, []);
         continue;
       }

       // Extract phase numbers from "Phase 01, Phase 02" format
       const deps = [];
       const depMatches = depText.matchAll(/Phase (\d+)/g);
       for (const dm of depMatches) {
         deps.push(parseInt(dm[1], 10));
       }
       dependencyMap.set(phaseId, deps);
     }

     return dependencyMap;
   }
   ```
   Key points:
   - Parses ALL Phase Details sections in one pass, returning a Map of phaseId -> dependencies[]
   - Uses `[\s\S]*?` (non-greedy) between the heading and the "Depends on" line to handle multi-line sections
   - "None" in the dependency text produces an empty array
   - If a phase has no Phase Details section, it will not appear in the map (handled as empty array in getRoadmapData)

6. Export async function `getRoadmapData(projectDir)`:
   ```javascript
   export async function getRoadmapData(projectDir) {
     // 1. Get base phase list from parseRoadmapFile (reuses proven checkbox parsing)
     const { phases: basePhases } = await parseRoadmapFile(projectDir);

     if (basePhases.length === 0) {
       return { phases: [] };
     }

     // 2. Read raw ROADMAP.md for dependency extraction
     let dependencyMap = new Map();
     try {
       const roadmapPath = join(projectDir, '.planning', 'ROADMAP.md');
       const rawContent = stripBOM(await readFile(roadmapPath, 'utf-8'));
       dependencyMap = extractAllDependencies(rawContent);
     } catch (err) {
       // If ROADMAP.md disappeared between the two reads (unlikely), use empty deps
       if (err.code !== 'ENOENT') throw err;
     }

     // 3. Enhance each phase with plan count and dependencies in parallel
     const enhancedPhases = await Promise.all(
       basePhases.map(async (phase) => {
         const planCount = await countPlansForPhase(projectDir, phase.id);
         const dependencies = dependencyMap.get(phase.id) || [];
         return { ...phase, planCount, dependencies };
       })
     );

     return { phases: enhancedPhases };
   }
   ```
   Key points:
   - Calls parseRoadmapFile first for base phase data (id, name, description, status)
   - Early return with empty phases if parseRoadmapFile returns nothing (ROADMAP.md missing)
   - Reads raw ROADMAP.md separately for dependency parsing (two reads, OS cache makes this fast)
   - Plan count reads run in parallel via Promise.all for all phases simultaneously
   - Dependencies default to empty array if a phase has no entry in the dependency map

7. Create file `tests/services/roadmap.service.test.js`

8. Set up imports and mocks following the established pattern:
   ```javascript
   import { describe, it, expect, beforeEach, vi } from 'vitest';
   import { vol } from 'memfs';

   // Mock node:fs/promises with memfs
   vi.mock('node:fs/promises', async () => {
     const memfs = await import('memfs');
     return memfs.fs.promises;
   });

   // Import AFTER mock is set up
   const { getRoadmapData } = await import(
     '../../src/services/roadmap.service.js'
   );
   ```

9. Add `beforeEach(() => { vol.reset(); });`

10. Create test fixture constants:

    ```javascript
    const VALID_ROADMAP_MD = `# Roadmap: Test Project

## Phases

- [x] Phase 01: Project Scaffolding -- Node.js project structure
- [x] Phase 02: Core Parsing -- Markdown repository
- [ ] Phase 03: UI Shell -- EJS layout system
- [ ] Phase 04: Dashboard -- Project overview page
- [ ] Phase 05: Detail View -- Phase detail page

## Phase Details

### Phase 01: Project Scaffolding
**Goal**: Express server starts
**Depends on**: None (starting phase)
**Plans**: 2 plans

### Phase 02: Core Parsing
**Goal**: Repository layer works
**Depends on**: Phase 01
**Plans**: 2 plans

### Phase 03: UI Shell
**Goal**: Layout system renders
**Depends on**: Phase 01
**Plans**: 2 plans

### Phase 04: Dashboard
**Goal**: Landing page displays data
**Depends on**: Phase 02, Phase 03
**Plans**: 2 plans

### Phase 05: Detail View
**Goal**: Phase detail page works
**Depends on**: Phase 04
**Plans**: 2 plans
`;
    ```

11. Write `describe('getRoadmapData')` with these tests:

    a. `it('should return phases with plan counts and dependencies')`:
       - Set up memfs vol with:
         - `/project/.planning/ROADMAP.md` containing VALID_ROADMAP_MD
         - `/project/.planning/phases/01-project-scaffolding/01-01-PLAN.md` (content: `# Plan`)
         - `/project/.planning/phases/01-project-scaffolding/01-02-PLAN.md` (content: `# Plan`)
         - `/project/.planning/phases/02-core-parsing/02-01-PLAN.md` (content: `# Plan`)
         - `/project/.planning/phases/04-dashboard/04-01-PLAN.md` (content: `# Plan`)
         - `/project/.planning/phases/04-dashboard/04-02-PLAN.md` (content: `# Plan`)
       - Call `getRoadmapData('/project')`
       - Assert `result.phases.length` === 5
       - Assert `result.phases[0].id` === 1
       - Assert `result.phases[0].name` === 'Project Scaffolding'
       - Assert `result.phases[0].status` === 'complete'
       - Assert `result.phases[0].planCount` === 2 (two PLAN.md files in 01- directory)
       - Assert `result.phases[0].dependencies` deep equals `[]` (None)
       - Assert `result.phases[1].planCount` === 1 (one PLAN.md file in 02- directory)
       - Assert `result.phases[1].dependencies` deep equals `[1]` (Phase 01)
       - Assert `result.phases[2].planCount` === 0 (no 03- directory exists)
       - Assert `result.phases[2].dependencies` deep equals `[1]` (Phase 01)
       - Assert `result.phases[3].planCount` === 2 (two PLAN.md files in 04- directory)
       - Assert `result.phases[3].dependencies` deep equals `[2, 3]` (Phase 02, Phase 03)
       - Assert `result.phases[4].planCount` === 0 (no 05- directory exists)
       - Assert `result.phases[4].dependencies` deep equals `[4]` (Phase 04)

    b. `it('should return empty phases array when ROADMAP.md does not exist')`:
       - Set up memfs vol with `/project/package.json` only
       - Call `getRoadmapData('/project')`
       - Assert `result.phases` is empty array

    c. `it('should return 0 plan count when phase directory has no PLAN.md files')`:
       - Set up memfs vol with:
         - `/project/.planning/ROADMAP.md` containing a single-phase roadmap:
           `- [x] Phase 01: Setup -- desc\n\n## Phase Details\n\n### Phase 01: Setup\n**Depends on**: None\n`
         - `/project/.planning/phases/01-setup/RESEARCH.md` (content: `# Research`)
       - Call `getRoadmapData('/project')`
       - Assert `result.phases[0].planCount` === 0
       - Assert `result.phases[0].dependencies` deep equals `[]`

    d. `it('should return 0 plan count when .planning/phases directory does not exist')`:
       - Set up memfs vol with:
         - `/project/.planning/ROADMAP.md` containing a single-phase roadmap
         - (no phases directory at all)
       - Call `getRoadmapData('/project')`
       - Assert `result.phases[0].planCount` === 0

    e. `it('should return empty dependencies for phases not in Phase Details section')`:
       - Set up memfs vol with:
         - `/project/.planning/ROADMAP.md` containing phases in the checkbox list but NO Phase Details section
           (just the `## Phases` section with checkboxes, no `## Phase Details`)
       - Call `getRoadmapData('/project')`
       - Assert `result.phases[0].dependencies` deep equals `[]`

    f. `it('should handle UTF-8 BOM in ROADMAP.md')`:
       - Set up memfs vol with BOM-prefixed VALID_ROADMAP_MD
       - Call `getRoadmapData('/project')`
       - Assert phases are parsed correctly (length === 5)

    g. `it('should only count files matching NN-NN-PLAN.md pattern')`:
       - Set up memfs vol with:
         - `/project/.planning/ROADMAP.md` with single-phase roadmap for Phase 01
         - Phase 01 directory with: `01-01-PLAN.md`, `RESEARCH.md`, `SUMMARY-01-01.md`, `NOTES.md`
       - Call `getRoadmapData('/project')`
       - Assert `result.phases[0].planCount` === 1 (only 01-01-PLAN.md)

    h. `it('should handle phase with multiple dependencies')`:
       - Set up memfs vol with VALID_ROADMAP_MD (Phase 04 depends on Phase 02 and Phase 03)
       - Call `getRoadmapData('/project')`
       - Assert `result.phases[3].dependencies` deep equals `[2, 3]`
       - Assert `result.phases[3].dependencies.length` === 2
  </action>
  <verify>
npx vitest run tests/services/roadmap.service.test.js --reporter=verbose --config D:/Repos/towline-test-project/vitest.config.js --dir D:/Repos/towline-test-project
  </verify>
  <done>
roadmap.service.js exports getRoadmapData that returns phases enhanced with planCount and dependencies. All 8 unit tests pass, covering: full phase data with counts and deps, missing ROADMAP.md, empty phase dirs, missing phases dir, missing Phase Details, BOM handling, non-PLAN file filtering, and multi-dependency parsing.
  </done>
</task>

<task id="06-01-T2" type="auto" tdd="false">
  <name>Create roadmap.ejs template and wire GET /roadmap route</name>
  <files>
    src/views/roadmap.ejs
    src/routes/pages.routes.js
  </files>
  <action>
1. Create file `src/views/roadmap.ejs` with the following content:

```ejs
<%- include('partials/layout-top', { title: 'Roadmap', activePage: 'roadmap' }) %>

<h1>Project Roadmap</h1>

<% if (phases.length > 0) { %>
<article>
  <table>
    <thead>
      <tr>
        <th scope="col">Phase</th>
        <th scope="col">Name</th>
        <th scope="col">Description</th>
        <th scope="col">Plans</th>
        <th scope="col">Status</th>
        <th scope="col">Depends On</th>
      </tr>
    </thead>
    <tbody>
      <% phases.forEach(function(phase) { %>
      <tr>
        <td><%= String(phase.id).padStart(2, '0') %></td>
        <td>
          <a href="/phases/<%= String(phase.id).padStart(2, '0') %>">
            <%= phase.name %>
          </a>
        </td>
        <td><%= phase.description %></td>
        <td><%= phase.planCount %></td>
        <td>
          <span class="status-badge" data-status="<%= phase.status %>">
            <%= phase.status.replace('-', ' ') %>
          </span>
        </td>
        <td>
          <% if (phase.dependencies && phase.dependencies.length > 0) { %>
            <% phase.dependencies.forEach(function(dep, idx) { %>
              <a href="/phases/<%= String(dep).padStart(2, '0') %>"><%= String(dep).padStart(2, '0') %></a><% if (idx < phase.dependencies.length - 1) { %>, <% } %>
            <% }); %>
          <% } else { %>
            <small>None</small>
          <% } %>
        </td>
      </tr>
      <% }); %>
    </tbody>
  </table>
</article>
<% } else { %>
<article>
  <p>No phases found. Add a ROADMAP.md file to your .planning/ directory to see the roadmap here.</p>
</article>
<% } %>

<%- include('partials/layout-bottom') %>
```

   Key template decisions:
   - Uses `layout-top`/`layout-bottom` partials with `activePage: 'roadmap'` (sidebar highlighting)
   - Phase names link to `/phases/:phaseId` (from Phase 05)
   - Dependency numbers are also clickable links to `/phases/:phaseId` for easy navigation
   - Status badges use existing `data-status` attribute + `status-badge` class (wired to status-colors.css)
   - Status text replaces hyphens with spaces: "not-started" displays as "not started"
   - Phase ID is zero-padded with `String(phase.id).padStart(2, '0')`
   - Empty state shows helpful message directing user to create ROADMAP.md
   - All user-sourced text uses `<%= %>` (auto-escaped)
   - Pico.css styles the `<table>` semantically, `<article>` adds the card wrapper

2. Update `src/routes/pages.routes.js` to replace the coming-soon /roadmap route with the real implementation.

   a. Add import at the top of the file (after the existing imports):
      ```javascript
      import { getRoadmapData } from '../services/roadmap.service.js';
      ```

   b. Find the existing `/roadmap` route block (should look like):
      ```javascript
      router.get('/roadmap', (req, res) => {
        res.render('coming-soon', {
          title: 'Roadmap',
          activePage: 'roadmap',
          featureName: 'Roadmap'
        });
      });
      ```

   c. Replace it entirely with:
      ```javascript
      router.get('/roadmap', async (req, res) => {
        const projectDir = req.app.locals.projectDir;
        const roadmapData = await getRoadmapData(projectDir);
        res.render('roadmap', {
          title: 'Roadmap',
          activePage: 'roadmap',
          phases: roadmapData.phases
        });
      });
      ```

   Key points:
   - Route handler is now async (Express 5.x auto-catches rejections)
   - `projectDir` comes from `req.app.locals.projectDir` (established pattern from Phase 04/05)
   - Passes `phases` array to the template (the only data the template needs)
   - `activePage: 'roadmap'` is preserved for sidebar highlighting
   - The route replaces the coming-soon placeholder -- no new URL paths added
  </action>
  <verify>
node -e "const fs = require('fs'); const tmpl = fs.readFileSync('D:/Repos/towline-test-project/src/views/roadmap.ejs','utf-8'); const route = fs.readFileSync('D:/Repos/towline-test-project/src/routes/pages.routes.js','utf-8'); if (!tmpl.includes('phases.forEach')) throw new Error('template missing phase loop'); if (!tmpl.includes('data-status')) throw new Error('template missing status badges'); if (!tmpl.includes('/phases/')) throw new Error('template missing phase links'); if (!tmpl.includes('planCount')) throw new Error('template missing plan count'); if (!tmpl.includes('dependencies')) throw new Error('template missing dependencies'); if (!route.includes('getRoadmapData')) throw new Error('route missing getRoadmapData import'); if (!route.includes('roadmap.service')) throw new Error('route missing roadmap service import'); if (route.includes('coming-soon') && route.includes('Roadmap') && route.includes('featureName')) throw new Error('route still has coming-soon for roadmap'); console.log('PASS: roadmap template has all required elements and route imports service');"
  </verify>
  <done>
GET /roadmap renders an enhanced table showing all phases with name (linked to phase detail), plan count, color-coded status badge, and dependency links. The coming-soon placeholder is fully replaced. Empty ROADMAP.md shows a graceful fallback message.
  </done>
</task>
