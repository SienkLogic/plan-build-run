---
phase: "12-polish-and-hardening"
plan: "12-01"
type: "feature"
wave: 1
depends_on: []
files_modified:
  - "src/middleware/errorHandler.js"
  - "src/middleware/notFoundHandler.js"
  - "src/views/error.ejs"
  - "src/app.js"
  - "tests/middleware/errorHandler.test.js"
autonomous: true
discovery: 0
must_haves:
  truths:
    - "Global error handler renders user-friendly error pages with status code and message"
    - "Stack traces are visible in development mode but hidden in production"
    - "Requests to undefined routes receive a 404 error page"
    - "If response headers are already sent, error handler delegates to Express default handler"
    - "HTMX requests receive error fragments (no layout), normal requests receive full error pages"
    - "Normal (non-HTMX) error responses render the full-page error.ejs template with layout"
  artifacts:
    - "src/middleware/errorHandler.js (enhanced with headersSent check, NODE_ENV detection, HTMX support)"
    - "src/middleware/notFoundHandler.js"
    - "src/views/error.ejs (enhanced with conditional stack trace display)"
    - "tests/middleware/errorHandler.test.js"
  key_links:
    - "notFoundHandler registered AFTER all routes but BEFORE errorHandler in app.js"
    - "errorHandler checks res.headersSent and delegates to next(err) if true"
    - "error.ejs conditionally renders stack trace when stack variable is truthy"
    - "errorHandler detects HX-Request header and renders error fragment vs full page"
---

# Plan 12-01: Error Handling Infrastructure

## Goal
Enhance the global error handler to be production-quality: handle headersSent edge case,
hide stack traces in production, render proper 404 pages for unmatched routes, and support
HTMX fragment responses for error states.

## Tasks

<task id="12-01-T1" type="auto" tdd="false">
  <name>Enhance error handler, create 404 handler, update error template</name>
  <files>
    src/middleware/errorHandler.js
    src/middleware/notFoundHandler.js
    src/views/error.ejs
    src/app.js
  </files>
  <action>
    1. Rewrite `src/middleware/errorHandler.js` with these changes:
       - Add `res.headersSent` check as the FIRST thing in the handler body.
         If `res.headersSent` is true, call `return next(err)` to delegate to Express default handler.
       - Determine environment: `const isDev = process.env.NODE_ENV !== 'production';`
         (not `=== 'development'` -- NODE_ENV may be unset in local dev)
       - Extract status: `const status = err.status || err.statusCode || 500;`
       - Logging: Always `console.error('Unhandled error:', err.message);`
         Only log `err.stack` when `isDev` is true.
       - Detect HTMX: `const isHtmx = req.get('HX-Request') === 'true';`
       - Set `res.setHeader('Vary', 'HX-Request')` before rendering.
       - Build template data object:
         ```javascript
         const templateData = {
           title: `Error ${status}`,
           status,
           message: err.message || 'Internal Server Error',
           stack: isDev ? err.stack : null,
           activePage: ''
         };
         ```
       - Render: if `isHtmx`, render just the error content inline via `res.status(status).send()`:
         ```javascript
         if (isHtmx) {
           let html = `<h1>Error ${status}</h1><p>${templateData.message}</p>`;
           if (templateData.stack) {
             html += `<pre><code>${templateData.stack}</code></pre>`;
           }
           html += '<p><a href="/">Return to Dashboard</a></p>';
           return res.status(status).send(html);
         }
         ```
         Otherwise render `res.status(status).render('error', templateData);`
       - Keep the exact 4-parameter signature `(err, req, res, next)` and the eslint-disable comment.

    2. Create `src/middleware/notFoundHandler.js`:
       ```javascript
       /**
        * 404 catch-all handler for routes that don't match any defined route.
        * Must be registered AFTER all route handlers but BEFORE the error handler.
        */
       export default function notFoundHandler(req, res, next) {
         const err = new Error(`Page not found: ${req.originalUrl}`);
         err.status = 404;
         next(err);
       }
       ```

    3. Update `src/views/error.ejs` to conditionally display stack trace:
       Replace the entire file content with:
       ```ejs
       <%- include('partials/layout-top', { title: typeof title !== 'undefined' ? title : 'Error', activePage: '' }) %>

       <h1>Error <%= status %></h1>
       <p><%= message %></p>
       <% if (typeof stack !== 'undefined' && stack) { %>
       <details>
         <summary>Stack Trace (Development Only)</summary>
         <pre><code><%= stack %></code></pre>
       </details>
       <% } %>
       <p><a href="/">Return to Dashboard</a></p>

       <%- include('partials/layout-bottom') %>
       ```
       Key points:
       - Use `<%= stack %>` (escaped) not `<%- stack %>` to prevent XSS
       - Wrap in `<details>` element for collapsible display
       - Guard with `typeof stack !== 'undefined' && stack` since existing routes
         may render error.ejs without passing a stack variable

    4. Update `src/app.js` to register the notFoundHandler:
       - Add import: `import notFoundHandler from './middleware/notFoundHandler.js';`
       - Insert `app.use(notFoundHandler);` AFTER the last route mount
         (`app.use('/api/events', eventsRouter);`) and BEFORE the error handler
         (`app.use(errorHandler);`).
       The final order should be:
       ```javascript
       // Routes
       app.use('/', indexRouter);
       app.use('/', pagesRouter);
       app.use('/api/events', eventsRouter);

       // 404 catch-all (after routes, before error handler)
       app.use(notFoundHandler);

       // Error handler MUST be registered last
       app.use(errorHandler);
       ```
  </action>
  <verify>
    npx --prefix D:/Repos/towline-test-project vitest run tests/middleware/errorHandler.test.js --reporter=verbose
  </verify>
  <done>
    The global error handler renders user-friendly error pages with status codes,
    hides stack traces in production mode, handles the headersSent edge case,
    returns fragments for HTMX requests, and unmatched routes produce a 404 error page.
  </done>
</task>

<task id="12-01-T2" type="auto" tdd="false">
  <name>Write error handler and 404 handler unit tests</name>
  <files>
    tests/middleware/errorHandler.test.js
  </files>
  <action>
    1. Create `tests/middleware/errorHandler.test.js` with these test cases.
       Import directly (no fs mocking needed -- these are middleware tests with mock req/res):

       ```javascript
       import { describe, it, expect, vi, beforeEach, afterEach } from 'vitest';
       ```

       Create helper factories for mock req/res/next:
       ```javascript
       function createMockReq(overrides = {}) {
         return {
           originalUrl: '/test',
           get: vi.fn().mockReturnValue(null),
           ...overrides
         };
       }

       function createMockRes() {
         const res = {
           headersSent: false,
           statusCode: 200,
           headers: {},
           status: vi.fn().mockReturnThis(),
           render: vi.fn(),
           send: vi.fn(),
           setHeader: vi.fn()
         };
         return res;
       }
       ```

       Import both handlers:
       ```javascript
       import errorHandler from '../../src/middleware/errorHandler.js';
       import notFoundHandler from '../../src/middleware/notFoundHandler.js';
       ```

       **errorHandler tests** (describe block):

       a. "should render error page with status and message":
          - Create error: `const err = new Error('Something broke'); err.status = 500;`
          - Call `errorHandler(err, req, res, next)`
          - Assert: `res.status` called with 500
          - Assert: `res.render` called with 'error' and object containing
            `{ status: 500, message: 'Something broke' }`

       b. "should default to status 500 when error has no status":
          - Create error: `new Error('Unknown error')` (no status property)
          - Call handler, assert `res.status` called with 500

       c. "should use err.statusCode when err.status is not set":
          - Create error with `err.statusCode = 403`
          - Call handler, assert `res.status` called with 403

       d. "should include stack trace in development mode":
          - Save original NODE_ENV, set `process.env.NODE_ENV = 'development'`
          - Create error with a stack
          - Call handler
          - Assert: `res.render` called with template data where `stack` is truthy (not null)
          - Restore NODE_ENV in afterEach

       e. "should hide stack trace in production mode":
          - Set `process.env.NODE_ENV = 'production'`
          - Create error with a stack
          - Call handler
          - Assert: `res.render` called with template data where `stack` is null
          - Restore NODE_ENV

       f. "should include stack trace when NODE_ENV is not set (local dev default)":
          - Delete `process.env.NODE_ENV`
          - Create error, call handler
          - Assert: stack is truthy in render call

       g. "should delegate to next(err) when headers already sent":
          - Set `res.headersSent = true`
          - Call handler
          - Assert: `next` was called with the error
          - Assert: `res.render` was NOT called

       h. "should return HTML fragment for HTMX requests":
          - Set `req.get` to return 'true' when called with 'HX-Request'
          - Create error `err.status = 404; err.message = 'Not found'`
          - Call handler
          - Assert: `res.send` was called (NOT res.render)
          - Assert: the sent HTML contains 'Error 404' and 'Not found'
          - Assert: `res.setHeader` called with 'Vary', 'HX-Request'

       i. "should set Vary header for normal requests":
          - Call handler with normal request
          - Assert: `res.setHeader` called with 'Vary', 'HX-Request'

       j. "should render full-page error with layout for normal (non-HTMX) requests":
          - Create error: `const err = new Error('Server error'); err.status = 500;`
          - Call `errorHandler(err, req, res, next)` with `req.get` returning null (no HX-Request)
          - Assert: `res.render` was called (NOT `res.send`)
          - Assert: `res.render` first argument is 'error'
          - Assert: `res.render` second argument contains `{ title: 'Error 500', status: 500, message: 'Server error', activePage: '' }`
          - This confirms that non-HTMX requests get `res.render('error', ...)` which
            renders error.ejs with the full layout-top/layout-bottom partials.

       **notFoundHandler tests** (describe block):

       k. "should create 404 error and call next":
          - Call `notFoundHandler(req, res, next)`
          - Assert: `next` was called with an Error
          - Assert: the error has `status === 404`
          - Assert: the error message includes `req.originalUrl`

       l. "should include the request URL in the error message":
          - Set `req.originalUrl = '/nonexistent/path'`
          - Call handler
          - Assert: error message contains '/nonexistent/path'

       Use `beforeEach`/`afterEach` to save and restore `process.env.NODE_ENV`.
  </action>
  <verify>
    npx --prefix D:/Repos/towline-test-project vitest run tests/middleware/errorHandler.test.js --reporter=verbose
  </verify>
  <done>
    All error handler tests pass, validating: status rendering, stack trace visibility
    by environment, headersSent delegation, HTMX fragment responses, full-page layout
    rendering for normal requests, and 404 catch-all behavior.
  </done>
</task>
