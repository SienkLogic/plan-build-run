---
phase: "08-todo-list-and-detail"
plan: "08-02"
type: "feature"
wave: 2
depends_on: ["08-01"]
files_modified:
  - "src/views/todos.ejs"
  - "src/views/todo-detail.ejs"
  - "src/routes/pages.routes.js"
autonomous: true
discovery: 0
must_haves:
  truths:
    - "GET /todos renders a table of all pending todos with title, priority badge, phase tag, status, and created date"
    - "Each todo title is a clickable link to /todos/:id for the detail view"
    - "Priority badges use data-priority attribute and display the priority level text (P0/P1/P2/PX)"
    - "Empty state displays helpful message when no pending todos exist"
    - "GET /todos/:id renders full markdown content with frontmatter metadata displayed"
    - "Todo detail page has a back link to /todos"
    - "Invalid todo ID format (non-three-digit) returns 404 error"
    - "Non-existent todo ID returns 404 error"
    - "Both routes set activePage to 'todos' for sidebar highlighting"
    - "The coming-soon placeholder for /todos is fully replaced"
  artifacts:
    - "src/views/todos.ejs with table layout for todo list"
    - "src/views/todo-detail.ejs with metadata header and rendered markdown body"
  key_links:
    - "pages.routes.js imports listPendingTodos and getTodoDetail from todo.service.js"
    - "pages.routes.js GET /todos calls listPendingTodos and renders todos.ejs"
    - "pages.routes.js GET /todos/:id validates ID format, calls getTodoDetail, renders todo-detail.ejs"
    - "todos.ejs links each todo title to /todos/:id"
    - "todo-detail.ejs links back to /todos"
consumes:
  - "listPendingTodos(projectDir) from todo.service.js (plan 08-01)"
  - "getTodoDetail(projectDir, todoId) from todo.service.js (plan 08-01)"
  - "Priority badge CSS via data-priority attribute (plan 08-01)"
  - "layout-top.ejs / layout-bottom.ejs partials (Phase 03)"
  - "status-colors.css with priority badge rules (plan 08-01)"
---

# Plan 08-02: Todo List and Detail Templates with Route Wiring

## Overview

Create two EJS templates: `todos.ejs` for the list view showing a table of pending todos with
priority badges and phase tags, and `todo-detail.ejs` for the detail view showing full rendered
markdown content with metadata. Wire both routes in `pages.routes.js`, replacing the existing
coming-soon /todos placeholder and adding a new /todos/:id route with ID validation.

Both templates follow the established patterns from `roadmap.ejs` (table layout in list view)
and `phase-detail.ejs` (metadata header in detail view). All user-sourced text uses escaped
EJS tags (`<%= %>`) to prevent XSS. The markdown body in the detail view uses unescaped
(`<%- %>`) since it comes from marked rendering (same pattern as index.ejs with `<%- content %>`).

## Tasks

<task id="08-02-T1" type="auto" tdd="false">
  <name>Create todos.ejs and todo-detail.ejs templates</name>
  <files>
    src/views/todos.ejs
    src/views/todo-detail.ejs
  </files>
  <action>
    All file paths are relative to `D:\Repos\towline-test-project`.

    1. Create file `src/views/todos.ejs` with the following content:

       ```ejs
       <%- include('partials/layout-top', { title: 'Todos', activePage: 'todos' }) %>

       <h1>Todos</h1>

       <% if (todos.length > 0) { %>
       <article>
         <table>
           <thead>
             <tr>
               <th scope="col">ID</th>
               <th scope="col">Title</th>
               <th scope="col">Priority</th>
               <th scope="col">Phase</th>
               <th scope="col">Status</th>
               <th scope="col">Created</th>
             </tr>
           </thead>
           <tbody>
             <% todos.forEach(function(todo) { %>
             <tr>
               <td><%= todo.id %></td>
               <td>
                 <a href="/todos/<%= todo.id %>">
                   <%= todo.title %>
                 </a>
               </td>
               <td>
                 <span class="status-badge" data-priority="<%= todo.priority %>">
                   <%= todo.priority %>
                 </span>
               </td>
               <td><%= todo.phase %></td>
               <td>
                 <span class="status-badge" data-status="<%= todo.status %>">
                   <%= todo.status %>
                 </span>
               </td>
               <td><%= todo.created %></td>
             </tr>
             <% }); %>
           </tbody>
         </table>
       </article>
       <% } else { %>
       <article>
         <p>No pending todos found. Add a todo file to <code>.planning/todos/pending/</code> to see it here.</p>
       </article>
       <% } %>

       <%- include('partials/layout-bottom') %>
       ```

       Key template decisions:
       - Uses `layout-top`/`layout-bottom` partials with `activePage: 'todos'` (sidebar highlighting)
       - Table layout with 6 columns: ID, Title, Priority, Phase, Status, Created
       - Title column wraps text in `<a href="/todos/<%= todo.id %>">` for navigation to detail view
       - Priority badge uses `data-priority` attribute (wired to priority CSS from plan 08-01)
       - Status badge uses existing `data-status` attribute (wired to status-colors.css from Phase 03)
       - Created column displays the date string directly
       - Empty state wrapped in `<article>` (Pico.css card styling) with helpful guidance text
       - All user-sourced text uses `<%= %>` (auto-escaped) -- NEVER `<%- %>`
       - `<article>` wraps the table for Pico.css card styling (consistent with roadmap.ejs)

    2. Create file `src/views/todo-detail.ejs` with the following content:

       ```ejs
       <%- include('partials/layout-top', { title: title, activePage: 'todos' }) %>

       <h1><%= title %></h1>

       <p><a href="/todos">&larr; Back to Todos</a></p>

       <article>
         <header>
           <strong>Todo <%= id %></strong>
           &nbsp;
           <span class="status-badge" data-priority="<%= priority %>">
             <%= priority %>
           </span>
           &nbsp;
           <span class="status-badge" data-status="<%= status %>">
             <%= status %>
           </span>
         </header>

         <% if (phase) { %>
         <p><strong>Phase:</strong> <%= phase %></p>
         <% } %>
         <% if (created) { %>
         <p><strong>Created:</strong> <%= created %></p>
         <% } %>

         <hr>

         <%- html %>
       </article>

       <%- include('partials/layout-bottom') %>
       ```

       Key template decisions:
       - `title` is set to "Todo NNN: {title}" by the route handler (displayed in page header and browser tab)
       - Back link to /todos list (same pattern as phase-detail.ejs linking back to dashboard)
       - Header shows todo ID, priority badge (data-priority), and status badge (data-status) inline
       - Phase and created date shown conditionally (may be empty)
       - `<hr>` separates metadata from body content
       - `<%- html %>` uses unescaped output for rendered markdown (same pattern as index.ejs `<%- content %>`)
       - All metadata fields use `<%= %>` (escaped) -- only the pre-rendered markdown body uses `<%- %>`
       - Wrapped in `<article>` for Pico.css card styling
  </action>
  <verify>
    node -e "const fs = require('fs'); const todos = fs.readFileSync('D:/Repos/towline-test-project/src/views/todos.ejs','utf-8'); const detail = fs.readFileSync('D:/Repos/towline-test-project/src/views/todo-detail.ejs','utf-8'); if (!todos.includes('layout-top')) throw new Error('todos.ejs missing layout-top'); if (!todos.includes('todos.forEach')) throw new Error('todos.ejs missing todo loop'); if (!todos.includes('data-priority')) throw new Error('todos.ejs missing priority badge'); if (!todos.includes('/todos/')) throw new Error('todos.ejs missing todo links'); if (!todos.includes('No pending todos')) throw new Error('todos.ejs missing empty state'); if (!detail.includes('layout-top')) throw new Error('todo-detail.ejs missing layout-top'); if (!detail.includes('data-priority')) throw new Error('todo-detail.ejs missing priority badge'); if (!detail.includes('/todos')) throw new Error('todo-detail.ejs missing back link'); if (!detail.includes('<%- html %>')) throw new Error('todo-detail.ejs missing html output'); console.log('PASS: both templates have all required elements');"
  </verify>
  <done>
    todos.ejs renders a table of pending todos with ID, clickable title, priority badge, phase tag, status badge, and created date. Empty state shows guidance message. todo-detail.ejs renders full metadata header with priority and status badges, followed by rendered markdown body. Both templates use layout-top/layout-bottom partials with activePage set to 'todos'.
  </done>
</task>

<task id="08-02-T2" type="auto" tdd="false">
  <name>Wire GET /todos and GET /todos/:id routes in pages.routes.js</name>
  <files>
    src/routes/pages.routes.js
  </files>
  <action>
    All file paths are relative to `D:\Repos\towline-test-project`.

    1. Open `src/routes/pages.routes.js`

    2. Add import at the top of the file (after the existing service imports from phases 05, 06, etc.):
       ```javascript
       import { listPendingTodos, getTodoDetail } from '../services/todo.service.js';
       ```

    3. Find the existing `/todos` route block. It should currently look like:
       ```javascript
       router.get('/todos', (req, res) => {
         res.render('coming-soon', {
           title: 'Todos',
           activePage: 'todos',
           featureName: 'Todos'
         });
       });
       ```

    4. Replace it entirely with the real implementation:
       ```javascript
       router.get('/todos', async (req, res) => {
         const projectDir = req.app.locals.projectDir;
         const todos = await listPendingTodos(projectDir);
         res.render('todos', {
           title: 'Todos',
           activePage: 'todos',
           todos
         });
       });
       ```

       Key points:
       - Route handler is now async (Express 5.x auto-catches rejections)
       - `projectDir` from `req.app.locals.projectDir` (established pattern from Phase 04+)
       - Passes the sorted todos array directly to the template
       - `activePage: 'todos'` preserved for sidebar highlighting

    5. Add the detail route IMMEDIATELY AFTER the `/todos` list route and BEFORE any
       other routes that follow it (like the `/roadmap` route):
       ```javascript
       router.get('/todos/:id', async (req, res) => {
         const { id } = req.params;

         // Validate ID format: must be exactly three digits
         if (!/^\d{3}$/.test(id)) {
           const err = new Error('Todo ID must be a three-digit number (e.g., 001, 005, 042)');
           err.status = 404;
           throw err;
         }

         const projectDir = req.app.locals.projectDir;
         const todo = await getTodoDetail(projectDir, id);

         res.render('todo-detail', {
           title: `Todo ${todo.id}: ${todo.title}`,
           activePage: 'todos',
           ...todo
         });
       });
       ```

       Key points:
       - ID validation regex is `/^\d{3}$/` (THREE digits, not two like phaseId)
       - Invalid format throws 404 immediately (Express 5.x auto-catches)
       - `getTodoDetail` may also throw 404 if no file matches -- Express catches this too
       - Title is "Todo NNN: {title}" for the browser tab and page heading
       - Spreads all todo properties into the template data (id, title, priority, phase, status, created, html, filename)
       - `activePage: 'todos'` ensures sidebar stays highlighted on the detail page
       - Must be registered AFTER `/todos` but BEFORE `/roadmap` to avoid route conflicts

    6. Verify the route ordering in pages.routes.js is correct. The expected order is:
       - GET /phases (coming-soon or real implementation)
       - GET /phases/:phaseId (from Phase 05)
       - GET /todos (NEW - list)
       - GET /todos/:id (NEW - detail)
       - GET /roadmap (real implementation from Phase 06)

       Express routes are matched in registration order. `/todos` must come before `/todos/:id`
       to ensure the list route matches first. The `:id` parameter route only matches when
       there is a path segment after `/todos/`.
  </action>
  <verify>
    node -e "const fs = require('fs'); const route = fs.readFileSync('D:/Repos/towline-test-project/src/routes/pages.routes.js','utf-8'); if (!route.includes('listPendingTodos')) throw new Error('route missing listPendingTodos import'); if (!route.includes('getTodoDetail')) throw new Error('route missing getTodoDetail import'); if (!route.includes('todo.service')) throw new Error('route missing todo service import'); if (route.includes('coming-soon') && route.includes('featureName') && route.includes('Todos')) throw new Error('route still has coming-soon for todos'); if (!route.includes('todos/:id')) throw new Error('route missing todos/:id param route'); if (!route.includes('/^\\\\d{3}$/') && !route.includes('/^\\d{3}$/')) { const hasThreeDigit = route.includes('\\d{3}'); if (!hasThreeDigit) throw new Error('route missing 3-digit ID validation'); } console.log('PASS: routes import todo service, coming-soon replaced, detail route with ID validation present');"
    node -e "import('D:/Repos/towline-test-project/src/app.js').then(async m => { const app = m.createApp({projectDir: 'D:/Repos/towline-test-project'}); const server = app.listen(0, '127.0.0.1', async () => { const port = server.address().port; try { const listRes = await fetch('http://127.0.0.1:' + port + '/todos'); if (listRes.status !== 200) throw new Error('/todos returned ' + listRes.status); const listBody = await listRes.text(); if (!listBody.includes('Todos')) throw new Error('/todos missing Todos heading'); if (!listBody.includes('sidebar')) throw new Error('/todos missing sidebar'); const badIdRes = await fetch('http://127.0.0.1:' + port + '/todos/abc'); if (badIdRes.status !== 404) throw new Error('/todos/abc should return 404, got ' + badIdRes.status); const badId2Res = await fetch('http://127.0.0.1:' + port + '/todos/1'); if (badId2Res.status !== 404) throw new Error('/todos/1 should return 404, got ' + badId2Res.status); console.log('PASS: /todos returns 200, invalid IDs return 404'); } finally { server.close(); } }); })"
  </verify>
  <done>
    GET /todos renders the todos.ejs template with all pending todos from the service layer. GET /todos/:id validates the three-digit ID format, calls getTodoDetail, and renders todo-detail.ejs with full markdown content. Invalid ID formats and non-existent IDs return 404. The coming-soon placeholder for /todos is fully replaced. Both routes set activePage to 'todos' for sidebar highlighting.
  </done>
</task>
