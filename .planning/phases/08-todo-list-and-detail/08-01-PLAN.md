---
phase: "08-todo-list-and-detail"
plan: "08-01"
type: "feature"
wave: 1
depends_on: []
files_modified:
  - "src/services/todo.service.js"
  - "tests/services/todo.service.test.js"
  - "public/css/status-colors.css"
autonomous: true
discovery: 0
must_haves:
  truths:
    - "listPendingTodos(projectDir) returns an array of todo objects parsed from .planning/todos/pending/*.md"
    - "Each todo object contains id, title, priority, phase, status, created, and filename"
    - "Todos are sorted by priority (P0 first, P1, P2, PX last) then alphabetically by title"
    - "Invalid or unknown priorities sort to the end (after PX)"
    - "Todos with missing required frontmatter fields (id, title, priority) are skipped"
    - "Missing .planning/todos/pending/ directory returns empty array (no crash)"
    - "getTodoDetail(projectDir, todoId) returns a single todo with frontmatter + rendered HTML"
    - "getTodoDetail throws ENOENT-like error when no file matches the todoId"
    - "Todo ID is extracted from filename prefix (NNN-*.md pattern)"
    - "Priority badge CSS renders P0 red, P1 orange, P2 yellow, PX indigo via data-priority attribute"
    - "Unit tests pass using memfs in-memory filesystem mocks"
  artifacts:
    - "src/services/todo.service.js with listPendingTodos and getTodoDetail"
    - "tests/services/todo.service.test.js with comprehensive test coverage"
    - "public/css/status-colors.css updated with priority badge rules"
  key_links:
    - "todo.service.js imports readMarkdownFile from planning.repository.js"
    - "todo.service.js imports readdir from node:fs/promises for directory listing"
    - "Priority CSS uses data-priority attribute (separate from data-status used by status badges)"
---

# Plan 08-01: Todo Service Layer, Tests, and Priority CSS

## Overview

Create `todo.service.js` with two exported functions: `listPendingTodos(projectDir)` that reads
all markdown files from `.planning/todos/pending/`, parses frontmatter, filters out invalid entries,
and returns a sorted array; and `getTodoDetail(projectDir, todoId)` that reads a single todo by
matching the ID prefix in the filename and returns frontmatter plus rendered HTML.

Add priority badge CSS rules to `status-colors.css` using `data-priority` attribute selectors
(separate from the existing `data-status` system to avoid conflicts).

Unit tests use memfs mocking following the established pattern from phase.service.test.js
and roadmap.service.test.js.

## Tasks

<task id="08-01-T1" type="auto" tdd="false">
  <name>Create todo.service.js with listPendingTodos and getTodoDetail</name>
  <files>
    src/services/todo.service.js
  </files>
  <action>
    All file paths are relative to `D:\Repos\towline-test-project`.

    1. Create file `src/services/todo.service.js`

    2. Add imports:
       ```javascript
       import { readdir } from 'node:fs/promises';
       import { join } from 'node:path';
       import { readMarkdownFile } from '../repositories/planning.repository.js';
       ```

    3. Create internal constant for priority sort order:
       ```javascript
       const PRIORITY_ORDER = { P0: 0, P1: 1, P2: 2, PX: 3 };
       ```

    4. Create internal helper function `sortTodosByPriority(todos)`:
       ```javascript
       /**
        * Sort todos by priority (P0 first) then alphabetically by title.
        * Unknown priorities sort after PX.
        * @param {Array} todos - Array of todo objects with priority and title fields
        * @returns {Array} Sorted array (mutates and returns the input)
        */
       function sortTodosByPriority(todos) {
         return todos.sort((a, b) => {
           const aPriority = PRIORITY_ORDER[a.priority] ?? 99;
           const bPriority = PRIORITY_ORDER[b.priority] ?? 99;
           const priorityDiff = aPriority - bPriority;
           if (priorityDiff !== 0) return priorityDiff;
           return a.title.localeCompare(b.title);
         });
       }
       ```

       Key points:
       - Uses nullish coalescing (`??`) to handle unknown priorities -- they get sort value 99 (after PX=3)
       - `localeCompare` for stable alphabetical sorting within the same priority level

    5. Export async function `listPendingTodos(projectDir)`:
       ```javascript
       /**
        * List all pending todos from .planning/todos/pending/ directory.
        * Reads each markdown file, parses frontmatter, filters invalid entries,
        * and returns sorted by priority then title.
        *
        * @param {string} projectDir - Absolute path to the project root
        * @returns {Promise<Array<{id: string, title: string, priority: string, phase: string, status: string, created: string, filename: string}>>}
        */
       export async function listPendingTodos(projectDir) {
         const pendingDir = join(projectDir, '.planning', 'todos', 'pending');

         let entries;
         try {
           entries = await readdir(pendingDir, { withFileTypes: true });
         } catch (err) {
           if (err.code === 'ENOENT') return [];
           throw err;
         }

         // Filter for .md files and extract ID from filename prefix
         const mdFiles = entries
           .filter(entry => entry.isFile() && entry.name.endsWith('.md'))
           .map(entry => ({
             filename: entry.name,
             filePath: join(pendingDir, entry.name),
             fileId: entry.name.match(/^(\d{3})-/)?.[1] || null
           }))
           .filter(f => f.fileId !== null);

         // Read all todo files in parallel with partial failure tolerance
         const results = await Promise.allSettled(
           mdFiles.map(f => readMarkdownFile(f.filePath))
         );

         const todos = [];
         for (let i = 0; i < results.length; i++) {
           if (results[i].status !== 'fulfilled') continue;

           const { frontmatter } = results[i].value;
           const { filename, fileId } = mdFiles[i];

           // Skip todos missing required frontmatter fields
           const title = frontmatter.title;
           const priority = frontmatter.priority;
           if (!title || !priority) continue;

           todos.push({
             id: frontmatter.id || fileId,
             title,
             priority,
             phase: frontmatter.phase || '',
             status: frontmatter.status || 'pending',
             created: frontmatter.created ? String(frontmatter.created) : '',
             filename
           });
         }

         return sortTodosByPriority(todos);
       }
       ```

       Key decisions:
       - `readdir` with `withFileTypes: true` for efficient directory listing without extra `stat` calls
       - ENOENT on the directory returns empty array (project may not have todos yet)
       - Filename must match `^(\d{3})-` pattern -- IDs are always 3 digits
       - `Promise.allSettled` for partial failure tolerance -- one bad file does not crash the list
       - ID source: prefer frontmatter `id` field, fall back to filename prefix
       - `created` is coerced to string because gray-matter may parse YAML dates as Date objects
       - Todos missing `title` or `priority` are silently skipped (not displayed in the list)

    6. Export async function `getTodoDetail(projectDir, todoId)`:
       ```javascript
       /**
        * Get a single todo by ID with full markdown content.
        * Searches .planning/todos/pending/ for a file whose name starts with the given ID.
        *
        * @param {string} projectDir - Absolute path to the project root
        * @param {string} todoId - Three-digit todo ID (e.g., "001", "042")
        * @returns {Promise<{id: string, title: string, priority: string, phase: string, status: string, created: string, html: string, filename: string}>}
        * @throws {Error} With status 404 if no todo matches the given ID
        */
       export async function getTodoDetail(projectDir, todoId) {
         const pendingDir = join(projectDir, '.planning', 'todos', 'pending');

         let entries;
         try {
           entries = await readdir(pendingDir);
         } catch (err) {
           if (err.code === 'ENOENT') {
             const notFound = new Error(`Todo ${todoId} not found`);
             notFound.status = 404;
             throw notFound;
           }
           throw err;
         }

         // Find the file whose name starts with the todoId prefix
         const matchingFile = entries.find(name =>
           name.startsWith(`${todoId}-`) && name.endsWith('.md')
         );

         if (!matchingFile) {
           const notFound = new Error(`Todo ${todoId} not found`);
           notFound.status = 404;
           throw notFound;
         }

         const filePath = join(pendingDir, matchingFile);
         const { frontmatter, html } = await readMarkdownFile(filePath);

         return {
           id: frontmatter.id || todoId,
           title: frontmatter.title || 'Untitled',
           priority: frontmatter.priority || 'PX',
           phase: frontmatter.phase || '',
           status: frontmatter.status || 'pending',
           created: frontmatter.created ? String(frontmatter.created) : '',
           html,
           filename: matchingFile
         };
       }
       ```

       Key decisions:
       - Searches by filename prefix match (`todoId-*.md`) rather than reading all files
       - Throws error with `status: 404` for missing directory or missing file (Express error handler picks this up)
       - Returns rendered HTML from `readMarkdownFile` for the detail view body
       - Defensively defaults all optional frontmatter fields
       - `created` coerced to string (same as listPendingTodos)
  </action>
  <verify>
    node -e "import('D:/Repos/towline-test-project/src/services/todo.service.js').then(m => { if (typeof m.listPendingTodos !== 'function') throw new Error('listPendingTodos not exported'); if (typeof m.getTodoDetail !== 'function') throw new Error('getTodoDetail not exported'); console.log('PASS: both functions exported correctly'); })"
  </verify>
  <done>
    todo.service.js exports listPendingTodos and getTodoDetail. listPendingTodos reads .planning/todos/pending/, parses frontmatter, filters invalid entries, and returns todos sorted by priority then title. getTodoDetail finds a single todo by filename prefix and returns full metadata plus rendered HTML.
  </done>
</task>

<task id="08-01-T2" type="auto" tdd="false">
  <name>Create unit tests for todo.service.js and add priority badge CSS</name>
  <files>
    tests/services/todo.service.test.js
    public/css/status-colors.css
  </files>
  <action>
    All file paths are relative to `D:\Repos\towline-test-project`.

    1. Create file `tests/services/todo.service.test.js`

    2. Set up imports and mocks following the established pattern:
       ```javascript
       import { describe, it, expect, beforeEach, vi } from 'vitest';
       import { vol } from 'memfs';

       // Mock node:fs/promises with memfs (used by todo.service.js AND planning.repository.js)
       vi.mock('node:fs/promises', async () => {
         const memfs = await import('memfs');
         return memfs.fs.promises;
       });

       // Import AFTER mock is set up
       const { listPendingTodos, getTodoDetail } = await import(
         '../../src/services/todo.service.js'
       );
       ```

    3. Add `beforeEach(() => { vol.reset(); });`

    4. Create test fixture constants at module level:

       ```javascript
       const TODO_P0 = `---
       id: "003"
       title: "Critical bug fix"
       priority: P0
       phase: "02"
       status: pending
       created: 2026-02-06
       ---

       # Critical bug fix

       This is a critical issue that needs immediate attention.
       `;

       const TODO_P1 = `---
       id: "001"
       title: "Add audit logging to hook scripts"
       priority: P1
       phase: general
       status: pending
       created: 2026-02-07
       ---

       # Add audit logging

       Hook scripts currently have no audit trail.
       `;

       const TODO_P2 = `---
       id: "005"
       title: "Implement continuation handoff"
       priority: P2
       phase: general
       status: pending
       created: 2026-02-07
       ---

       # Continuation handoff

       When context limits are reached, implement a handoff strategy.
       `;

       const TODO_PX = `---
       id: "002"
       title: "Nice to have feature"
       priority: PX
       phase: "03"
       status: pending
       created: 2026-02-08
       ---

       # Nice to have

       Low priority improvement.
       `;

       const TODO_NO_TITLE = `---
       id: "004"
       priority: P1
       status: pending
       ---

       # Missing title in frontmatter
       `;

       const TODO_NO_PRIORITY = `---
       id: "006"
       title: "Has title but no priority"
       status: pending
       ---

       # No priority field
       `;
       ```

    5. Write `describe('listPendingTodos')` with these tests:

       a. `it('should return todos sorted by priority then title')`:
          - Set up memfs vol with:
            - `/project/.planning/todos/pending/003-critical-bug.md` containing TODO_P0
            - `/project/.planning/todos/pending/001-audit-logging.md` containing TODO_P1
            - `/project/.planning/todos/pending/005-continuation.md` containing TODO_P2
            - `/project/.planning/todos/pending/002-nice-feature.md` containing TODO_PX
          - Call `listPendingTodos('/project')`
          - Assert result.length === 4
          - Assert result[0].priority === 'P0' and result[0].title === 'Critical bug fix'
          - Assert result[1].priority === 'P1' and result[1].title === 'Add audit logging to hook scripts'
          - Assert result[2].priority === 'P2' and result[2].title === 'Implement continuation handoff'
          - Assert result[3].priority === 'PX' and result[3].title === 'Nice to have feature'

       b. `it('should sort alphabetically within same priority level')`:
          - Set up memfs vol with two P1 todos:
            - `/project/.planning/todos/pending/010-zebra.md` with title "Zebra task", priority P1
            - `/project/.planning/todos/pending/011-alpha.md` with title "Alpha task", priority P1
          - Use inline frontmatter strings (not the fixture constants)
          - Call `listPendingTodos('/project')`
          - Assert result[0].title === 'Alpha task' (alphabetically first)
          - Assert result[1].title === 'Zebra task'

       c. `it('should return empty array when pending directory does not exist')`:
          - Set up memfs vol with only `/project/package.json`
          - Call `listPendingTodos('/project')`
          - Assert result is empty array
          - Assert does NOT throw

       d. `it('should return empty array when pending directory is empty')`:
          - Set up memfs vol with `/project/.planning/todos/pending/.gitkeep` (not a .md file)
          - Call `listPendingTodos('/project')`
          - Assert result is empty array

       e. `it('should skip todos missing required frontmatter fields')`:
          - Set up memfs vol with:
            - `/project/.planning/todos/pending/001-audit-logging.md` containing TODO_P1
            - `/project/.planning/todos/pending/004-no-title.md` containing TODO_NO_TITLE
            - `/project/.planning/todos/pending/006-no-priority.md` containing TODO_NO_PRIORITY
          - Call `listPendingTodos('/project')`
          - Assert result.length === 1
          - Assert result[0].id === '001'

       f. `it('should skip files not matching NNN-*.md filename pattern')`:
          - Set up memfs vol with:
            - `/project/.planning/todos/pending/001-valid.md` containing TODO_P1
            - `/project/.planning/todos/pending/README.md` with content `# Readme`
            - `/project/.planning/todos/pending/notes.txt` with content `some notes`
          - Call `listPendingTodos('/project')`
          - Assert result.length === 1

       g. `it('should use filename ID as fallback when frontmatter has no id field')`:
          - Set up memfs vol with:
            - `/project/.planning/todos/pending/099-no-id.md` with frontmatter that has title and priority but NO id field:
              ```
              ---
              title: "No ID field"
              priority: P2
              ---
              # Content
              ```
          - Call `listPendingTodos('/project')`
          - Assert result[0].id === '099' (from filename)

       h. `it('should coerce created date to string')`:
          - Set up memfs vol with:
            - `/project/.planning/todos/pending/001-audit-logging.md` containing TODO_P1
          - Call `listPendingTodos('/project')`
          - Assert typeof result[0].created === 'string'

       i. `it('should handle unknown priority values by sorting them last')`:
          - Set up memfs vol with:
            - `/project/.planning/todos/pending/001-known.md` with priority P1
            - `/project/.planning/todos/pending/002-unknown.md` with priority "HIGH" (not P0/P1/P2/PX)
          - Use inline frontmatter strings
          - Call `listPendingTodos('/project')`
          - Assert result[0].priority === 'P1' (known priority sorts first)
          - Assert result[1].priority === 'HIGH' (unknown sorts last)

       j. `it('should include all expected fields on each todo object')`:
          - Set up memfs vol with `/project/.planning/todos/pending/001-audit-logging.md` containing TODO_P1
          - Call `listPendingTodos('/project')`
          - Assert result[0] has all fields: id, title, priority, phase, status, created, filename
          - Assert result[0].filename === '001-audit-logging.md'
          - Assert result[0].phase === 'general'
          - Assert result[0].status === 'pending'

    6. Write `describe('getTodoDetail')` with these tests:

       k. `it('should return full todo detail with rendered HTML')`:
          - Set up memfs vol with:
            - `/project/.planning/todos/pending/001-audit-logging.md` containing TODO_P1
          - Call `getTodoDetail('/project', '001')`
          - Assert result.id === '001'
          - Assert result.title === 'Add audit logging to hook scripts'
          - Assert result.priority === 'P1'
          - Assert result.phase === 'general'
          - Assert result.html contains '<h1>' or 'Add audit logging'
          - Assert result.filename === '001-audit-logging.md'

       l. `it('should throw 404 error when no todo matches the given ID')`:
          - Set up memfs vol with:
            - `/project/.planning/todos/pending/001-audit-logging.md` containing TODO_P1
          - Call `getTodoDetail('/project', '999')`
          - Expect it to throw
          - Catch the error and assert error.status === 404
          - Assert error.message contains '999'

       m. `it('should throw 404 error when pending directory does not exist')`:
          - Set up memfs vol with only `/project/package.json`
          - Call `getTodoDetail('/project', '001')`
          - Expect it to throw
          - Catch the error and assert error.status === 404

       n. `it('should handle UTF-8 BOM in todo file')`:
          - Set up memfs vol with BOM-prefixed TODO_P1:
            - `/project/.planning/todos/pending/001-audit-logging.md` containing `\uFEFF` + TODO_P1
          - Call `getTodoDetail('/project', '001')`
          - Assert result.title === 'Add audit logging to hook scripts' (BOM stripped by readMarkdownFile)

    7. Run all tests: `npx vitest run tests/services/todo.service.test.js`

    8. Update `public/css/status-colors.css` to add priority badge CSS rules.

       After the LAST `.status-badge[data-status="..."]` rule block (which should be the
       "passed" and "partial" rules added in Phase 05), add a blank line separator comment
       and the priority badge rules:

       ```css

       /* Priority badge variants - uses data-priority attribute (separate from data-status) */
       .status-badge[data-priority="P0"] {
         background-color: #fee2e2;
         color: #7f1d1d;
       }

       .status-badge[data-priority="P1"] {
         background-color: #fed7aa;
         color: #7c2d12;
       }

       .status-badge[data-priority="P2"] {
         background-color: #fef9c3;
         color: #713f12;
       }

       .status-badge[data-priority="PX"] {
         background-color: #e0e7ff;
         color: #312e81;
       }
       ```

       Key points:
       - Uses `data-priority` attribute (NOT `data-status`) to avoid conflicts with status badges
       - Reuses the same `.status-badge` base class for consistent sizing and font styling
       - P0 red matches the existing `blocked/failed` palette (same urgency connotation)
       - P1 orange is distinct from any existing status color
       - P2 yellow matches the existing `in-progress` palette
       - PX indigo provides a calm, low-urgency visual accent
  </action>
  <verify>
    cd /d D:\Repos\towline-test-project && npx vitest run tests/services/todo.service.test.js --reporter=verbose
    node -e "const fs = require('fs'); const css = fs.readFileSync('D:/Repos/towline-test-project/public/css/status-colors.css','utf-8'); if (!css.includes('data-priority=\"P0\"')) throw new Error('CSS missing P0 priority'); if (!css.includes('data-priority=\"P1\"')) throw new Error('CSS missing P1 priority'); if (!css.includes('data-priority=\"P2\"')) throw new Error('CSS missing P2 priority'); if (!css.includes('data-priority=\"PX\"')) throw new Error('CSS missing PX priority'); console.log('PASS: all 4 priority badge rules present in status-colors.css');"
  </verify>
  <done>
    All 14 unit tests pass covering: priority sorting, alphabetical tie-breaking, empty directory, missing directory, invalid frontmatter filtering, filename pattern filtering, fallback ID, date coercion, unknown priorities, field completeness, detail retrieval, 404 errors, missing directory errors, and BOM handling. Priority badge CSS rules are added for P0/P1/P2/PX using data-priority attribute selectors.
  </done>
</task>
