---
phase: "13-extract-and-deduplicate"
plan: "13-02"
type: "refactor"
wave: 1
depends_on: []
files_modified:
  - "plugins/dev/skills/plan/templates/researcher-prompt.md.tmpl"
  - "plugins/dev/skills/plan/templates/planner-prompt.md.tmpl"
  - "plugins/dev/skills/plan/templates/checker-prompt.md.tmpl"
  - "plugins/dev/skills/plan/templates/revision-prompt.md.tmpl"
  - "plugins/dev/skills/plan/templates/gap-closure-prompt.md.tmpl"
  - "plugins/dev/skills/plan/SKILL.md"
autonomous: true
discovery: 0
must_haves:
  truths:
    - "plan/SKILL.md contains no inline prompt templates longer than 20 lines"
    - "All 5 prompt templates exist as external files in plan/templates/"
    - "plan/SKILL.md references each template via Read instruction with placeholder documentation"
  artifacts:
    - "plugins/dev/skills/plan/templates/researcher-prompt.md.tmpl"
    - "plugins/dev/skills/plan/templates/planner-prompt.md.tmpl"
    - "plugins/dev/skills/plan/templates/checker-prompt.md.tmpl"
    - "plugins/dev/skills/plan/templates/revision-prompt.md.tmpl"
    - "plugins/dev/skills/plan/templates/gap-closure-prompt.md.tmpl"
  key_links:
    - "plan/SKILL.md Step 4 references researcher-prompt.md.tmpl"
    - "plan/SKILL.md Step 5 references planner-prompt.md.tmpl"
    - "plan/SKILL.md Step 6 references checker-prompt.md.tmpl"
    - "plan/SKILL.md Step 7 references revision-prompt.md.tmpl"
    - "plan/SKILL.md gap closure flow references gap-closure-prompt.md.tmpl"
---

# Plan 13-02: Extract plan/SKILL.md prompt templates

This plan extracts 5 inline prompt templates from `skills/plan/SKILL.md` (~300 lines total) into external template files in `skills/plan/templates/`. The SKILL.md is updated with Read references.

<task id="13-02-T1" type="auto" tdd="false">
  <name>Create plan/templates/ directory and extract 5 prompt templates</name>
  <files>
    plugins/dev/skills/plan/templates/researcher-prompt.md.tmpl
    plugins/dev/skills/plan/templates/planner-prompt.md.tmpl
    plugins/dev/skills/plan/templates/checker-prompt.md.tmpl
    plugins/dev/skills/plan/templates/revision-prompt.md.tmpl
    plugins/dev/skills/plan/templates/gap-closure-prompt.md.tmpl
  </files>
  <action>
1. Create directory `plugins/dev/skills/plan/templates/`

2. Extract the Phase Research Prompt Template from `skills/plan/SKILL.md` lines 181-206 (content inside the code fence under "#### Phase Research Prompt Template"). Write to `skills/plan/templates/researcher-prompt.md.tmpl` with this header:
   ```
   <!-- Source: plan/SKILL.md | Purpose: Prompt template for spawning researcher agent during phase planning -->
   ```
   Then the exact content starting with `You are the towline-researcher agent operating in Phase Research mode.` through `Write your findings to .planning/phases/{NN}-{slug}/RESEARCH.md using the Phase Research output format. Use the Write tool.`

3. Extract the Planning Prompt Template from `skills/plan/SKILL.md` lines 253-319 (content inside the code fence under "#### Planning Prompt Template"). Write to `skills/plan/templates/planner-prompt.md.tmpl` with this header:
   ```
   <!-- Source: plan/SKILL.md | Purpose: Prompt template for spawning planner agent during phase planning -->
   ```
   Then the exact content starting with `You are the towline-planner agent operating in Standard Planning mode.` through `Use the Write tool to create each plan file.`
   Preserve all XML-like tags (`<phase_context>`, `<project_context>`, etc.) and placeholders (`{NN}`, `{phase name}`, etc.).

4. Extract the Checker Prompt Template from `skills/plan/SKILL.md` lines 346-367 (content inside the code fence under "#### Checker Prompt Template"). Write to `skills/plan/templates/checker-prompt.md.tmpl` with this header:
   ```
   <!-- Source: plan/SKILL.md | Purpose: Prompt template for spawning plan checker agent -->
   ```
   Then the exact content starting with `You are the towline-plan-checker agent.` through `Do NOT write any files. Return your findings as your response text.`

5. Extract the Revision Mode prompt from `skills/plan/SKILL.md` lines 387-401 (content inside the code fence in Step 7). Write to `skills/plan/templates/revision-prompt.md.tmpl` with this header:
   ```
   <!-- Source: plan/SKILL.md | Purpose: Prompt template for planner revision mode when checker finds issues -->
   ```
   Then the exact content starting with `You are the towline-planner agent operating in Revision Mode.` through the `</revision_instructions>` closing tag.

6. Extract the Gap Closure prompt from `skills/plan/SKILL.md` lines 533-549 (content inside the code fence under gap closure flow). Write to `skills/plan/templates/gap-closure-prompt.md.tmpl` with this header:
   ```
   <!-- Source: plan/SKILL.md | Purpose: Prompt template for planner gap closure mode -->
   ```
   Then the exact content starting with `You are the towline-planner agent operating in Gap Closure mode.` through `Write gap-closure plan files to: .planning/phases/{NN}-{slug}/`

IMPORTANT: Preserve exact formatting, XML tags, placeholder syntax, and indentation from the originals.
  </action>
  <verify>
ls -la plugins/dev/skills/plan/templates/
wc -l plugins/dev/skills/plan/templates/*.md.tmpl
  </verify>
  <done>
    5 template files exist in plan/templates/ with content matching the originals from plan/SKILL.md.
  </done>
</task>

<task id="13-02-T2" type="auto" tdd="false">
  <name>Update plan/SKILL.md to reference external templates</name>
  <files>
    plugins/dev/skills/plan/SKILL.md
  </files>
  <action>
1. Open `skills/plan/SKILL.md` and make these replacements:

2. **Step 4 -- Phase Research Prompt Template** (lines 178-206):
   Replace the "#### Phase Research Prompt Template" section (the heading, the code fence, and all content within) with:
   ```markdown
   #### Phase Research Prompt Template

   Read `skills/plan/templates/researcher-prompt.md.tmpl` and use it as the prompt template for spawning the researcher agent. Fill in the placeholders with phase-specific context:
   - `{NN}` - phase number (zero-padded)
   - `{phase name}` - phase name from roadmap
   - `{goal from roadmap}` - phase goal statement
   - `{REQ-IDs mapped to this phase}` - requirement IDs
   - `{dependencies from roadmap}` - dependency list
   - Inline relevant CONTEXT.md sections and prior SUMMARY.md content into the `<project_context>` block
   ```

3. **Step 5 -- Planning Prompt Template** (lines 251-319):
   Replace the "#### Planning Prompt Template" section (the heading, the code fence, and all content within) with:
   ```markdown
   #### Planning Prompt Template

   Read `skills/plan/templates/planner-prompt.md.tmpl` and use it as the prompt template for spawning the planner agent. Fill in all placeholder blocks with phase-specific context:
   - `<phase_context>` - phase number, directory, goal, requirements, dependencies, success criteria
   - `<project_context>` - locked decisions, user constraints, deferred ideas, phase-specific decisions
   - `<prior_work>` - preceding phase SUMMARY.md data (status, key files, exports, patterns)
   - `<research>` - RESEARCH.md content if it exists
   - `<config>` - max tasks, parallelization, TDD mode from config.json
   - `<planning_instructions>` - phase-specific planning rules and output path
   ```

4. **Step 6 -- Checker Prompt Template** (lines 343-367):
   Replace the "#### Checker Prompt Template" section (the heading, the code fence, and all content within) with:
   ```markdown
   #### Checker Prompt Template

   Read `skills/plan/templates/checker-prompt.md.tmpl` and use it as the prompt template for spawning the plan checker agent. Fill in the placeholders:
   - `<plans_to_check>` - inline the FULL content of each PLAN.md file in the phase directory
   - `<phase_context>` - phase goal and requirement IDs
   - `<context>` - inline project-level and phase-level CONTEXT.md files
   ```

5. **Step 7 -- Revision prompt** (lines 386-401):
   Replace the inline code fence in Step 7 (the revision prompt) with:
   ```markdown
   Read `skills/plan/templates/revision-prompt.md.tmpl` and use it as the prompt template for the revision planner. Fill in the placeholders:
   - `<original_plans>` - inline the current plan files
   - `<checker_feedback>` - inline the checker's issue report
   - `<revision_instructions>` - specific revision guidance
   ```

6. **Gap Closure flow** (lines 530-549):
   Replace the inline code fence in the gap closure section with:
   ```markdown
   Read `skills/plan/templates/gap-closure-prompt.md.tmpl` and use it as the prompt template for the gap closure planner. Fill in the placeholders:
   - `<verification_report>` - inline the FULL VERIFICATION.md content
   - `<existing_plans>` - inline all existing PLAN.md files for the phase
   - `<gap_closure_instructions>` - specify output path and gap_closure frontmatter flag
   ```

7. Preserve ALL other content in the SKILL.md (argument parsing, orchestration flow descriptions, error handling, completion section, etc.). Only the inline template code fences are being replaced.
  </action>
  <verify>
wc -l plugins/dev/skills/plan/SKILL.md
grep -c "Read \`skills/plan/templates/" plugins/dev/skills/plan/SKILL.md
awk "/^```/{start=NR; count=0; next} /^```/{if(NR-start>20) print FILENAME\": block at line \"start\" is \"(NR-start)\" lines\"; next}" plugins/dev/skills/plan/SKILL.md
  </verify>
  <done>
    plan/SKILL.md references all 5 external templates via Read instructions. The file is under 380 lines (down from 617) and all template references use Read instructions. No code-fence blocks exceed 20 lines.
  </done>
</task>
