---
phase: "13-extract-and-deduplicate"
plan: "13-05"
type: "refactor"
wave: 2
depends_on: ["13-01"]
files_modified:
  - "plugins/dev/skills/scan/SKILL.md"
  - "plugins/dev/skills/debug/templates/initial-investigation-prompt.md.tmpl"
  - "plugins/dev/skills/debug/templates/continuation-prompt.md.tmpl"
  - "plugins/dev/skills/debug/SKILL.md"
autonomous: true
discovery: 0
must_haves:
  truths:
    - "scan/SKILL.md inline format specs replaced with references to shared templates/codebase/"
    - "scan/SKILL.md contains no inline templates longer than 20 lines"
    - "debug/SKILL.md contains no inline prompt templates longer than 20 lines"
    - "2 prompt templates exist in debug/templates/"
  artifacts:
    - "plugins/dev/skills/debug/templates/initial-investigation-prompt.md.tmpl"
    - "plugins/dev/skills/debug/templates/continuation-prompt.md.tmpl"
  key_links:
    - "scan/SKILL.md agent spawn prompts reference templates/codebase/*.md.tmpl"
    - "debug/SKILL.md Step 2a references initial-investigation-prompt.md.tmpl"
    - "debug/SKILL.md Step 2b references continuation-prompt.md.tmpl"
---

# Plan 13-05: Update scan/SKILL.md references and extract debug/SKILL.md templates

This plan has two parts: (1) update scan/SKILL.md to reference the shared `templates/codebase/` templates created by Plan 13-01, removing ~350 lines of duplicated inline format specs; (2) extract 2 inline prompt templates from debug/SKILL.md (~115 lines).

**Dependency**: Plan 13-01 must complete first because scan/SKILL.md will reference the shared template files it creates.

<task id="13-05-T1" type="auto" tdd="false">
  <name>Replace scan/SKILL.md inline format specs with shared template references</name>
  <files>
    plugins/dev/skills/scan/SKILL.md
  </files>
  <action>
The scan/SKILL.md file contains 4 agent spawn prompt blocks (Agent 1-4 in Step 3) with inline document format specifications that duplicate what's now in `templates/codebase/`. Replace the inline format specs while preserving the agent instructions.

1. Open `skills/scan/SKILL.md` and locate Step 3: Spawn Analysis Agents.

2. **Agent 1: Technology Stack** (lines 119-196):
   The code fence at lines 121-196 contains both agent instructions AND inline format specs for STACK.md and INTEGRATIONS.md.

   Replace the entire code fence content with:
   ```
   You are towline-codebase-mapper with focus="tech".

   Analyze the codebase technology stack and external integrations.

   Reconnaissance: {paste RECON.md content}
   Working directory: {cwd}

   Instructions:

   1. STACK.md -- Technology inventory
      Read `templates/codebase/STACK.md.tmpl` for the output format.
      Fill in all sections based on your codebase analysis.

   2. INTEGRATIONS.md -- External connections
      Read `templates/codebase/INTEGRATIONS.md.tmpl` for the output format.
      Fill in all sections based on your codebase analysis.

   Write both files to .planning/codebase/
   ```

3. **Agent 2: Architecture** (lines 198-277):
   Replace the entire code fence content with:
   ```
   You are towline-codebase-mapper with focus="arch".

   Analyze the codebase architecture and structure.

   Reconnaissance: {paste RECON.md content}
   Working directory: {cwd}

   Instructions:

   1. ARCHITECTURE.md -- High-level architecture
      Read `templates/codebase/ARCHITECTURE.md.tmpl` for the output format.
      Fill in all sections based on your codebase analysis.

   2. STRUCTURE.md -- Directory and file organization
      Read `templates/codebase/STRUCTURE.md.tmpl` for the output format.
      Fill in all sections based on your codebase analysis.

   Write both files to .planning/codebase/
   ```

4. **Agent 3: Code Quality** (lines 279-376):
   Replace the entire code fence content with:
   ```
   You are towline-codebase-mapper with focus="quality".

   Analyze the codebase quality, conventions, and testing approach.

   Reconnaissance: {paste RECON.md content}
   Working directory: {cwd}

   Instructions:

   1. CONVENTIONS.md -- Coding standards in practice
      Read `templates/codebase/CONVENTIONS.md.tmpl` for the output format.

      IMPORTANT: Document what the codebase ACTUALLY does, not what it should do.
      Look at multiple files to identify the dominant pattern.

   2. TESTING.md -- Test infrastructure and coverage
      Read `templates/codebase/TESTING.md.tmpl` for the output format.

   Write both files to .planning/codebase/
   ```

5. **Agent 4: Concerns** (lines 378-459):
   Replace the entire code fence content with:
   ```
   You are towline-codebase-mapper with focus="concerns".

   Identify concerns, risks, and improvement opportunities in the codebase.

   Reconnaissance: {paste RECON.md content}
   Working directory: {cwd}

   Instructions:

   Write CONCERNS.md to .planning/codebase/

   Read `templates/codebase/CONCERNS.md.tmpl` for the output format.

   Analyze the codebase for:

   1. Security concerns (hardcoded secrets, injection vulnerabilities, insecure auth, missing validation, outdated deps)
   2. Technical debt (TODO/FIXME comments, dead code, duplication, complex functions, missing error handling)
   3. Scalability concerns (N+1 queries, missing pagination, unbounded data loading, blocking ops)
   4. Maintainability concerns (missing docs, complex inheritance, tight coupling, magic numbers)
   5. Operational concerns (missing health checks, insufficient logging, no monitoring, unclear deployment)
   ```

6. Preserve ALL other content in scan/SKILL.md (Core Principle, Step 1-2, Step 4-7, Scale Handling, Edge Cases, Anti-Patterns sections). Only the 4 agent spawn code fences are being modified.
  </action>
  <verify>
wc -l plugins/dev/skills/scan/SKILL.md
grep -c "templates/codebase/" plugins/dev/skills/scan/SKILL.md
awk "/^```/{start=NR; count=0; next} /^```/{if(NR-start>20) print FILENAME\": block at line \"start\" is \"(NR-start)\" lines\"; next}" plugins/dev/skills/scan/SKILL.md
  </verify>
  <done>
    scan/SKILL.md references shared templates/codebase/ templates for all 4 agent spawn prompts. The file is under 380 lines (down from 609) and no code-fence blocks exceed 20 lines.
  </done>
</task>

<task id="13-05-T2" type="auto" tdd="false">
  <name>Extract debug/SKILL.md prompt templates</name>
  <files>
    plugins/dev/skills/debug/templates/initial-investigation-prompt.md.tmpl
    plugins/dev/skills/debug/templates/continuation-prompt.md.tmpl
    plugins/dev/skills/debug/SKILL.md
  </files>
  <action>
1. Create directory `plugins/dev/skills/debug/templates/`

2. Extract the initial investigation prompt from `skills/debug/SKILL.md` lines 149-176 (content inside the code fence in Step 2a "Spawn Debugger"). Write to `skills/debug/templates/initial-investigation-prompt.md.tmpl` with this header:
   ```
   <!-- Source: debug/SKILL.md | Purpose: Prompt template for initial debugger investigation -->
   ```
   Then the exact content starting with `You are towline-debugger. Investigate the following issue systematically.` through `- INCONCLUSIVE: {findings so far, suggested next approaches}`

3. Extract the continuation prompt from `skills/debug/SKILL.md` lines 199-214 (content inside the code fence in Step 2b). Write to `skills/debug/templates/continuation-prompt.md.tmpl` with this header:
   ```
   <!-- Source: debug/SKILL.md | Purpose: Prompt template for continuing a debug investigation session -->
   ```
   Then the exact content starting with `You are towline-debugger. Continue investigating the following issue.` through `6. Return: ROOT_CAUSE_FOUND, CHECKPOINT, or INCONCLUSIVE`

4. Update `skills/debug/SKILL.md`:

   a. **Step 2a -- Spawn Debugger** (lines 147-176):
      Replace the "#### Spawn Debugger" heading's code fence with:
      ```markdown
      #### Spawn Debugger

      Read `skills/debug/templates/initial-investigation-prompt.md.tmpl` and use it as the prompt template for the initial debugger investigation. Fill in the placeholders:
      - `{NNN}-{slug}` - the debug session identifier
      - `{expected}` - expected behavior from symptom gathering
      - `{actual}` - actual behavior
      - `{steps}` - reproduction steps
      - `{onset}` - when the issue started
      - `{scope}` - scope of the issue
      ```

   b. **Step 2b -- Resume Flow** (lines 196-214):
      Replace the code fence in Step 2b item 4 with:
      ```markdown
      Read `skills/debug/templates/continuation-prompt.md.tmpl` and use it as the prompt template for continuing the investigation. Fill in the placeholders:
      - `{NNN}-{slug}` - the debug session identifier
      - `{paste investigation log and hypotheses from the debug file}` - prior findings
      ```

5. Preserve ALL other content in debug/SKILL.md (Step 1, Step 3 result handling, Debugger Investigation Protocol, Debug File Management, State Integration, Edge Cases, Anti-Patterns).
  </action>
  <verify>
ls -la plugins/dev/skills/debug/templates/
wc -l plugins/dev/skills/debug/SKILL.md
grep -c "Read \`skills/debug/templates/" plugins/dev/skills/debug/SKILL.md
awk "/^```/{start=NR; count=0; next} /^```/{if(NR-start>20) print FILENAME\": block at line \"start\" is \"(NR-start)\" lines\"; next}" plugins/dev/skills/debug/SKILL.md
  </verify>
  <done>
    debug/templates/ contains 2 prompt template files. debug/SKILL.md references both via Read instructions, is under 390 lines (down from 429), and no code-fence blocks exceed 20 lines.
  </done>
</task>
