---
phase: "13-extract-and-deduplicate"
plan: "13-01"
type: "refactor"
wave: 1
depends_on: []
files_modified:
  - "plugins/dev/templates/codebase/STACK.md.tmpl"
  - "plugins/dev/templates/codebase/INTEGRATIONS.md.tmpl"
  - "plugins/dev/templates/codebase/ARCHITECTURE.md.tmpl"
  - "plugins/dev/templates/codebase/STRUCTURE.md.tmpl"
  - "plugins/dev/templates/codebase/CONVENTIONS.md.tmpl"
  - "plugins/dev/templates/codebase/TESTING.md.tmpl"
  - "plugins/dev/templates/codebase/CONCERNS.md.tmpl"
  - "plugins/dev/agents/towline-codebase-mapper.md"
autonomous: true
discovery: 0
must_haves:
  truths:
    - "Shared templates/codebase/ directory exists with 7 document format templates"
    - "Agent definition references external templates via Read instructions instead of inline content"
    - "Template content is byte-identical to the original inline content (minus code fence wrappers)"
  artifacts:
    - "plugins/dev/templates/codebase/STACK.md.tmpl"
    - "plugins/dev/templates/codebase/INTEGRATIONS.md.tmpl"
    - "plugins/dev/templates/codebase/ARCHITECTURE.md.tmpl"
    - "plugins/dev/templates/codebase/STRUCTURE.md.tmpl"
    - "plugins/dev/templates/codebase/CONVENTIONS.md.tmpl"
    - "plugins/dev/templates/codebase/TESTING.md.tmpl"
    - "plugins/dev/templates/codebase/CONCERNS.md.tmpl"
  key_links:
    - "Agent definition instructs agents to Read each template file for their output format"
    - "Plan 13-05 (scan/SKILL.md) references these shared templates after 13-01 completes"
---

# Plan 13-01: Extract codebase-mapper agent templates to shared templates/codebase/

This plan extracts 7 document format templates from `agents/towline-codebase-mapper.md` (lines 114-788, approximately 680 lines) into the shared `templates/codebase/` directory. The agent definition is updated to reference these external files via Read instructions.

Note: The codebase-mapper agent produces 7 document types (STACK, INTEGRATIONS, ARCHITECTURE, STRUCTURE, CONVENTIONS, TESTING, CONCERNS). There is no README template in the agent definition.

<task id="13-01-T1" type="auto" tdd="false">
  <name>Create shared templates/codebase/ directory with 4 tech/arch templates</name>
  <files>
    plugins/dev/templates/codebase/STACK.md.tmpl
    plugins/dev/templates/codebase/INTEGRATIONS.md.tmpl
    plugins/dev/templates/codebase/ARCHITECTURE.md.tmpl
    plugins/dev/templates/codebase/STRUCTURE.md.tmpl
  </files>
  <action>
1. Create directory `plugins/dev/templates/codebase/` (the parent `plugins/dev/templates/` already exists with CONTEXT.md.tmpl, SUMMARY.md.tmpl, etc.)

2. Extract STACK.md template from `agents/towline-codebase-mapper.md` lines 114-192 (the content inside the markdown code fence under "### STACK.md Template"). Write to `plugins/dev/templates/codebase/STACK.md.tmpl` with this header:
   ```
   <!-- Source: agents/towline-codebase-mapper.md | Purpose: Output format for STACK.md codebase analysis -->
   ```
   Then the exact template content from inside the code fence (starting with `# Technology Stack` and ending with the last `| {others} | {command} | {purpose} |` line).

3. Extract INTEGRATIONS.md template from `agents/towline-codebase-mapper.md` lines 196-274 (the content inside the markdown code fence under "### INTEGRATIONS.md Template"). Write to `plugins/dev/templates/codebase/INTEGRATIONS.md.tmpl` with this header:
   ```
   <!-- Source: agents/towline-codebase-mapper.md | Purpose: Output format for INTEGRATIONS.md codebase analysis -->
   ```
   Then the exact template content from inside the code fence (starting with `# External Integrations` and ending with the Infrastructure section).

4. Extract ARCHITECTURE.md template from `agents/towline-codebase-mapper.md` lines 282-380 (the content inside the markdown code fence under "### ARCHITECTURE.md Template"). Write to `plugins/dev/templates/codebase/ARCHITECTURE.md.tmpl` with this header:
   ```
   <!-- Source: agents/towline-codebase-mapper.md | Purpose: Output format for ARCHITECTURE.md codebase analysis -->
   ```
   Then the exact template content from inside the code fence (starting with `# Architecture` and ending with the Security Architecture section).

5. Extract STRUCTURE.md template from `agents/towline-codebase-mapper.md` lines 384-464 (the content inside the markdown code fence under "### STRUCTURE.md Template"). Write to `plugins/dev/templates/codebase/STRUCTURE.md.tmpl` with this header:
   ```
   <!-- Source: agents/towline-codebase-mapper.md | Purpose: Output format for STRUCTURE.md codebase analysis -->
   ```
   Then the exact template content from inside the code fence (starting with `# Project Structure` and ending with the "Where to Add Code" section).

IMPORTANT: Preserve exact formatting, placeholder syntax (`{like_this}`), and indentation from the originals. Do NOT modify the template content in any way.
  </action>
  <verify>
ls -la plugins/dev/templates/codebase/STACK.md.tmpl plugins/dev/templates/codebase/INTEGRATIONS.md.tmpl plugins/dev/templates/codebase/ARCHITECTURE.md.tmpl plugins/dev/templates/codebase/STRUCTURE.md.tmpl
wc -l plugins/dev/templates/codebase/STACK.md.tmpl plugins/dev/templates/codebase/INTEGRATIONS.md.tmpl plugins/dev/templates/codebase/ARCHITECTURE.md.tmpl plugins/dev/templates/codebase/STRUCTURE.md.tmpl
  </verify>
  <done>
    4 template files exist in plugins/dev/templates/codebase/ with content matching the originals from towline-codebase-mapper.md.
  </done>
</task>

<task id="13-01-T2" type="auto" tdd="false">
  <name>Create 3 quality/concerns templates and update agent definition</name>
  <files>
    plugins/dev/templates/codebase/CONVENTIONS.md.tmpl
    plugins/dev/templates/codebase/TESTING.md.tmpl
    plugins/dev/templates/codebase/CONCERNS.md.tmpl
    plugins/dev/agents/towline-codebase-mapper.md
  </files>
  <action>
1. Extract CONVENTIONS.md template from `agents/towline-codebase-mapper.md` lines 472-576 (the content inside the markdown code fence under "### CONVENTIONS.md Template"). Write to `plugins/dev/templates/codebase/CONVENTIONS.md.tmpl` with this header:
   ```
   <!-- Source: agents/towline-codebase-mapper.md | Purpose: Output format for CONVENTIONS.md codebase analysis -->
   ```
   Then the exact template content (starting with `# Code Conventions` through Git Conventions).

2. Extract TESTING.md template from `agents/towline-codebase-mapper.md` lines 580-687 (the content inside the markdown code fence under "### TESTING.md Template"). Write to `plugins/dev/templates/codebase/TESTING.md.tmpl` with this header:
   ```
   <!-- Source: agents/towline-codebase-mapper.md | Purpose: Output format for TESTING.md codebase analysis -->
   ```
   Then the exact template content (starting with `# Testing Infrastructure` through Testing Gaps).

3. Extract CONCERNS.md template from `agents/towline-codebase-mapper.md` lines 695-788 (the content inside the markdown code fence under "### CONCERNS.md Template"). Write to `plugins/dev/templates/codebase/CONCERNS.md.tmpl` with this header:
   ```
   <!-- Source: agents/towline-codebase-mapper.md | Purpose: Output format for CONCERNS.md codebase analysis -->
   ```
   Then the exact template content (starting with `# Concerns & Technical Debt` through Recommendations).

4. The codebase-mapper agent has NO README template. The agent handles 7 document types: STACK, INTEGRATIONS, ARCHITECTURE, STRUCTURE, CONVENTIONS, TESTING, CONCERNS. Do NOT create a README.md.tmpl file.

5. Update `agents/towline-codebase-mapper.md`:
   - In the "Focus: `tech`" section (around lines 110-275), replace the inline STACK.md Template code fence with:
     ```
     ### STACK.md Template

     Read the document template from `templates/codebase/STACK.md.tmpl` and use it as the format for your STACK.md output. Fill in all placeholder fields with data from your codebase analysis.
     ```
   - Replace the inline INTEGRATIONS.md Template code fence with:
     ```
     ### INTEGRATIONS.md Template

     Read the document template from `templates/codebase/INTEGRATIONS.md.tmpl` and use it as the format for your INTEGRATIONS.md output. Fill in all placeholder fields with data from your codebase analysis.
     ```
   - In the "Focus: `arch`" section (around lines 278-465), replace the inline ARCHITECTURE.md Template code fence with:
     ```
     ### ARCHITECTURE.md Template

     Read the document template from `templates/codebase/ARCHITECTURE.md.tmpl` and use it as the format for your ARCHITECTURE.md output. Fill in all placeholder fields with data from your codebase analysis.
     ```
   - Replace the inline STRUCTURE.md Template code fence with:
     ```
     ### STRUCTURE.md Template

     Read the document template from `templates/codebase/STRUCTURE.md.tmpl` and use it as the format for your STRUCTURE.md output. Fill in all placeholder fields with data from your codebase analysis.
     ```
   - In the "Focus: `quality`" section (around lines 468-688), replace the inline CONVENTIONS.md Template code fence with:
     ```
     ### CONVENTIONS.md Template

     Read the document template from `templates/codebase/CONVENTIONS.md.tmpl` and use it as the format for your CONVENTIONS.md output. Fill in all placeholder fields with data from your codebase analysis.
     ```
   - Replace the inline TESTING.md Template code fence with:
     ```
     ### TESTING.md Template

     Read the document template from `templates/codebase/TESTING.md.tmpl` and use it as the format for your TESTING.md output. Fill in all placeholder fields with data from your codebase analysis.
     ```
   - In the "Focus: `concerns`" section (around lines 690-789), replace the inline CONCERNS.md Template code fence with:
     ```
     ### CONCERNS.md Template

     Read the document template from `templates/codebase/CONCERNS.md.tmpl` and use it as the format for your CONCERNS.md output. Fill in all placeholder fields with data from your codebase analysis.
     ```
   - Preserve ALL other content in the agent definition (exploration process, quality standards, anti-patterns, etc.)

6. After updating, verify the agent file is well-formed markdown and the Read instructions reference correct file paths relative to the plugin root.
  </action>
  <verify>
ls -la plugins/dev/templates/codebase/CONVENTIONS.md.tmpl plugins/dev/templates/codebase/TESTING.md.tmpl plugins/dev/templates/codebase/CONCERNS.md.tmpl
wc -l plugins/dev/agents/towline-codebase-mapper.md
grep -c "Read the document template from" plugins/dev/agents/towline-codebase-mapper.md
  </verify>
  <done>
    7 template files exist in templates/codebase/ (STACK, INTEGRATIONS, ARCHITECTURE, STRUCTURE, CONVENTIONS, TESTING, CONCERNS). The agent definition references all 7 via Read instructions. The agent file is significantly shorter than the original 894 lines (expected ~250-300 lines after extraction).
  </done>
</task>
