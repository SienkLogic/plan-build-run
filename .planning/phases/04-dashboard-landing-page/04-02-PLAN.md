---
phase: "04-dashboard-landing-page"
plan: "04-02"
type: "feature"
wave: 2
depends_on: ["04-01"]
files_modified:
  - "src/views/index.ejs"
  - "src/routes/index.routes.js"
autonomous: true
discovery: 0
must_haves:
  truths:
    - "Dashboard landing page shows project name and current phase from STATE.md"
    - "Dashboard renders a list of all phases with status badges from ROADMAP.md"
    - "Dashboard displays overall progress percentage with an HTML5 progress bar"
    - "Dashboard shows last activity date and description"
    - "Missing STATE.md displays graceful fallback (project name 'Unknown Project', progress 0%)"
    - "Missing ROADMAP.md displays graceful fallback (empty phase list with message)"
  artifacts:
    - "src/views/index.ejs (replaced with real dashboard content)"
    - "src/routes/index.routes.js (updated to call getDashboardData)"
  key_links:
    - "index.routes.js imports getDashboardData from dashboard.service.js"
    - "index.routes.js passes dashboard data to index.ejs template"
    - "index.ejs uses data-status attributes on status-badge spans (wired to status-colors.css from Phase 03)"
    - "index.ejs uses HTML5 progress element (styled by Pico.css from Phase 03)"
---

# Plan 04-02: Dashboard Template and Route Wiring

## Summary

Replace the placeholder index.ejs template with a real dashboard that displays project
overview data (project name, current phase, progress bar, phase list with status badges).
Update the index route to call `getDashboardData()` from the dashboard service created
in Plan 04-01 and pass the data to the template.

The template uses:
- Pico.css semantic HTML (`<article>`, `<progress>`, `<table>`)
- Status badges with `data-status` attribute (wired to status-colors.css from Phase 03)
- `<%= %>` for all user-sourced text (auto-escapes HTML)
- `<%- content %>` only for README HTML from marked (trusted)

## Tasks

<task id="04-02-T1" type="auto">
  <name>Replace index.ejs with dashboard template displaying project data</name>
  <files>
    src/views/index.ejs
  </files>
  <action>
1. Open `src/views/index.ejs` and REPLACE its entire contents with the dashboard template below.

2. The new template structure:

```ejs
<%- include('partials/layout-top', { title: title, activePage: 'dashboard' }) %>

<h1><%= projectName %></h1>

<!-- Project Overview Card -->
<article>
  <header>
    <strong>Current Phase</strong>
  </header>
  <% if (currentPhase.id > 0) { %>
    <p>
      <span class="status-badge" data-status="in-progress">Phase <%= currentPhase.id %></span>
      <%= currentPhase.name %>
    </p>
    <p><small><%= currentPhase.planStatus %></small></p>
  <% } else { %>
    <p>No active phase. Project has not started yet.</p>
  <% } %>

  <% if (lastActivity.date) { %>
    <p><small>Last activity: <%= lastActivity.date %> &mdash; <%= lastActivity.description %></small></p>
  <% } %>
</article>

<!-- Overall Progress -->
<article>
  <header>
    <strong>Overall Progress</strong>
  </header>
  <progress value="<%= progress %>" max="100"></progress>
  <p><%= progress %>% complete (<%= phases.filter(p => p.status === 'complete').length %> of <%= phases.length %> phases)</p>
</article>

<!-- Phase List -->
<article>
  <header>
    <strong>All Phases</strong>
  </header>
  <% if (phases.length > 0) { %>
    <table>
      <thead>
        <tr>
          <th scope="col">Phase</th>
          <th scope="col">Name</th>
          <th scope="col">Description</th>
          <th scope="col">Status</th>
        </tr>
      </thead>
      <tbody>
        <% phases.forEach(function(phase) { %>
        <tr>
          <td><%= String(phase.id).padStart(2, '0') %></td>
          <td><%= phase.name %></td>
          <td><%= phase.description %></td>
          <td>
            <span class="status-badge" data-status="<%= phase.status %>">
              <%= phase.status.replace('-', ' ') %>
            </span>
          </td>
        </tr>
        <% }); %>
      </tbody>
    </table>
  <% } else { %>
    <p>No phases found. Add a ROADMAP.md file to your .planning/ directory to see phases here.</p>
  <% } %>
</article>

<!-- README Content (if available) -->
<% if (content && content !== '<p>No project README found.</p>') { %>
<article>
  <header>
    <strong>Project Notes</strong>
  </header>
  <%- content %>
</article>
<% } %>

<%- include('partials/layout-bottom') %>
```

3. Key template decisions:
   - All phase data uses `<%= %>` (auto-escaped) since it comes from user markdown files
   - `<%- content %>` is used ONLY for the README HTML rendered by marked (established pattern)
   - `<table>` is used for the phase list (Pico.css styles tables semantically)
   - `<progress>` is the native HTML5 element (Pico.css styles it automatically)
   - Phase number is zero-padded with `String(phase.id).padStart(2, '0')`
   - Status badge text replaces hyphens with spaces: `'in-progress'` displays as `'in progress'`
   - Empty phases array shows a helpful message directing user to create ROADMAP.md
   - README content section only shows if content exists and is not the fallback message
   - The `currentPhase.id > 0` check differentiates between real phase data and fallback
  </action>
  <verify>
    node -e "const fs = require('fs'); const c = fs.readFileSync('D:/Repos/towline-test-project/src/views/index.ejs','utf-8'); console.log(c.includes('progress') && c.includes('data-status') && c.includes('phases.forEach') ? 'PASS: template has dashboard elements' : 'FAIL')"
  </verify>
  <done>
    index.ejs displays project name, current phase with status badge, progress bar with percentage, phase list table with status badges, and README content section -- replacing the old placeholder content
  </done>
</task>

<task id="04-02-T2" type="auto">
  <name>Update index route to fetch and pass dashboard data to template</name>
  <files>
    src/routes/index.routes.js
  </files>
  <action>
1. Open `src/routes/index.routes.js`

2. Add import for getDashboardData:
   ```javascript
   import { getDashboardData } from '../services/dashboard.service.js';
   ```
   Keep the existing import of `getHomepage` from `project.service.js`.

3. Update the GET `/` route handler to call both services and merge data:
   ```javascript
   router.get('/', async (req, res) => {
     const projectDir = req.app.locals.projectDir;

     const [homepageData, dashboardData] = await Promise.all([
       getHomepage(projectDir),
       getDashboardData(projectDir)
     ]);

     res.render('index', {
       ...homepageData,
       ...dashboardData,
       activePage: 'dashboard'
     });
   });
   ```

4. The spread order matters: `homepageData` provides `title`, `projectDir`, `content`.
   `dashboardData` provides `projectName`, `currentPhase`, `lastActivity`, `progress`, `phases`.
   No field name collisions exist between the two objects.

5. Express 5.x auto-catches async errors from the route handler, so no try-catch wrapper is needed.
   If both service calls fail, the error handler middleware will render the error page.
  </action>
  <verify>
    node -e "const fs = require('fs'); const c = fs.readFileSync('D:/Repos/towline-test-project/src/routes/index.routes.js','utf-8'); console.log(c.includes('getDashboardData') && c.includes('Promise.all') ? 'PASS: route calls dashboard service' : 'FAIL')"
  </verify>
  <done>
    GET / route fetches both homepage content and dashboard data in parallel, passing combined data to the template so the dashboard displays project overview, phase list, and progress
  </done>
</task>
