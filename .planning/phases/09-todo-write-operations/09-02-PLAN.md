---
phase: "09-todo-write-operations"
plan: "09-02"
type: "feature"
wave: 2
depends_on: ["09-01"]
files_modified:
  - "src/views/todo-create.ejs"
  - "src/views/todos.ejs"
  - "src/views/todo-detail.ejs"
  - "src/routes/pages.routes.js"
autonomous: true
discovery: 0
must_haves:
  truths:
    - "User can fill out a form with title, priority, phase, and description to create a new todo"
    - "POST /todos creates the todo and redirects to the new todo's detail page"
    - "User can click 'Mark as Done' on a todo detail page to complete it"
    - "POST /todos/:id/done marks the todo done and redirects to the todos list"
    - "'Create Todo' link is visible on the todos list page"
    - "'Mark as Done' button is visible on pending todo detail pages"
  artifacts:
    - "src/views/todo-create.ejs"
    - "src/views/todos.ejs (updated with Create Todo link)"
    - "src/views/todo-detail.ejs (updated with Mark as Done form)"
    - "src/routes/pages.routes.js (updated with POST routes)"
  key_links:
    - "POST /todos route calls createTodo from todo.service.js"
    - "POST /todos/:id/done route calls completeTodo from todo.service.js"
    - "todos.ejs links to /todos/new for the creation form"
    - "todo-detail.ejs form posts to /todos/:id/done"
---

# Plan 09-02: Todo Create Form, Routes, and UI Wiring

## Overview

Create the todo creation form template, wire the POST routes for creating and completing todos, and add the "Create Todo" link and "Mark as Done" button to the existing templates. Uses POST (not PUT) for the mark-as-done action since HTML forms only support GET and POST.

**Important ordering note**: The `GET /todos/new` route MUST be registered BEFORE the `GET /todos/:id` route, otherwise Express will interpret "new" as an `:id` parameter and try to look up a todo with ID "new".

---

<task id="09-02-T1" type="auto">
  <name>Create todo-create.ejs form template</name>
  <files>
    src/views/todo-create.ejs
  </files>
  <action>
1. Create new file `src/views/todo-create.ejs` with the following content:
   ```ejs
   <%- include('partials/layout-top', { title: 'Create Todo', activePage: 'todos' }) %>

   <h1>Create Todo</h1>

   <p><a href="/todos">&larr; Back to Todos</a></p>

   <article>
     <form method="POST" action="/todos">
       <label>
         Title
         <input
           type="text"
           name="title"
           placeholder="Todo title"
           required
           maxlength="200"
         />
       </label>

       <label>
         Priority
         <select name="priority" required>
           <option value="">Select priority...</option>
           <option value="P0">P0 - Critical</option>
           <option value="P1">P1 - High</option>
           <option value="P2">P2 - Medium</option>
           <option value="PX">PX - Low</option>
         </select>
       </label>

       <label>
         Phase (optional)
         <input
           type="text"
           name="phase"
           placeholder="e.g., 09-todo-write-operations"
         />
         <small>Format: 01-phase-name</small>
       </label>

       <label>
         Description
         <textarea
           name="description"
           rows="10"
           required
           placeholder="Markdown content..."
         ></textarea>
       </label>

       <button type="submit">Create Todo</button>
     </form>
   </article>

   <%- include('partials/layout-bottom') %>
   ```

   Notes:
   - Uses Pico.css semantic styling (no custom classes needed on form elements)
   - `required` attribute on title, priority, and description for client-side validation
   - `maxlength="200"` on title to prevent overly long filenames
   - Phase field is optional (no `required` attribute)
   - `<small>` element provides format hint for the phase field (Pico.css styles this as helper text)
  </action>
  <verify>
    ls D:/Repos/towline-test-project/src/views/todo-create.ejs
  </verify>
  <done>
    The todo-create.ejs template exists and contains a form with title input, priority select, phase input, and description textarea, all posting to /todos.
  </done>
</task>

<task id="09-02-T2" type="auto">
  <name>Wire POST routes and update existing templates with action links</name>
  <files>
    src/routes/pages.routes.js
    src/views/todos.ejs
    src/views/todo-detail.ejs
  </files>
  <action>
1. Open `src/routes/pages.routes.js`

2. Update the import from `todo.service.js` on line 4 to include the new functions:
   ```javascript
   import { listPendingTodos, getTodoDetail, createTodo, completeTodo } from '../services/todo.service.js';
   ```

3. Add a GET route for the creation form. This MUST be placed BEFORE the existing `router.get('/todos/:id', ...)` route (which is on line 46). Insert it after the `router.get('/todos', ...)` block (after line 43) and before the `router.get('/todos/:id', ...)` block:
   ```javascript
   router.get('/todos/new', (req, res) => {
     res.render('todo-create', {
       title: 'Create Todo',
       activePage: 'todos'
     });
   });
   ```

4. Add the POST route for creating a todo. Insert it after the `router.get('/todos/:id', ...)` block (after line 63):
   ```javascript
   router.post('/todos', async (req, res) => {
     const { title, priority, phase, description } = req.body;
     const projectDir = req.app.locals.projectDir;

     const todoId = await createTodo(projectDir, {
       title,
       priority,
       phase: phase || '',
       description
     });

     res.redirect(`/todos/${todoId}`);
   });
   ```

5. Add the POST route for marking a todo as done. Insert it after the POST /todos route:
   ```javascript
   router.post('/todos/:id/done', async (req, res) => {
     const { id } = req.params;

     if (!/^\d{3}$/.test(id)) {
       const err = new Error('Todo ID must be a three-digit number');
       err.status = 404;
       throw err;
     }

     const projectDir = req.app.locals.projectDir;
     await completeTodo(projectDir, id);

     res.redirect('/todos');
   });
   ```

6. Open `src/views/todos.ejs`

7. Add a "Create Todo" link after the `<h1>` tag on line 3. Replace line 3:
   From:
   ```html
   <h1>Todos</h1>
   ```
   To:
   ```html
   <h1>Todos</h1>

   <p><a href="/todos/new" role="button">Create Todo</a></p>
   ```
   Note: `role="button"` makes Pico.css style the link as a button.

8. Open `src/views/todo-detail.ejs`

9. Add a "Mark as Done" form after the `<hr>` and content section, but only when the todo status is "pending". Insert after the `<%- html %>` line (line 29) and before the closing `</article>` tag (line 30):
   ```ejs

     <% if (status === 'pending') { %>
     <hr>
     <form method="POST" action="/todos/<%= id %>/done" style="display:inline;">
       <button type="submit" class="secondary">Mark as Done</button>
     </form>
     <% } %>
   ```
   Note: Uses `class="secondary"` for Pico.css secondary button styling to visually distinguish from primary actions. The `style="display:inline"` prevents the form from taking full width.
  </action>
  <verify>
    npx --prefix D:/Repos/towline-test-project vitest run --reporter=verbose tests/services/todo.service.test.js
  </verify>
  <done>
    The todos list page shows a "Create Todo" button linking to the creation form. The todo detail page shows a "Mark as Done" button for pending todos. POST /todos creates a todo and redirects to its detail page. POST /todos/:id/done marks a todo done and redirects to the todos list.
  </done>
</task>
