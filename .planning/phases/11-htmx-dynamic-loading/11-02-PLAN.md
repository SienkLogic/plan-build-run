---
phase: "11-htmx-dynamic-loading"
plan: "11-02"
type: "feature"
wave: 2
depends_on: ["11-01"]
files_modified:
  - "src/routes/index.routes.js"
  - "src/routes/pages.routes.js"
  - "src/views/partials/layout-bottom.ejs"
  - "src/views/partials/footer.ejs"
  - "public/js/sse-client.js"
  - "src/views/partials/todo-detail-content.ejs"
  - "src/views/partials/todos-content.ejs"
  - "src/views/partials/todo-create-content.ejs"
  - "src/views/todo-create.ejs"
autonomous: true
discovery: 0
must_haves:
  truths:
    - "All GET page routes check req.get('HX-Request') and return content partial (fragment) when true"
    - "All GET page routes set Vary: HX-Request response header for HTTP cache correctness"
    - "POST /todos returns redirect for normal requests, renders todo-detail-content partial for HTMX requests"
    - "POST /todos/:id/done returns redirect for normal requests, renders todos-content partial for HTMX requests"
    - "HTMX SSE extension replaces custom sse-client.js for file-change triggered content refresh"
    - "Todo detail Mark as Done button uses hx-post for in-place update"
    - "Todo create form uses hx-post for submission without full page reload"
    - "SSE file-change events trigger an hx-get on the current content area to refresh it"
  artifacts:
    - "src/routes/index.routes.js updated with HX-Request detection and Vary header"
    - "src/routes/pages.routes.js updated with HX-Request detection for all GET and POST handlers"
    - "src/views/partials/layout-bottom.ejs updated to use HTMX SSE extension instead of sse-client.js"
    - "src/views/partials/footer.ejs updated with SSE connection indicator driven by HTMX"
    - "public/js/sse-client.js deleted (replaced by HTMX SSE extension)"
    - "src/views/partials/todo-detail-content.ejs updated with hx-post on Mark as Done form"
    - "src/views/partials/todos-content.ejs updated with hx-get on Create Todo link"
    - "src/views/partials/todo-create-content.ejs created with hx-post on form"
    - "src/views/todo-create.ejs updated to use todo-create-content partial"
  key_links:
    - "Route handlers import and render content partials from src/views/partials/*-content.ejs"
    - "layout-bottom.ejs loads HTMX SSE extension attributes instead of sse-client.js script"
    - "HTMX SSE sse-connect points to /api/events/stream (existing SSE endpoint)"
    - "HTMX SSE file-change event triggers hx-get to refresh current page content"
---

# Plan 11-02: Route Fragment Rendering, Todo HTMX Forms, and SSE Extension Migration

## Overview

Update all route handlers to detect the HX-Request header and return content partials
(fragments) instead of full pages when serving HTMX requests. Add HTMX attributes to
todo forms for in-place operations. Replace the custom sse-client.js with HTMX SSE
extension attributes for live content refresh on file changes.

This plan depends on Plan 11-01 which created the content partials and HTMX CDN tags.

## Tasks

<task id="11-02-T1" type="auto">
  <name>Update all route handlers with HX-Request fragment detection and Vary header</name>
  <files>
    src/routes/index.routes.js
    src/routes/pages.routes.js
    src/views/partials/todo-create-content.ejs
    src/views/todo-create.ejs
  </files>
  <action>
1. Open `src/routes/index.routes.js` and update the GET / handler to detect
   HX-Request and return either the full page or the content fragment.

   Replace the entire file with:
   ```javascript
   import { Router } from 'express';
   import { getHomepage } from '../services/project.service.js';
   import { getDashboardData } from '../services/dashboard.service.js';

   const router = Router();

   router.get('/', async (req, res) => {
     const projectDir = req.app.locals.projectDir;

     const [homepageData, dashboardData] = await Promise.all([
       getHomepage(projectDir),
       getDashboardData(projectDir)
     ]);

     const templateData = {
       ...homepageData,
       ...dashboardData,
       activePage: 'dashboard'
     };

     res.setHeader('Vary', 'HX-Request');

     if (req.get('HX-Request') === 'true') {
       res.render('partials/dashboard-content', templateData);
     } else {
       res.render('index', templateData);
     }
   });

   export default router;
   ```

2. Open `src/routes/pages.routes.js` and update ALL handlers to detect HX-Request.

   Replace the entire file with:
   ```javascript
   import { Router } from 'express';
   import { getPhaseDetail } from '../services/phase.service.js';
   import { getRoadmapData } from '../services/roadmap.service.js';
   import { listPendingTodos, getTodoDetail, createTodo, completeTodo } from '../services/todo.service.js';

   const router = Router();

   router.get('/phases', (req, res) => {
     const templateData = {
       title: 'Phases',
       activePage: 'phases',
       featureName: 'Phases'
     };

     res.setHeader('Vary', 'HX-Request');

     if (req.get('HX-Request') === 'true') {
       // coming-soon page has no content partial -- render inline fragment
       res.send('<h1>Phases</h1><p>This feature is coming soon.</p><p>The <strong>Phases</strong> view is planned but not yet implemented. Check back in a future phase.</p><p><a href="/">Back to Dashboard</a></p>');
     } else {
       res.render('coming-soon', templateData);
     }
   });

   router.get('/phases/:phaseId', async (req, res) => {
     const { phaseId } = req.params;

     // Validate phaseId is exactly two digits
     if (!/^\d{2}$/.test(phaseId)) {
       const err = new Error('Phase ID must be a two-digit number (e.g., 01, 05, 12)');
       err.status = 404;
       throw err;
     }

     const projectDir = req.app.locals.projectDir;
     const phaseData = await getPhaseDetail(projectDir, phaseId);

     const templateData = {
       title: `Phase ${phaseId}: ${phaseData.phaseName}`,
       activePage: 'phases',
       ...phaseData
     };

     res.setHeader('Vary', 'HX-Request');

     if (req.get('HX-Request') === 'true') {
       res.render('partials/phase-content', templateData);
     } else {
       res.render('phase-detail', templateData);
     }
   });

   router.get('/todos', async (req, res) => {
     const projectDir = req.app.locals.projectDir;
     const todos = await listPendingTodos(projectDir);

     const templateData = {
       title: 'Todos',
       activePage: 'todos',
       todos
     };

     res.setHeader('Vary', 'HX-Request');

     if (req.get('HX-Request') === 'true') {
       res.render('partials/todos-content', templateData);
     } else {
       res.render('todos', templateData);
     }
   });

   router.get('/todos/new', (req, res) => {
     const templateData = {
       title: 'Create Todo',
       activePage: 'todos'
     };

     res.setHeader('Vary', 'HX-Request');

     if (req.get('HX-Request') === 'true') {
       res.render('partials/todo-create-content', templateData);
     } else {
       res.render('todo-create', templateData);
     }
   });

   router.get('/todos/:id', async (req, res) => {
     const { id } = req.params;

     // Validate ID format: must be exactly three digits
     if (!/^\d{3}$/.test(id)) {
       const err = new Error('Todo ID must be a three-digit number (e.g., 001, 005, 042)');
       err.status = 404;
       throw err;
     }

     const projectDir = req.app.locals.projectDir;
     const todo = await getTodoDetail(projectDir, id);

     const templateData = {
       title: `Todo ${todo.id}: ${todo.title}`,
       activePage: 'todos',
       ...todo
     };

     res.setHeader('Vary', 'HX-Request');

     if (req.get('HX-Request') === 'true') {
       res.render('partials/todo-detail-content', templateData);
     } else {
       res.render('todo-detail', templateData);
     }
   });

   router.post('/todos', async (req, res) => {
     const { title, priority, phase, description } = req.body;
     const projectDir = req.app.locals.projectDir;

     const todoId = await createTodo(projectDir, {
       title,
       priority,
       phase: phase || '',
       description
     });

     if (req.get('HX-Request') === 'true') {
       // For HTMX: fetch the new todo and render its detail as a fragment
       const todo = await getTodoDetail(projectDir, todoId);
       res.render('partials/todo-detail-content', {
         title: `Todo ${todo.id}: ${todo.title}`,
         activePage: 'todos',
         ...todo
       });
     } else {
       res.redirect(`/todos/${todoId}`);
     }
   });

   router.post('/todos/:id/done', async (req, res) => {
     const { id } = req.params;

     if (!/^\d{3}$/.test(id)) {
       const err = new Error('Todo ID must be a three-digit number');
       err.status = 404;
       throw err;
     }

     const projectDir = req.app.locals.projectDir;
     await completeTodo(projectDir, id);

     if (req.get('HX-Request') === 'true') {
       // For HTMX: re-render the full todo list as a fragment
       const todos = await listPendingTodos(projectDir);
       res.render('partials/todos-content', {
         title: 'Todos',
         activePage: 'todos',
         todos
       });
     } else {
       res.redirect('/todos');
     }
   });

   router.get('/roadmap', async (req, res) => {
     const projectDir = req.app.locals.projectDir;
     const roadmapData = await getRoadmapData(projectDir);

     const templateData = {
       title: 'Roadmap',
       activePage: 'roadmap',
       phases: roadmapData.phases
     };

     res.setHeader('Vary', 'HX-Request');

     if (req.get('HX-Request') === 'true') {
       res.render('partials/roadmap-content', templateData);
     } else {
       res.render('roadmap', templateData);
     }
   });

   export default router;
   ```

   Key points:
   - Every GET handler sets `Vary: HX-Request` header (critical for cache correctness)
   - Every GET handler checks `req.get('HX-Request') === 'true'`
   - Fragment response renders the `partials/*-content` partial (no layout wrapper)
   - POST /todos returns the new todo detail fragment for HTMX, redirect for regular
   - POST /todos/:id/done returns the refreshed todo list fragment for HTMX, redirect for regular
   - The /phases coming-soon route uses res.send() for its inline HTML fragment
     (no content partial exists for this placeholder page)
   - The /todos/new route references `partials/todo-create-content` -- this partial
     must be created (see note below)

   **Important**: The /todos/new route needs a `todo-create-content.ejs` partial.
   Create `src/views/partials/todo-create-content.ejs` with the content extracted
   from `todo-create.ejs` (everything between layout-top and layout-bottom):
   ```ejs
   <h1>Create Todo</h1>

   <p><a href="/todos">&larr; Back to Todos</a></p>

   <article>
     <form method="POST" action="/todos"
           hx-post="/todos"
           hx-target="#main-content">
       <label>
         Title
         <input
           type="text"
           name="title"
           placeholder="Todo title"
           required
           maxlength="200"
         />
       </label>

       <label>
         Priority
         <select name="priority" required>
           <option value="">Select priority...</option>
           <option value="P0">P0 - Critical</option>
           <option value="P1">P1 - High</option>
           <option value="P2">P2 - Medium</option>
           <option value="PX">PX - Low</option>
         </select>
       </label>

       <label>
         Phase (optional)
         <input
           type="text"
           name="phase"
           placeholder="e.g., 09-todo-write-operations"
         />
         <small>Format: 01-phase-name</small>
       </label>

       <label>
         Description
         <textarea
           name="description"
           rows="10"
           required
           placeholder="Markdown content..."
         ></textarea>
       </label>

       <button type="submit">Create Todo</button>
     </form>
   </article>
   ```

   Then update `src/views/todo-create.ejs` to use the partial:
   ```ejs
   <%- include('partials/layout-top', { title: 'Create Todo', activePage: 'todos' }) %>

   <%- include('partials/todo-create-content') %>

   <%- include('partials/layout-bottom') %>
   ```

   Note: The form in `todo-create-content.ejs` has both `method="POST" action="/todos"`
   (for non-JS fallback) AND `hx-post="/todos" hx-target="#main-content"` (for HTMX).
   When HTMX is active, it intercepts the form submission and uses hx-post. When JS
   is disabled, the standard form submission works as before.
  </action>
  <verify>
    node -e "const fs = require('fs'); const idx = fs.readFileSync('D:/Repos/towline-test-project/src/routes/index.routes.js','utf-8'); const pages = fs.readFileSync('D:/Repos/towline-test-project/src/routes/pages.routes.js','utf-8'); if (!idx.includes('HX-Request')) throw new Error('index.routes.js missing HX-Request detection'); if (!idx.includes('Vary')) throw new Error('index.routes.js missing Vary header'); if (!idx.includes('dashboard-content')) throw new Error('index.routes.js missing dashboard-content partial'); if (!pages.includes('HX-Request')) throw new Error('pages.routes.js missing HX-Request detection'); if (!pages.includes('Vary')) throw new Error('pages.routes.js missing Vary header'); if (!pages.includes('phase-content')) throw new Error('pages.routes.js missing phase-content partial'); if (!pages.includes('todos-content')) throw new Error('pages.routes.js missing todos-content partial'); if (!pages.includes('todo-detail-content')) throw new Error('pages.routes.js missing todo-detail-content partial'); if (!pages.includes('roadmap-content')) throw new Error('pages.routes.js missing roadmap-content partial'); if (!pages.includes('todo-create-content')) throw new Error('pages.routes.js missing todo-create-content partial'); const tcc = fs.readFileSync('D:/Repos/towline-test-project/src/views/partials/todo-create-content.ejs','utf-8'); if (!tcc.includes('hx-post')) throw new Error('todo-create-content.ejs missing hx-post'); const tc = fs.readFileSync('D:/Repos/towline-test-project/src/views/todo-create.ejs','utf-8'); if (!tc.includes('todo-create-content')) throw new Error('todo-create.ejs not using partial'); console.log('PASS: all routes have HX-Request detection, Vary headers, and fragment rendering');" && npx --prefix D:/Repos/towline-test-project vitest run --reporter=verbose
  </verify>
  <done>
    All GET page routes detect the HX-Request header and return content partials (fragments) for HTMX requests, full pages for normal requests. All GET routes set the Vary: HX-Request header. POST /todos returns the new todo detail fragment for HTMX. POST /todos/:id/done returns the refreshed todo list fragment for HTMX. Todo create form has hx-post attribute for HTMX-powered submission.
  </done>
</task>

<task id="11-02-T2" type="auto">
  <name>Replace sse-client.js with HTMX SSE extension and update todo forms with HTMX attributes</name>
  <files>
    src/views/partials/layout-bottom.ejs
    src/views/partials/footer.ejs
    public/js/sse-client.js
    src/views/partials/todo-detail-content.ejs
    src/views/partials/todos-content.ejs
  </files>
  <action>
1. Open `src/views/partials/todo-detail-content.ejs` (created in Plan 11-01) and
   update the "Mark as Done" form to use HTMX. Change the form section from:
   ```ejs
   <% if (status === 'pending') { %>
   <hr>
   <form method="POST" action="/todos/<%= id %>/done" style="display:inline;">
     <button type="submit" class="secondary">Mark as Done</button>
   </form>
   <% } %>
   ```

   To:
   ```ejs
   <% if (status === 'pending') { %>
   <hr>
   <form method="POST" action="/todos/<%= id %>/done"
         hx-post="/todos/<%= id %>/done"
         hx-target="#main-content"
         style="display:inline;">
     <button type="submit" class="secondary">Mark as Done</button>
   </form>
   <% } %>
   ```

   The form retains `method="POST" action="..."` for non-JS fallback, and adds
   `hx-post` and `hx-target="#main-content"` for HTMX. When the user clicks
   "Mark as Done", HTMX intercepts the POST, sends it, and swaps the entire
   main content area with the refreshed todo list returned by the handler.

2. Open `src/views/partials/todos-content.ejs` (created in Plan 11-01) and update
   the "Create Todo" link to navigate via HTMX. Change:
   ```ejs
   <p><a href="/todos/new" role="button">Create Todo</a></p>
   ```

   To:
   ```ejs
   <p><a href="/todos/new" role="button"
         hx-get="/todos/new"
         hx-target="#main-content"
         hx-push-url="true">Create Todo</a></p>
   ```

3. Replace `src/views/partials/layout-bottom.ejs` with the HTMX SSE extension
   approach. The current file loads sse-client.js via a script tag. Replace it
   with HTMX SSE extension attributes on a wrapper div.

   Replace the entire content of `layout-bottom.ejs` with:
   ```ejs
       </main>
       <%- include('footer') %>
     </div>
     <div hx-ext="sse"
          sse-connect="/api/events/stream"
          sse-close="close">
       <div hx-trigger="sse:file-change"
            hx-get="<%= typeof currentPath !== 'undefined' ? currentPath : '/' %>"
            hx-target="#main-content"
            hx-swap="innerHTML"
            style="display:none;">
       </div>
     </div>
   </body>
   </html>
   ```

   How this works:
   - `hx-ext="sse"` activates the HTMX SSE extension on the container
   - `sse-connect="/api/events/stream"` establishes the SSE connection (same endpoint)
   - `sse-close="close"` disconnects on the "close" event from server (standard practice)
   - The inner hidden div listens for `sse:file-change` events
   - When a file-change event arrives, it triggers an `hx-get` to refresh the current
     page content by re-fetching it as a fragment
   - `currentPath` is a template variable that routes must pass (see step 5)
   - Falls back to "/" if currentPath is not set

4. Update `src/views/partials/footer.ejs` to remove the sse-status indicator (which
   was driven by sse-client.js). The SSE connection is now managed by HTMX and has
   no visual indicator (that can be added in Phase 12 if desired).

   Replace the content of `footer.ejs` with:
   ```ejs
   <footer>
     <small>Towline Dashboard v0.1.0</small>
   </footer>
   ```

   Note: The `#sse-status` indicator relied on sse-client.js setting data-connected.
   With the HTMX SSE extension, there is no equivalent built-in indicator. The
   connection still works and auto-reconnects (HTMX SSE extension has built-in
   reconnection). The CSS for `#sse-status` in layout.css can remain (harmless) or
   be cleaned up in Phase 12.

5. Delete `public/js/sse-client.js`. This file is completely replaced by the HTMX
   SSE extension attributes in layout-bottom.ejs.

   ```bash
   rm D:/Repos/towline-test-project/public/js/sse-client.js
   ```

6. The SSE-triggered refresh needs to know the current page URL so it can re-fetch
   the correct content fragment. Each route handler must pass `currentPath` as a
   template variable. This is already handled by the HTMX SSE div falling back to
   "/" when currentPath is undefined.

   However, for correctness, update the route handlers in `src/routes/index.routes.js`
   and `src/routes/pages.routes.js` to include `currentPath` in their template data.

   In `src/routes/index.routes.js`, add `currentPath: '/'` to the templateData:
   ```javascript
   const templateData = {
     ...homepageData,
     ...dashboardData,
     activePage: 'dashboard',
     currentPath: '/'
   };
   ```

   In `src/routes/pages.routes.js`, add `currentPath` to each handler's templateData:
   - GET /phases: `currentPath: '/phases'`
   - GET /phases/:phaseId: `currentPath: '/phases/' + phaseId`
   - GET /todos: `currentPath: '/todos'`
   - GET /todos/new: `currentPath: '/todos/new'`
   - GET /todos/:id: `currentPath: '/todos/' + id`
   - GET /roadmap: `currentPath: '/roadmap'`

   For the POST handlers, currentPath is also needed in the template data they pass
   when rendering HTMX fragments:
   - POST /todos (HTMX branch): `currentPath: '/todos/' + todoId`
   - POST /todos/:id/done (HTMX branch): `currentPath: '/todos'`

   Note: For the POST handlers' redirect branches (non-HTMX), currentPath is not
   needed since res.redirect() does not render a template.
  </action>
  <verify>
    node -e "const fs = require('fs'); const lb = fs.readFileSync('D:/Repos/towline-test-project/src/views/partials/layout-bottom.ejs','utf-8'); if (lb.includes('sse-client.js')) throw new Error('layout-bottom.ejs still references sse-client.js'); if (!lb.includes('hx-ext=\"sse\"')) throw new Error('layout-bottom.ejs missing hx-ext=sse'); if (!lb.includes('sse-connect')) throw new Error('layout-bottom.ejs missing sse-connect'); if (!lb.includes('sse:file-change')) throw new Error('layout-bottom.ejs missing sse:file-change trigger'); if (!lb.includes('hx-get')) throw new Error('layout-bottom.ejs missing hx-get for refresh'); const ft = fs.readFileSync('D:/Repos/towline-test-project/src/views/partials/footer.ejs','utf-8'); if (ft.includes('sse-status')) throw new Error('footer.ejs still has sse-status indicator'); if (fs.existsSync('D:/Repos/towline-test-project/public/js/sse-client.js')) throw new Error('sse-client.js still exists'); const td = fs.readFileSync('D:/Repos/towline-test-project/src/views/partials/todo-detail-content.ejs','utf-8'); if (!td.includes('hx-post')) throw new Error('todo-detail-content.ejs missing hx-post on Mark as Done'); const tc = fs.readFileSync('D:/Repos/towline-test-project/src/views/partials/todos-content.ejs','utf-8'); if (!tc.includes('hx-get=\"/todos/new\"')) throw new Error('todos-content.ejs missing hx-get on Create Todo link'); const idx = fs.readFileSync('D:/Repos/towline-test-project/src/routes/index.routes.js','utf-8'); if (!idx.includes('currentPath')) throw new Error('index.routes.js missing currentPath'); const pages = fs.readFileSync('D:/Repos/towline-test-project/src/routes/pages.routes.js','utf-8'); if (!pages.includes('currentPath')) throw new Error('pages.routes.js missing currentPath'); console.log('PASS: SSE extension in place, sse-client.js deleted, HTMX forms updated, currentPath set');" && npx --prefix D:/Repos/towline-test-project vitest run --reporter=verbose
  </verify>
  <done>
    HTMX SSE extension replaces sse-client.js for live file-change driven content refresh. Todo "Mark as Done" button uses hx-post for in-place update. Todo "Create Todo" link uses hx-get for HTMX navigation. SSE file-change events trigger hx-get to refresh current page content area without full page reload. All existing tests pass.
  </done>
</task>
