---
phase: "01-project-scaffolding"
plan: "01-01"
type: "infrastructure"
wave: 1
depends_on: []
files_modified:
  - "package.json"
  - ".gitignore"
  - "bin/cli.js"
  - "src/server.js"
  - "src/app.js"
  - "src/routes/index.routes.js"
  - "src/middleware/errorHandler.js"
  - "src/services/project.service.js"
  - "src/repositories/planning.repository.js"
autonomous: true
discovery: 0
must_haves:
  truths:
    - "src/server.js exports startServer(config) which creates and starts an HTTP server on a configurable port"
    - "CLI parses --dir and --port flags via Commander.js and passes them to startServer()"
    - "Three-layer architecture is present: routes dir, services dir, repositories dir"
    - "All path construction uses path.join() or path.resolve() -- no hardcoded separators"
  artifacts:
    - "package.json with type:module, bin field, express+ejs+commander dependencies"
    - "bin/cli.js with shebang, Commander.js option parsing, startServer() call"
    - "src/server.js exporting startServer() that creates app and listens"
    - "src/app.js exporting createApp() that configures Express with view engine, static files, routes, error handler"
    - "src/middleware/errorHandler.js with 4-param Express error handler"
    - "src/services/project.service.js with placeholder getHomepage()"
    - "src/repositories/planning.repository.js with placeholder readProjectMetadata()"
  key_links:
    - "bin/cli.js imports and calls startServer() from src/server.js"
    - "src/server.js imports createApp() from src/app.js"
    - "src/app.js imports indexRouter from src/routes/index.routes.js"
    - "src/app.js registers errorHandler as last middleware"
    - "index.routes.js imports and calls getHomepage() from project.service.js"
provides:
  - "createApp(config) function"
  - "startServer(config) function"
  - "CLI entry point at bin/cli.js"
  - "Three-layer directory structure"
  - "Error handling middleware"
---

# Plan 01-01: Project Structure, CLI Entry Point, and Express Server

## Overview

Initialize the towline-dashboard project with package.json (ESM), install dependencies,
create the CLI entry point with Commander.js, and set up the Express 5.x application
with three-layer architecture (routes, services, repositories). After this plan,
`node bin/cli.js --dir . --port 3000` starts a working server, though views are not
yet created (that is Plan 01-02).

## Tasks

<task id="01-01-T1" type="auto">
  <name>Initialize project and create package.json with dependencies</name>
  <files>
    package.json
    .gitignore
  </files>
  <action>
    1. Create the project directory at `D:\Repos\towline-test-project` if it does not exist.

    2. Create `package.json` with the following exact content:
       ```json
       {
         "name": "towline-dashboard",
         "version": "0.1.0",
         "description": "Web dashboard for viewing Towline project planning state",
         "type": "module",
         "bin": {
           "towline-dashboard": "./bin/cli.js"
         },
         "scripts": {
           "start": "node bin/cli.js",
           "dev": "node --watch bin/cli.js",
           "test": "vitest run"
         },
         "keywords": ["towline", "dashboard", "planning"],
         "license": "MIT",
         "dependencies": {
           "commander": "^12.1.0",
           "ejs": "^3.1.10",
           "express": "^5.1.0"
         },
         "devDependencies": {
           "vitest": "^3.1.0"
         }
       }
       ```

       Key decisions:
       - `"type": "module"` enables ESM imports throughout the project
       - `bin` field maps `towline-dashboard` CLI command to `./bin/cli.js`
       - No `dotenv` dependency -- Phase 1 uses CLI flags only
       - Express 5.1+ (latest 5.x stable) for auto async error catching

    3. Create `.gitignore`:
       ```
       node_modules/
       .env
       .env.*
       !.env.example
       ```

    4. Run `npm install` in the project directory to install all dependencies.
  </action>
  <verify>
    cd /d D:\Repos\towline-test-project && node -e "import('express').then(m => console.log('express ok'))" && node -e "import('commander').then(m => console.log('commander ok'))" && node -e "import('ejs').then(m => console.log('ejs ok'))"
  </verify>
  <done>Project directory exists with package.json (type:module), node_modules installed, express/commander/ejs importable</done>
</task>

<task id="01-01-T2" type="auto">
  <name>Create CLI entry point and Express server with three-layer skeleton</name>
  <files>
    bin/cli.js
    src/server.js
    src/app.js
    src/routes/index.routes.js
    src/middleware/errorHandler.js
    src/services/project.service.js
    src/repositories/planning.repository.js
  </files>
  <action>
    1. Create `bin/cli.js` -- the CLI entry point:
       ```javascript
       #!/usr/bin/env node

       import { Command } from 'commander';
       import { resolve } from 'path';
       import { startServer } from '../src/server.js';

       const program = new Command();

       program
         .name('towline-dashboard')
         .description('Start the Towline planning dashboard')
         .option('-d, --dir <path>', 'Path to Towline project directory', process.cwd())
         .option('-p, --port <number>', 'Server port', '3000')
         .parse();

       const options = program.opts();
       const projectDir = resolve(options.dir);
       const port = parseInt(options.port, 10);

       if (isNaN(port) || port < 1 || port > 65535) {
         console.error(`Invalid port: ${options.port}`);
         process.exit(1);
       }

       startServer({ projectDir, port });
       ```

       Key points:
       - Shebang line for Unix execution via `npx towline-dashboard`
       - `resolve(options.dir)` normalizes relative paths to absolute (cross-platform)
       - Port validation before passing to server
       - Default dir is `process.cwd()`, default port is 3000

    2. Create `src/server.js` -- HTTP server startup (separate from app config for testability):
       ```javascript
       import { createApp } from './app.js';

       export function startServer(config) {
         const app = createApp(config);
         const { port } = config;

         const server = app.listen(port, '127.0.0.1', () => {
           console.log(`Towline Dashboard running at http://127.0.0.1:${port}`);
           console.log(`Project directory: ${config.projectDir}`);
         });

         const shutdown = () => {
           console.log('Shutting down Towline Dashboard...');
           server.close(() => {
             console.log('Server closed.');
             process.exit(0);
           });
         };

         process.on('SIGTERM', shutdown);
         process.on('SIGINT', shutdown);

         return server;
       }
       ```

       Key points:
       - Binds to `127.0.0.1` only (local dev tool, not exposed to network)
       - Graceful shutdown on SIGTERM and SIGINT
       - Returns server instance for testing

    3. Create `src/app.js` -- Express application configuration:
       ```javascript
       import express from 'express';
       import { join } from 'path';
       import { fileURLToPath } from 'url';
       import { dirname } from 'path';
       import indexRouter from './routes/index.routes.js';
       import errorHandler from './middleware/errorHandler.js';

       const __filename = fileURLToPath(import.meta.url);
       const __dirname = dirname(__filename);

       export function createApp(config) {
         const app = express();

         // Store config for access in routes/services
         app.locals.projectDir = config.projectDir;

         // View engine setup -- all paths use path.join (cross-platform)
         app.set('views', join(__dirname, 'views'));
         app.set('view engine', 'ejs');

         // Built-in middleware
         app.use(express.json());
         app.use(express.urlencoded({ extended: false }));

         // Static files
         app.use(express.static(join(__dirname, '..', 'public')));

         // Routes
         app.use('/', indexRouter);

         // Error handler MUST be registered last
         app.use(errorHandler);

         return app;
       }
       ```

       Key points:
       - `__dirname` reconstructed from `import.meta.url` (ESM has no native __dirname)
       - `join(__dirname, 'views')` ensures absolute path regardless of cwd
       - `join(__dirname, '..', 'public')` for static assets -- cross-platform
       - `app.locals.projectDir` makes config available to routes/services
       - Error handler registered LAST (Express requirement: 4-param middleware)

    4. Create `src/routes/index.routes.js` -- Route layer (delegates to service):
       ```javascript
       import { Router } from 'express';
       import { getHomepage } from '../services/project.service.js';

       const router = Router();

       router.get('/', async (req, res) => {
         const data = await getHomepage(req.app.locals.projectDir);
         res.render('index', data);
       });

       export default router;
       ```

       Key points:
       - Route contains NO business logic -- only extracts params and calls service
       - Express 5.x auto-catches async rejections, so no try-catch wrapper needed
       - `res.render('index', data)` renders the EJS template (created in Plan 01-02)

    5. Create `src/services/project.service.js` -- Service layer (placeholder):
       ```javascript
       /**
        * Service layer: orchestrates business logic between routes and repositories.
        * Phase 1 returns placeholder data. Future phases will call repositories.
        */

       export async function getHomepage(projectDir) {
         return {
           title: 'Towline Dashboard',
           projectDir,
           message: 'Planning dashboard is running. Connect a project directory to see its state.'
         };
       }
       ```

    6. Create `src/repositories/planning.repository.js` -- Repository layer (placeholder):
       ```javascript
       import { readFile } from 'node:fs/promises';
       import { join } from 'node:path';

       /**
        * Repository layer: encapsulates all file system access.
        * Phase 1 is a placeholder. Phase 2 will implement real file reading.
        */

       export async function readProjectMetadata(projectDir) {
         // Placeholder for Phase 2 -- will read .planning/STATE.md, config.json, etc.
         const statePath = join(projectDir, '.planning', 'STATE.md');
         throw new Error('readProjectMetadata not implemented until Phase 2');
       }
       ```

       Key point: Uses `join()` for path construction, never hardcoded separators.

    7. Create `src/middleware/errorHandler.js` -- Error handling middleware:
       ```javascript
       /**
        * Express error-handling middleware.
        * MUST have exactly 4 parameters for Express to recognize it as an error handler.
        */

       // eslint-disable-next-line no-unused-vars
       export default function errorHandler(err, req, res, next) {
         console.error('Unhandled error:', err.message);
         if (err.stack) {
           console.error(err.stack);
         }

         const status = err.status || err.statusCode || 500;

         res.status(status).render('error', {
           title: 'Error',
           status,
           message: err.message || 'Internal Server Error'
         });
       }
       ```

       Key points:
       - 4 parameters required (Express identifies error handlers by arity)
       - Renders an EJS error template (created in Plan 01-02)
       - Logs error details to console for debugging
  </action>
  <verify>
    cd /d D:\Repos\towline-test-project && node -e "import('./src/app.js').then(m => { const app = m.createApp({projectDir: '.'}); console.log('createApp ok') })" && node -e "import('./src/services/project.service.js').then(m => m.getHomepage('.').then(() => console.log('service ok')))" && node -e "import('./src/repositories/planning.repository.js').then(m => console.log('repo ok'))"
  </verify>
  <done>All seven files exist, import chains resolve without errors, three-layer architecture (routes/services/repositories) is established</done>
</task>
