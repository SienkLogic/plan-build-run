---
phase: "15-gate-check-upgrades"
plan: "15-01"
title: "Core gate checks and simple confirmations"
type: feature
wave: 1
depends_on: []
files_modified:
  - "plugins/dev/skills/shared/gate-prompts.md"
  - "plugins/dev/skills/plan/SKILL.md"
  - "plugins/dev/skills/build/SKILL.md"
  - "plugins/dev/skills/import/SKILL.md"
  - "plugins/dev/skills/scan/SKILL.md"
autonomous: true
discovery: 0
must_haves:
  truths:
    - "plan SKILL.md uses AskUserQuestion for re-planning confirmation, seed selection, and plan approval gate"
    - "build SKILL.md uses AskUserQuestion for execute confirmation, staleness warning, all-completed rebuild, failure handling, and branch merge"
    - "import SKILL.md uses AskUserQuestion for checker loop resolution"
    - "scan SKILL.md uses AskUserQuestion for commit decision"
    - "A shared gate-prompts.md reference document exists with reusable AskUserQuestion patterns"
  artifacts:
    - "plugins/dev/skills/shared/gate-prompts.md"
  key_links:
    - "plan SKILL.md references gate-prompts.md patterns for its 3 gate checks"
    - "build SKILL.md references gate-prompts.md patterns for its 5 gate checks"
    - "import SKILL.md references gate-prompts.md patterns for its checker loop gate"
    - "scan SKILL.md references gate-prompts.md patterns for its commit gate"
status: planned
---

# Plan 15-01: Core Gate Checks and Simple Confirmations

Convert 11 gate check points across plan, build, import, and scan skills from freeform text prompts to AskUserQuestion structured prompts. Create a shared reference document with reusable AskUserQuestion patterns.

---

<task id="15-01-T1" type="auto" tdd="false">
  <name>Create shared gate-prompts.md reference and convert plan SKILL.md gates</name>
  <files>
    plugins/dev/skills/shared/gate-prompts.md
    plugins/dev/skills/plan/SKILL.md
  </files>
  <action>
**Part A: Create `plugins/dev/skills/shared/gate-prompts.md`**

Create a new shared reference document with reusable AskUserQuestion patterns. This is a reference that skill files can point to for consistency. Include these patterns:

1. **approve-revise-abort** (3-option gate) — used for plan approval, gap-closure approval:
   ```
   Use AskUserQuestion:
     question: "Approve these {noun}?"
     header: "Approve?"    (max 12 chars)
     options:
       - label: "Approve"         description: "Proceed with {action}"
       - label: "Request changes"  description: "Discuss adjustments before proceeding"
       - label: "Abort"           description: "Cancel this operation"
     multiSelect: false
   ```

2. **yes-no** (simple confirmation) — used for re-planning, rebuild, replace plans, commit:
   ```
   Use AskUserQuestion:
     question: "{Specific question about the action}"
     header: "Confirm"    (max 12 chars)
     options:
       - label: "Yes"   description: "{What happens if yes}"
       - label: "No"    description: "{What happens if no}"
     multiSelect: false
   ```

3. **stale-continue** (2-option refresh) — used for staleness warnings, timestamp freshness:
   ```
   Use AskUserQuestion:
     question: "{Artifact} may be outdated. Refresh or continue?"
     header: "Stale"    (max 12 chars)
     options:
       - label: "Refresh"          description: "Update before proceeding (recommended)"
       - label: "Continue anyway"  description: "Proceed with current version"
     multiSelect: false
   ```

4. **yes-no-pick** (3-option selection) — used for seed selection:
   ```
   Use AskUserQuestion:
     question: "Include {items} in planning?"
     header: "Include?"    (max 12 chars)
     options:
       - label: "Yes, all"    description: "Include all matching items"
       - label: "Let me pick"  description: "Choose which items to include"
       - label: "No"           description: "Proceed without these items"
     multiSelect: false
   ```

5. **multi-option-failure** (4-option failure handler) — used for build failures:
   ```
   Use AskUserQuestion:
     question: "Plan {id} failed. How should we proceed?"
     header: "Failed"    (max 12 chars)
     options:
       - label: "Retry"     description: "Re-run this plan's executor"
       - label: "Skip"      description: "Mark as skipped, continue to next wave"
       - label: "Rollback"  description: "Undo commits, revert to last good state"
       - label: "Abort"     description: "Stop the entire build"
     multiSelect: false
   ```

6. **multi-option-escalation** (4-option escalation, max AskUserQuestion supports) — used for review escalation:
   ```
   Use AskUserQuestion:
     question: "Phase {N} has failed verification {attempt} times. How should we proceed?"
     header: "Escalate"    (max 12 chars)
     options:
       - label: "Accept gaps"   description: "Mark as complete-with-gaps and move on"
       - label: "Re-plan"       description: "Go back to /dev:plan with gap context"
       - label: "Debug"         description: "Spawn /dev:debug to investigate root causes"
       - label: "Retry"         description: "Try one more verification cycle"
     multiSelect: false
   ```
   Note: AskUserQuestion supports max 4 options. The original review escalation had 5 options (accept-gaps/re-plan/debug/override/retry). The "override" option is folded into the post-selection flow: if user selects "Accept gaps", offer a follow-up AskUserQuestion asking whether to accept all gaps or pick specific ones (the "override" behavior).

7. **multi-option-gaps** (4-option gap handler) — used for review gaps-found:
   ```
   Use AskUserQuestion:
     question: "{count} verification gaps need attention. How should we proceed?"
     header: "Gaps"    (max 12 chars)
     options:
       - label: "Auto-fix"  description: "Diagnose root causes and create fix plans (recommended)"
       - label: "Override"   description: "Accept specific gaps as false positives"
       - label: "Manual"     description: "I'll fix these myself"
       - label: "Skip"       description: "Save results for later"
     multiSelect: false
   ```

8. **multi-option-priority** (4-option priority selection) — used for milestone gap priority:
   ```
   Use AskUserQuestion:
     question: "Which gaps should we address?"
     header: "Priority"    (max 12 chars)
     options:
       - label: "Must-fix only"    description: "Address critical/high gaps only"
       - label: "Must + should"    description: "Address critical, high, and medium gaps"
       - label: "Everything"       description: "Address all gaps including low priority"
       - label: "Let me pick"      description: "Choose specific gaps to address"
     multiSelect: false
   ```

**Part B: Convert plan SKILL.md (3 gate checks)**

Edit `plugins/dev/skills/plan/SKILL.md`:

1. **Add AskUserQuestion to allowed-tools** in YAML frontmatter (line 4):
   Change: `allowed-tools: Read, Write, Bash, Glob, Grep, WebFetch, WebSearch, Task`
   To: `allowed-tools: Read, Write, Bash, Glob, Grep, WebFetch, WebSearch, Task, AskUserQuestion`

2. **Re-planning confirmation** (lines 80-83):
   Replace the freeform text block:
   ```
   - Tell user: "Phase {N} already has plans. Re-plan from scratch? This will replace existing plans."
   - If yes: delete existing PLAN.md files in the phase directory
   - If no: stop
   ```
   With:
   ```
   - Use AskUserQuestion (pattern: yes-no from `skills/shared/gate-prompts.md`):
     question: "Phase {N} already has plans. Re-plan from scratch?"
     header: "Re-plan?"
     options:
       - label: "Yes"  description: "Delete existing plans and create new ones"
       - label: "No"   description: "Keep existing plans unchanged"
   - If "Yes": delete existing PLAN.md files in the phase directory
   - If "No" or "Other": stop
   ```

3. **Seed selection** (lines 203-214):
   Replace the freeform text block:
   ```
   Found {N} seeds related to Phase {NN}:
     - {seed_name}: {seed description}
     - {seed_name}: {seed description}

   Include them in planning? [yes/no/pick]
   ```
   And its handling (lines 211-214) with:
   ```
   Found {N} seeds related to Phase {NN}:
     - {seed_name}: {seed description}
     - {seed_name}: {seed description}

   Use AskUserQuestion (pattern: yes-no-pick from `skills/shared/gate-prompts.md`):
     question: "Include these {N} seeds in planning?"
     header: "Seeds?"
     options:
       - label: "Yes, all"     description: "Include all {N} matching seeds"
       - label: "Let me pick"  description: "Choose which seeds to include"
       - label: "No"           description: "Proceed without seeds"
   - If "Yes, all": include all matching seed content in the planner's context
   - If "Let me pick": present individual seeds for selection
   - If "No" or "Other": proceed without seeds
   ```

4. **User approval of plans** (lines 303-340):
   Keep the plan summary presentation block (lines 313-330) as-is but replace the approval prompt at lines 331-334:
   ```
   Approve these plans?
   -> yes - proceed to build
   -> changes - request adjustments
   -> abort - cancel planning
   ```
   With:
   ```
   Use AskUserQuestion (pattern: approve-revise-abort from `skills/shared/gate-prompts.md`):
     question: "Approve these {count} plans for Phase {N}?"
     header: "Approve?"
     options:
       - label: "Approve"          description: "Proceed to build phase"
       - label: "Request changes"  description: "Discuss adjustments before proceeding"
       - label: "Abort"            description: "Cancel planning for this phase"
   ```
   Update the handler text at line 337 from "If user requests changes:" to "If user selects 'Request changes' or 'Other':" and keep the rest of the handler as-is (enter discussion mode).
   Update line 342 from "If user approves:" to "If user selects 'Approve':"

**IMPORTANT**: Do NOT modify the assumption surfacing section (lines 122-153). The research explicitly recommends keeping it as inline conversation because AskUserQuestion is too rigid for iterative refinement of 4+ assumptions.
  </action>
  <verify>
    npx grep -c "AskUserQuestion" plugins/dev/skills/plan/SKILL.md
    npx grep -c "AskUserQuestion" plugins/dev/skills/shared/gate-prompts.md
    ls plugins/dev/skills/shared/gate-prompts.md
    grep "allowed-tools.*AskUserQuestion" plugins/dev/skills/plan/SKILL.md
  </verify>
  <done>plan SKILL.md uses AskUserQuestion for re-planning, seed selection, and plan approval; gate-prompts.md exists with 8 reusable patterns</done>
</task>

<task id="15-01-T2" type="auto" tdd="false">
  <name>Convert build SKILL.md gate checks to AskUserQuestion</name>
  <files>
    plugins/dev/skills/build/SKILL.md
  </files>
  <action>
Edit `plugins/dev/skills/build/SKILL.md`:

1. **Add AskUserQuestion to allowed-tools** in YAML frontmatter (line 5):
   Change: `allowed-tools: Read, Write, Edit, Bash, Glob, Grep, Task`
   To: `allowed-tools: Read, Write, Edit, Bash, Glob, Grep, Task, AskUserQuestion`

2. **Execute confirmation** (line 64):
   Replace:
   ```
   5. If `gates.confirm_execute` is true: ask user to confirm before proceeding
   ```
   With:
   ```
   5. If `gates.confirm_execute` is true: use AskUserQuestion (pattern: yes-no from `skills/shared/gate-prompts.md`):
      question: "Ready to build Phase {N}? This will execute {count} plans."
      header: "Build?"
      options:
        - label: "Yes"  description: "Start building Phase {N}"
        - label: "No"   description: "Cancel — review plans first"
      If "No" or "Other": stop and suggest `/dev:plan {N}` to review plans
   ```

3. **Plan staleness warning** (lines 68-76):
   Replace the freeform text at lines 73-76:
   ```
   4. Warn user: "Plan {plan_id} may be stale — dependency phase {M} was re-built after this plan was created. Re-plan with `/dev:plan {N}` or continue with existing plans?"
   5. If user chooses to continue: proceed (the plans may still be valid)
   6. If user chooses to re-plan: stop and suggest `/dev:plan {N}`
   ```
   With:
   ```
   4. Use AskUserQuestion (pattern: stale-continue from `skills/shared/gate-prompts.md`):
      question: "Plan {plan_id} may be stale — dependency phase {M} was re-built after this plan was created."
      header: "Stale"
      options:
        - label: "Continue anyway"  description: "Proceed with existing plans (may still be valid)"
        - label: "Re-plan"          description: "Stop and re-plan with `/dev:plan {N}` (recommended)"
      If "Re-plan" or "Other": stop and suggest `/dev:plan {N}`
      If "Continue anyway": proceed with existing plans
   ```

4. **All plans already completed** (lines 133-136):
   Replace:
   ```
   - "Phase {N} has already been built. All plans have completed SUMMARYs. Re-build? This will delete existing SUMMARYs and re-execute."
   - If yes: delete SUMMARY files and proceed
   - If no: suggest `/dev:review {N}`
   ```
   With:
   ```
   Use AskUserQuestion (pattern: yes-no from `skills/shared/gate-prompts.md`):
     question: "Phase {N} has already been built. All plans have completed SUMMARYs. Re-build from scratch?"
     header: "Re-build?"
     options:
       - label: "Yes"  description: "Delete existing SUMMARYs and re-execute all plans"
       - label: "No"   description: "Keep existing build — review instead"
   - If "Yes": delete SUMMARY files and proceed
   - If "No" or "Other": suggest `/dev:review {N}`
   ```

5. **Failure handling** (lines 391-406):
   Replace the freeform text prompt:
   ```
   Ask user:
   - **retry** — re-spawn the executor for the failed plan
   - **skip** — mark plan as skipped, continue to next wave
   - **rollback** — undo commits from the failed plan, revert to last-good state
   - **abort** — stop the entire build
   ```
   With:
   ```
   Use AskUserQuestion (pattern: multi-option-failure from `skills/shared/gate-prompts.md`):
     question: "Plan {id} failed at task {N} ({name}). How should we proceed?"
     header: "Failed"
     options:
       - label: "Retry"     description: "Re-spawn the executor for this plan"
       - label: "Skip"      description: "Mark as skipped, continue to next wave"
       - label: "Rollback"  description: "Undo commits from this plan, revert to last good state"
       - label: "Abort"     description: "Stop the entire build"
   ```
   Keep all existing handler sections ("If retry:", "If skip:", "If rollback:", "If abort:") as-is, but update the matching text to reference the AskUserQuestion label (e.g., "If user selects 'Retry':" instead of "If retry:").

6. **Phase branch merge** (lines 652-655):
   Replace:
   ```
   - Ask user to confirm: "Phase {N} complete on branch `towline/phase-{NN}-{name}`. Squash merge to main?"
   - If confirmed: complete the merge and delete the phase branch
   - If declined: leave the branch as-is and inform the user
   ```
   With:
   ```
   - Use AskUserQuestion (pattern: yes-no from `skills/shared/gate-prompts.md`):
     question: "Phase {N} complete on branch `towline/phase-{NN}-{name}`. Squash merge to main?"
     header: "Merge?"
     options:
       - label: "Yes, merge"   description: "Squash merge to main and delete the phase branch"
       - label: "No, keep"     description: "Leave the branch as-is for manual review"
   - If "Yes, merge": complete the merge and delete the phase branch
   - If "No, keep" or "Other": leave the branch as-is and inform the user
   ```
  </action>
  <verify>
    npx grep -c "AskUserQuestion" plugins/dev/skills/build/SKILL.md
    grep "allowed-tools.*AskUserQuestion" plugins/dev/skills/build/SKILL.md
    grep -c "ask user" plugins/dev/skills/build/SKILL.md
  </verify>
  <done>build SKILL.md uses AskUserQuestion for all 5 gate checks: execute confirmation, staleness, rebuild, failure handling, and branch merge</done>
</task>

<task id="15-01-T3" type="auto" tdd="false">
  <name>Convert import and scan SKILL.md gate checks to AskUserQuestion</name>
  <files>
    plugins/dev/skills/import/SKILL.md
    plugins/dev/skills/scan/SKILL.md
  </files>
  <action>
**Part A: Convert import SKILL.md (1 gate check)**

Edit `plugins/dev/skills/import/SKILL.md`:

1. **Checker loop resolution** (line 310):
   Replace:
   ```
   - After 3 iterations without resolution: present remaining issues to user and ask: "These issues remain after 3 revision attempts. Proceed anyway, or adjust the approach?"
   ```
   With:
   ```
   - After 3 iterations without resolution: present remaining issues to user. Use AskUserQuestion (pattern: yes-no from `skills/shared/gate-prompts.md`):
     question: "Plan checker issues remain after 3 revision attempts. Proceed with current plans?"
     header: "Proceed?"
     options:
       - label: "Proceed anyway"  description: "Accept plans with remaining issues"
       - label: "Adjust approach"  description: "Discuss a different approach"
   - If "Proceed anyway": go to Step 7
   - If "Adjust approach" or "Other": discuss with user and re-enter Step 5 with updated context
   ```

Note: The import SKILL.md already has `AskUserQuestion` in its allowed-tools list (line 5) and already uses AskUserQuestion for blocker resolution (line 191) and warning acknowledgment (line 192). No changes needed to the frontmatter or those existing AskUserQuestion usages.

**Part B: Convert scan SKILL.md (1 gate check)**

Edit `plugins/dev/skills/scan/SKILL.md`:

1. **Add AskUserQuestion to allowed-tools** in YAML frontmatter (line 5):
   Change: `allowed-tools: Read, Write, Bash, Glob, Grep, Task`
   To: `allowed-tools: Read, Write, Bash, Glob, Grep, Task, AskUserQuestion`

2. **Commit decision** (lines 386-388):
   Replace:
   ```
   If no config exists yet (scan before begin), ask user:
   "Commit the codebase analysis? (y/n)"
   ```
   With:
   ```
   If no config exists yet (scan before begin), use AskUserQuestion (pattern: yes-no from `skills/shared/gate-prompts.md`):
     question: "Commit the codebase analysis to git?"
     header: "Commit?"
     options:
       - label: "Yes"  description: "Stage and commit .planning/codebase/ files"
       - label: "No"   description: "Skip commit — files are saved but not committed"
   - If "Yes": run `git add .planning/codebase/ && git commit -m "docs(planning): map existing codebase"`
   - If "No" or "Other": skip commit
   ```
  </action>
  <verify>
    npx grep -c "AskUserQuestion" plugins/dev/skills/import/SKILL.md
    npx grep -c "AskUserQuestion" plugins/dev/skills/scan/SKILL.md
    grep "allowed-tools.*AskUserQuestion" plugins/dev/skills/scan/SKILL.md
  </verify>
  <done>import SKILL.md uses AskUserQuestion for checker loop resolution; scan SKILL.md uses AskUserQuestion for commit decision</done>
</task>
