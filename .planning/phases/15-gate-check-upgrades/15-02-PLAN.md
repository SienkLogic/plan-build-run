---
phase: "15-gate-check-upgrades"
plan: "15-02"
title: "Complex multi-option handlers in review and milestone"
type: feature
wave: 1
depends_on: []
files_modified:
  - "plugins/dev/skills/review/SKILL.md"
  - "plugins/dev/skills/milestone/SKILL.md"
autonomous: true
discovery: 0
must_haves:
  truths:
    - "review SKILL.md uses AskUserQuestion for escalation after 3 failed attempts"
    - "review SKILL.md uses AskUserQuestion for transition confirmation"
    - "review SKILL.md uses AskUserQuestion for gap-closure plan approval"
    - "review SKILL.md uses AskUserQuestion for gaps-found handling"
    - "milestone SKILL.md uses AskUserQuestion for unverified phases warning"
    - "milestone SKILL.md uses AskUserQuestion for timestamp freshness check"
    - "milestone SKILL.md uses AskUserQuestion for gap priority selection"
  artifacts: []
  key_links:
    - "review SKILL.md references gate-prompts.md patterns for its 4 gate checks"
    - "milestone SKILL.md references gate-prompts.md patterns for its 3 gate checks"
status: planned
---

# Plan 15-02: Complex Multi-Option Handlers in Review and Milestone

Convert 7 gate check points in review and milestone skills from freeform text prompts to AskUserQuestion structured prompts. These are the more complex conversions involving 4+ option menus and multi-step flows.

---

<task id="15-02-T1" type="auto" tdd="false">
  <name>Convert review SKILL.md gate checks to AskUserQuestion</name>
  <files>
    plugins/dev/skills/review/SKILL.md
  </files>
  <action>
Edit `plugins/dev/skills/review/SKILL.md`:

1. **Add AskUserQuestion to allowed-tools** in YAML frontmatter (line 5):
   Change: `allowed-tools: Read, Write, Bash, Glob, Grep, Task`
   To: `allowed-tools: Read, Write, Bash, Glob, Grep, Task, AskUserQuestion`

2. **Escalation after 3 failed attempts** (lines 105-125):
   Replace the freeform text menu at lines 107-119:
   ```
   Phase {N}: {name} -- Verification Failed ({attempt} attempts)

   The same gaps have persisted across {attempt} verification attempts.
   Remaining gaps: {count}

   This suggests the gaps may need a different approach. Options:
   -> accept-with-gaps -- mark phase as "complete-with-gaps" and move on
   -> re-plan -- go back to /dev:plan {N} with gap context
   -> debug -- spawn /dev:debug to investigate root causes
   -> override -- mark specific gaps as false positives
   -> retry -- try one more verification cycle
   ```
   With:
   ```
   Present the escalation context:
   Phase {N}: {name} -- Verification Failed ({attempt} attempts)
   The same gaps have persisted across {attempt} verification attempts.
   Remaining gaps: {count}

   Use AskUserQuestion (pattern: multi-option-escalation from `skills/shared/gate-prompts.md`):
     question: "Phase {N} has failed verification {attempt} times with {count} persistent gaps. How should we proceed?"
     header: "Escalate"
     options:
       - label: "Accept gaps"   description: "Mark as complete-with-gaps and move on"
       - label: "Re-plan"       description: "Go back to /dev:plan {N} with gap context"
       - label: "Debug"         description: "Spawn /dev:debug to investigate root causes"
       - label: "Retry"         description: "Try one more verification cycle"

   Note: The original 5-option menu had "override" (mark specific gaps as false positives). Since AskUserQuestion supports max 4 options, the override flow is handled as a follow-up: if user selects "Accept gaps", use a follow-up AskUserQuestion:
     question: "Accept all gaps or pick specific ones to override?"
     header: "Override?"
     options:
       - label: "Accept all"   description: "Mark phase as complete-with-gaps, accept everything"
       - label: "Pick specific" description: "Choose which gaps to mark as false positives"
   If "Accept all": proceed with accept-with-gaps flow
   If "Pick specific": proceed with override flow (present each gap for selection)
   ```

   Update the handler bullets at lines 121-125:
   - Change "accept-with-gaps:" to "If user selects 'Accept gaps':" and add the follow-up AskUserQuestion logic above
   - Change "re-plan:" to "If user selects 'Re-plan':"
   - Change "debug:" to "If user selects 'Debug':"
   - Remove the separate "override:" handler (now folded into "Accept gaps" follow-up)
   - Change "retry:" to "If user selects 'Retry':"

3. **Transition confirmation** (lines 226-228):
   Replace:
   ```
   4. If `gates.confirm_transition` is true in config AND `features.auto_advance` is NOT true:
      - Ask: "Ready to move to Phase {N+1}?"
   ```
   With:
   ```
   4. If `gates.confirm_transition` is true in config AND `features.auto_advance` is NOT true:
      - Use AskUserQuestion (pattern: yes-no from `skills/shared/gate-prompts.md`):
        question: "Phase {N} verified. Ready to move to Phase {N+1}?"
        header: "Continue?"
        options:
          - label: "Yes"  description: "Proceed to plan Phase {N+1}"
          - label: "No"   description: "Stay on Phase {N} for now"
      - If "Yes": suggest `/dev:plan {N+1}`
      - If "No" or "Other": stop
   ```

4. **Gap-closure plan approval** (lines 286-303):
   Replace the freeform text at lines 299-303:
   ```
   Approve these gap-closure plans?
   -> yes -- I'll suggest the build command
   -> no -- let me review the plans first
   -> manual -- I'll fix these myself
   ```
   With:
   ```
   Use AskUserQuestion (pattern: approve-revise-abort from `skills/shared/gate-prompts.md`):
     question: "Approve these {count} gap-closure plans?"
     header: "Approve?"
     options:
       - label: "Approve"          description: "Proceed — I'll suggest the build command"
       - label: "Review first"     description: "Let me review the plans before approving"
       - label: "Fix manually"     description: "I'll fix these gaps myself"
   - If "Approve": suggest `/dev:build {N} --gaps-only`
   - If "Review first" or "Other": present the full plan files for inspection
   - If "Fix manually": suggest relevant files to inspect based on gap details
   ```

5. **Gaps-found handling** (lines 308-332):
   Replace the freeform text at lines 327-332:
   ```
   I'll diagnose these gaps and create fix plans now. Proceed?
   -> yes (recommended) -- diagnose root causes and create gap-closure plans
   -> override -- accept specific gaps as false positives (won't block verification)
   -> manual -- I'll fix these myself
   -> skip -- just save the results for later
   ```
   With:
   ```
   Use AskUserQuestion (pattern: multi-option-gaps from `skills/shared/gate-prompts.md`):
     question: "{count} verification gaps need attention. How should we proceed?"
     header: "Gaps"
     options:
       - label: "Auto-fix"  description: "Diagnose root causes and create fix plans (recommended)"
       - label: "Override"   description: "Accept specific gaps as false positives"
       - label: "Manual"     description: "I'll fix these myself"
       - label: "Skip"       description: "Save results for later"
   ```
   Update the handler text:
   - Change "If user says 'yes' or provides no objection:" to "If user selects 'Auto-fix':"
   - Change "If user chooses 'override':" to "If user selects 'Override':"
   - Change "If user chooses 'manual':" to "If user selects 'Manual':"
   - Change "If user chooses 'skip':" to "If user selects 'Skip':"

**IMPORTANT**: Do NOT modify:
- The UAT item verification loop (lines 175-188) — keep as inline conversation per research recommendation
- The override gap selection loop (lines 336-344) — keep as-is; this is a per-gap iteration that occurs AFTER the user chooses "Override" from the AskUserQuestion above
  </action>
  <verify>
    npx grep -c "AskUserQuestion" plugins/dev/skills/review/SKILL.md
    grep "allowed-tools.*AskUserQuestion" plugins/dev/skills/review/SKILL.md
    grep -c "\->" plugins/dev/skills/review/SKILL.md
  </verify>
  <done>review SKILL.md uses AskUserQuestion for escalation, transition confirmation, gap-closure approval, and gaps-found handling; UAT and override loops remain as inline conversation</done>
</task>

<task id="15-02-T2" type="auto" tdd="false">
  <name>Convert milestone SKILL.md gate checks to AskUserQuestion</name>
  <files>
    plugins/dev/skills/milestone/SKILL.md
  </files>
  <action>
Edit `plugins/dev/skills/milestone/SKILL.md`:

1. **Add AskUserQuestion to allowed-tools** in YAML frontmatter (line 5):
   Change: `allowed-tools: Read, Write, Bash, Glob, Grep, Task`
   To: `allowed-tools: Read, Write, Bash, Glob, Grep, Task, AskUserQuestion`

2. **Unverified phases warning** (lines 171-185):
   Replace the freeform text at lines 173-185:
   ```
     Warning: Phase {N} ({name}) hasn't been verified.
     Run `/dev:review {N}` first.

     Unverified phases:
     - Phase {N}: {name}
     - Phase {M}: {name}

     Continue anyway? (not recommended)
     ```
   - Use AskUserQuestion to let user decide
   - If user says no: stop and suggest the review commands
   - If user says yes: proceed with warning noted
   ```
   With:
   ```
   Present the warning context:
     Unverified phases:
     - Phase {N}: {name}
     - Phase {M}: {name}

   Use AskUserQuestion (pattern: yes-no from `skills/shared/gate-prompts.md`):
     question: "{count} phases haven't been verified. Continue with milestone completion?"
     header: "Unverified"
     options:
       - label: "Continue anyway"  description: "Proceed despite unverified phases (not recommended)"
       - label: "Stop and review"  description: "Run /dev:review for unverified phases first"
   - If "Stop and review" or "Other": stop and suggest the review commands for each unverified phase
   - If "Continue anyway": proceed with warning noted
   ```

3. **Timestamp freshness check** (lines 187-194):
   Replace the freeform text at lines 191-194:
   ```
   - List affected phases
   - Use AskUserQuestion: "Re-run `/dev:review` for affected phases, or proceed anyway?"
   - If user chooses to re-run: suggest the review commands and stop
   - If user chooses to proceed: continue with warning noted
   ```
   With:
   ```
   - List affected phases with their freshness details

   Use AskUserQuestion (pattern: stale-continue from `skills/shared/gate-prompts.md`):
     question: "{count} phases were modified after verification. Re-verify or continue?"
     header: "Stale"
     options:
       - label: "Re-verify"        description: "Run /dev:review for affected phases (recommended)"
       - label: "Continue anyway"   description: "Proceed with potentially outdated verification"
   - If "Re-verify" or "Other": suggest the review commands for affected phases and stop
   - If "Continue anyway": proceed with warning noted
   ```

4. **Gap priority selection** (lines 389-410):
   Replace the freeform text menu at lines 403-408:
   ```
   Which gaps should we address?
   1. All must-fix gaps
   2. Must-fix + should-fix
   3. Everything
   4. Let me pick specific ones
   ```
   And the line:
   ```
   Use AskUserQuestion for selection.
   ```
   With:
   ```
   Use AskUserQuestion (pattern: multi-option-priority from `skills/shared/gate-prompts.md`):
     question: "Which gaps should we address? ({must_count} must-fix, {should_count} should-fix, {nice_count} nice-to-fix)"
     header: "Priority"
     options:
       - label: "Must-fix only"    description: "Address {must_count} critical/high gaps"
       - label: "Must + should"    description: "Address {must_count + should_count} critical through medium gaps"
       - label: "Everything"       description: "Address all {total_count} gaps including low priority"
       - label: "Let me pick"      description: "Choose specific gaps to address"
   - If "Must-fix only": filter to must-fix gaps for phase creation
   - If "Must + should": filter to must-fix + should-fix gaps
   - If "Everything": include all gaps
   - If "Let me pick" or "Other": present individual gaps for selection
   ```

Note: The milestone skill already uses AskUserQuestion in several places (new milestone details at line 74, mini roadmap at line 84, version collision at line 489). Those existing usages do NOT need changes — they are already properly structured. Only the 3 gate checks above need conversion.
  </action>
  <verify>
    npx grep -c "AskUserQuestion" plugins/dev/skills/milestone/SKILL.md
    grep "allowed-tools.*AskUserQuestion" plugins/dev/skills/milestone/SKILL.md
    grep "Continue anyway? (not recommended)" plugins/dev/skills/milestone/SKILL.md
  </verify>
  <done>milestone SKILL.md uses AskUserQuestion for unverified phases, timestamp freshness, and gap priority selection; existing AskUserQuestion usages unchanged</done>
</task>
