---
phase: "18-reference-docs-and-testing"
plan: "18-03"
type: "test"
wave: 2
depends_on: ["18-01", "18-02"]
files_modified:
  - "tests/gate-prompts-validation.test.js"
  - "tests/skill-askuserquestion-audit.test.js"
autonomous: true
dependency_fingerprints:
  "17-01": "len:3624-mod:2026-02-10T20:16"
  "17-02": "len:4170-mod:2026-02-10T20:19"
  "17-03": "len:3831-mod:2026-02-10T20:19"
discovery: 0
must_haves:
  truths:
    - "All 21 gate patterns in gate-prompts.md pass structural validation"
    - "All 21 skills are audited for AskUserQuestion consistency"
    - "No plain-text gate check patterns remain (only intentional freeform exceptions)"
    - "All existing tests continue to pass"
  artifacts:
    - "tests/gate-prompts-validation.test.js"
    - "tests/skill-askuserquestion-audit.test.js"
  key_links:
    - "gate-prompts-validation.test.js reads and validates skills/shared/gate-prompts.md"
    - "skill-askuserquestion-audit.test.js reads all 21 SKILL.md files and cross-references gate-prompts.md"
---

# Plan 18-03: Add AskUserQuestion Test Coverage

<objective>
Create two test files that validate gate prompt pattern structure and skill-level
AskUserQuestion consistency. Tests are data-driven to remain maintainable as
patterns and skills evolve.
</objective>

<tasks>

<task id="18-03-T1" type="auto" tdd="false">
  <name>Create gate-prompts-validation.test.js</name>
  <files>
    tests/gate-prompts-validation.test.js
  </files>
  <action>
1. Create `tests/gate-prompts-validation.test.js`.
2. Use the same patterns as existing tests: `const fs = require('fs')`, `const path = require('path')`.
3. Set up constants:
   ```javascript
   const PLUGIN_ROOT = path.resolve(__dirname, '..', 'plugins', 'dev');
   const GATE_PROMPTS_PATH = path.join(PLUGIN_ROOT, 'skills', 'shared', 'gate-prompts.md');
   ```
4. Write a helper function `parsePatterns(content)` that extracts pattern sections
   from gate-prompts.md. Each pattern starts with `## Pattern: {slug}`. Extract:
   - Pattern name (the slug after "Pattern: ")
   - The full section content until the next `## Pattern:` or end of file
   - From the content, extract `header:` value and count `- label:` occurrences
5. Write these test suites:

```javascript
describe('gate-prompts.md validation', () => {
  const content = fs.readFileSync(GATE_PROMPTS_PATH, 'utf8');
  const patterns = parsePatterns(content);

  test('gate-prompts.md exists and is non-empty', () => {
    expect(content.length).toBeGreaterThan(0);
  });

  test('contains expected number of patterns (21)', () => {
    expect(patterns.length).toBe(21);
  });

  test('all pattern names are unique', () => {
    const names = patterns.map(p => p.name);
    const unique = [...new Set(names)];
    expect(names).toEqual(unique);
  });

  test.each(patterns.map(p => [p.name, p]))('pattern "%s" has header max 12 characters', (name, pattern) => {
    if (pattern.header) {
      expect(pattern.header.length).toBeLessThanOrEqual(12);
    }
  });

  test.each(patterns.map(p => [p.name, p]))('pattern "%s" has 2-4 options', (name, pattern) => {
    expect(pattern.optionCount).toBeGreaterThanOrEqual(2);
    expect(pattern.optionCount).toBeLessThanOrEqual(4);
  });

  test.each(patterns.map(p => [p.name, p]))('pattern "%s" has multiSelect: false', (name, pattern) => {
    expect(pattern.content).toMatch(/multiSelect:\s*false/);
  });

  test.each(patterns.map(p => [p.name, p]))('pattern "%s" has a question template', (name, pattern) => {
    expect(pattern.content).toMatch(/question:/);
  });
});
```

6. The `parsePatterns` function should handle:
   - Splitting content on `## Pattern: ` markers
   - Extracting the header value from `header: "{value}"` or `header: {value}`
     (strip quotes if present)
   - Counting `- label:` lines for option count
   - Returning array of `{ name, content, header, optionCount }`
  </action>
  <verify>
    npx jest tests/gate-prompts-validation.test.js --verbose
  </verify>
  <done>
    gate-prompts-validation.test.js validates all 21 patterns for: unique names,
    header max 12 chars, 2-4 options, multiSelect false, and question template
    presence. All tests pass.
  </done>
</task>

<task id="18-03-T2" type="auto" tdd="false">
  <name>Create skill-askuserquestion-audit.test.js</name>
  <files>
    tests/skill-askuserquestion-audit.test.js
  </files>
  <action>
1. Create `tests/skill-askuserquestion-audit.test.js`.
2. Use the same patterns as existing tests: `const fs = require('fs')`, `const path = require('path')`.
3. Set up constants:
   ```javascript
   const PLUGIN_ROOT = path.resolve(__dirname, '..', 'plugins', 'dev');
   const SKILLS_DIR = path.join(PLUGIN_ROOT, 'skills');
   const GATE_PROMPTS_PATH = path.join(PLUGIN_ROOT, 'skills', 'shared', 'gate-prompts.md');
   ```
4. Write helper functions:
   - `getSkillDirs()`: Returns array of skill directory names (excluding 'shared').
     Use `fs.readdirSync(SKILLS_DIR, { withFileTypes: true })` filtering for
     directories that are not 'shared'.
   - `parseAllowedTools(content)`: Extracts the `allowed-tools` value from YAML
     frontmatter. Parse between the first pair of `---` delimiters, find the
     `allowed-tools:` line, split on comma, trim each tool name.
   - `getPatternNames()`: Read gate-prompts.md and extract all pattern slug names
     from `## Pattern: {slug}` headers.
5. Write these test suites:

```javascript
describe('AskUserQuestion skill audit', () => {
  const skillDirs = getSkillDirs();
  const patternNames = getPatternNames();

  // Skills that intentionally do NOT have AskUserQuestion
  const EXCLUDED_SKILLS = ['continue', 'health', 'help', 'pause'];

  test('found expected number of skills (21)', () => {
    expect(skillDirs.length).toBe(21);
  });

  test('excluded skills do not have AskUserQuestion in allowed-tools', () => {
    for (const skillName of EXCLUDED_SKILLS) {
      const skillPath = path.join(SKILLS_DIR, skillName, 'SKILL.md');
      if (!fs.existsSync(skillPath)) continue;
      const content = fs.readFileSync(skillPath, 'utf8');
      const tools = parseAllowedTools(content);
      expect(tools).not.toContain('AskUserQuestion');
    }
  });

  test('non-excluded skills have AskUserQuestion in allowed-tools', () => {
    const missing = [];
    for (const skillName of skillDirs) {
      if (EXCLUDED_SKILLS.includes(skillName)) continue;
      const skillPath = path.join(SKILLS_DIR, skillName, 'SKILL.md');
      if (!fs.existsSync(skillPath)) continue;
      const content = fs.readFileSync(skillPath, 'utf8');
      const tools = parseAllowedTools(content);
      if (!tools.includes('AskUserQuestion')) {
        missing.push(skillName);
      }
    }
    expect(missing).toEqual([]);
  });

  test('no plain-text gate patterns remain (Type approved/continue)', () => {
    const violations = [];
    // Patterns that indicate unconverted gate checks
    const plainTextGates = [
      /→\s*Type\s+"?approved"?/i,
      /→\s*Type\s+"?continue"?/i,
      /→\s*Type\s+"?done"?\s+when/i,
    ];

    for (const skillName of skillDirs) {
      const skillPath = path.join(SKILLS_DIR, skillName, 'SKILL.md');
      if (!fs.existsSync(skillPath)) continue;
      const content = fs.readFileSync(skillPath, 'utf8');

      for (const pattern of plainTextGates) {
        const matches = content.match(pattern);
        if (matches) {
          // Check if this is inside a "do NOT use" or example context
          // (discuss/SKILL.md line 269 explicitly says "do NOT use AskUserQuestion")
          const lines = content.split('\n');
          for (let i = 0; i < lines.length; i++) {
            if (pattern.test(lines[i])) {
              // Check surrounding lines for "do NOT" or "example" context
              const context = lines.slice(Math.max(0, i - 3), i + 4).join('\n');
              if (!/do NOT|freeform|example|Anti-Pattern/i.test(context)) {
                violations.push({
                  skill: skillName,
                  line: i + 1,
                  text: lines[i].trim()
                });
              }
            }
          }
        }
      }
    }

    if (violations.length > 0) {
      const details = violations
        .map(v => `  ${v.skill}/SKILL.md:${v.line} — ${v.text}`)
        .join('\n');
      throw new Error(
        `Found ${violations.length} unconverted plain-text gate(s):\n${details}`
      );
    }
  });

  test('pattern references in skills match actual patterns in gate-prompts.md', () => {
    const unknownRefs = [];

    for (const skillName of skillDirs) {
      const skillPath = path.join(SKILLS_DIR, skillName, 'SKILL.md');
      if (!fs.existsSync(skillPath)) continue;
      const content = fs.readFileSync(skillPath, 'utf8');

      // Look for pattern references: "approve-revise-abort pattern",
      // "**multi-option-failure** pattern", "pattern: yes-no"
      for (const patternName of patternNames) {
        // Skip — we're checking skills reference valid patterns, not all patterns are used
      }

      // Instead, find pattern-like slugs referenced in skills
      const patternRefs = content.match(/(?:pattern[:\s]+|Use\s+(?:the\s+)?(?:\*\*)?)([\w-]+)(?:\*\*)?\s+pattern/gi) || [];
      for (const ref of patternRefs) {
        const slugMatch = ref.match(/([\w-]+)\s+pattern/i);
        if (slugMatch) {
          const slug = slugMatch[1].replace(/\*\*/g, '');
          if (!patternNames.includes(slug) && slug !== 'AskUserQuestion') {
            unknownRefs.push({ skill: skillName, pattern: slug });
          }
        }
      }
    }

    if (unknownRefs.length > 0) {
      const details = unknownRefs
        .map(r => `  ${r.skill}/SKILL.md references unknown pattern: ${r.pattern}`)
        .join('\n');
      throw new Error(
        `Found ${unknownRefs.length} unknown pattern reference(s):\n${details}`
      );
    }
  });
});
```

6. Ensure the test handles edge cases:
   - Skills that mention AskUserQuestion in comments but don't use it (note, todo)
   - Skills that reference patterns by name in prose
   - The "do NOT use AskUserQuestion" markers in discuss/SKILL.md and plan/SKILL.md
  </action>
  <verify>
    npx jest tests/skill-askuserquestion-audit.test.js --verbose
  </verify>
  <done>
    skill-askuserquestion-audit.test.js validates: 21 skills found, excluded skills
    lack AskUserQuestion, non-excluded skills have AskUserQuestion, no unconverted
    plain-text gates remain, and all pattern references point to real patterns.
    All tests pass.
  </done>
</task>

<task id="18-03-T3" type="auto" tdd="false">
  <name>Run full test suite to confirm no regressions</name>
  <files>
  </files>
  <action>
1. Run the full test suite: `npm test`
2. Verify all existing tests pass (335+ existing tests).
3. Verify the 2 new test files pass.
4. If any tests fail:
   - If failures are in the new test files, fix the test logic (likely parsing
     edge cases in gate-prompts.md or SKILL.md frontmatter).
   - If failures are in existing tests (e.g., reference-integrity.test.js might
     fail if the shared/ directory expectations changed), update the test to
     include gate-prompts.md in its expected files list.
5. Run `npm run lint` to verify no linting issues in new test files.
6. Run `npm run validate` to verify plugin structure is valid.
  </action>
  <verify>
    npm test
    npm run lint
    npm run validate
  </verify>
  <done>
    Full test suite passes including all new and existing tests.
    Lint and plugin validation pass. No regressions introduced.
  </done>
</task>

</tasks>
