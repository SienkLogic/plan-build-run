---
phase: "18-reference-docs-and-testing"
plan: "18-01"
type: "docs"
wave: 1
depends_on: []
files_modified:
  - "plugins/dev/references/towline-rules.md"
  - "plugins/dev/references/ui-formatting.md"
autonomous: true
dependency_fingerprints:
  "17-01": "len:3624-mod:2026-02-10T20:16"
  "17-02": "len:4170-mod:2026-02-10T20:19"
  "17-03": "len:3831-mod:2026-02-10T20:19"
discovery: 0
must_haves:
  truths:
    - "towline-rules.md documents AskUserQuestion usage rules"
    - "ui-formatting.md documents AskUserQuestion visual patterns and examples"
  artifacts:
    - "plugins/dev/references/towline-rules.md (updated with User Interaction Patterns section)"
    - "plugins/dev/references/ui-formatting.md (updated with AskUserQuestion Patterns section)"
  key_links:
    - "towline-rules.md references skills/shared/gate-prompts.md as the pattern catalog"
    - "ui-formatting.md references gate-prompts.md header max 12 char rule"
---

# Plan 18-01: Update towline-rules.md and ui-formatting.md with AskUserQuestion Patterns

<objective>
Add AskUserQuestion usage rules and visual pattern documentation to the two primary
reference docs that skill authors and the orchestrator consult during development.
</objective>

<tasks>

<task id="18-01-T1" type="auto" tdd="false">
  <name>Add User Interaction Patterns section to towline-rules.md</name>
  <files>
    plugins/dev/references/towline-rules.md
  </files>
  <action>
1. Read `plugins/dev/references/towline-rules.md` (180 lines).
2. Insert a new section **"User Interaction Patterns"** between the "Agent Spawning"
   section (rules #24-27, ending at line 53) and the "Skill Authoring" section
   (rules #28-33, starting at line 55). Continue the rule numbering from where
   "Agent Spawning" left off (rule 27), so new rules start at #28 and all
   subsequent sections are renumbered.
3. Add these rules (approximately 9 new rules):

```markdown
---

## User Interaction Patterns

28. Use `AskUserQuestion` for all structured gate checks — never plain-text "Type approved" prompts.
29. AskUserQuestion is an orchestrator-only tool. It **cannot** be called from subagents (Task contexts).
30. Max 4 options per AskUserQuestion call. If more options exist, split into a 2-step flow.
31. `header` field must be max 12 characters. Keep it a single word when possible.
32. `multiSelect` is always `false` for Towline gate checks.
33. Always handle the "Other" case — users may type freeform text instead of selecting an option.
34. Reuse patterns from `skills/shared/gate-prompts.md` by name. Do not reinvent prompts inline.
35. Do **not** use AskUserQuestion for freeform text input (symptom gathering, Socratic discussion, open-ended questions). Use plain conversation for those.
36. Skills that do not require user interaction (continue, health, help, pause) intentionally omit AskUserQuestion from allowed-tools.
```

4. Renumber the "Skill Authoring" section rules to start at #37 (was #28) and cascade
   all subsequent rule numbers throughout the document (+9 offset to all rules after
   the insertion point).
5. Update the "Quick Reference: Never Do This" table numbering if it uses rule references
   (it uses its own #1-10 numbering, so no change needed there).
  </action>
  <verify>
    node -e "const c=require('fs').readFileSync('plugins/dev/references/towline-rules.md','utf8'); const a=(c.match(/AskUserQuestion/g)||[]).length; const g=(c.match(/gate-prompts\.md/g)||[]).length; const s=c.includes('User Interaction Patterns'); console.log('AskUserQuestion mentions:', a, '| gate-prompts.md refs:', g, '| Section exists:', s); if(a<5||g<1||!s) process.exit(1);"
  </verify>
  <done>
    towline-rules.md contains a "User Interaction Patterns" section with 9 rules
    covering AskUserQuestion usage, and references skills/shared/gate-prompts.md
    as the pattern catalog.
  </done>
</task>

<task id="18-01-T2" type="auto" tdd="false">
  <name>Add AskUserQuestion Patterns section to ui-formatting.md</name>
  <files>
    plugins/dev/references/ui-formatting.md
  </files>
  <action>
1. Read `plugins/dev/references/ui-formatting.md` (321 lines).
2. Insert a new section **"AskUserQuestion Patterns"** after the "Checkpoint Boxes"
   section (ends at line 134) and before the "Next Up Block" section (starts at
   line 136). This placement is logical: AskUserQuestion replaces the old
   checkpoint-style "Type approved" prompts.
3. Add the following content:

```markdown
---

## AskUserQuestion Patterns

Structured prompts for user decision points. All gate checks use this tool instead of
plain-text "Type approved" prompts. See `skills/shared/gate-prompts.md` for the full
pattern catalog (21 patterns).

### Structure

```
AskUserQuestion:
  question: "{contextual question}"
  header: "{max 12 chars}"
  options:
    - label: "{Option 1}"  description: "{What happens}"
    - label: "{Option 2}"  description: "{What happens}"
  multiSelect: false
```

### Rules

- **Max 4 options** per call. Split into 2-step flow if more are needed.
- **Header max 12 characters.** Single word preferred (e.g., "Approve?", "Confirm", "Scope").
- **multiSelect: false** always. Towline gates require single selection.
- **Handle "Other"**: Users may type freeform text instead of selecting. Skills must handle this gracefully.
- **Orchestrator only**: AskUserQuestion cannot be called from subagents.

### Common Patterns

**Approval gate** (approve-revise-abort):
```
question: "Approve these plans?"
header: "Approve?"
options:
  - label: "Approve"          description: "Proceed with execution"
  - label: "Request changes"  description: "Discuss adjustments before proceeding"
  - label: "Abort"            description: "Cancel this operation"
```

**Simple confirmation** (yes-no):
```
question: "Re-plan this phase with gap context?"
header: "Confirm"
options:
  - label: "Yes"  description: "Create gap-closure plans"
  - label: "No"   description: "Skip re-planning"
```

**Category selection** (settings-category-select):
```
question: "What would you like to configure?"
header: "Configure"
options:
  - label: "Depth"          description: "quick/standard/comprehensive"
  - label: "Model profile"  description: "quality/balanced/budget/adaptive"
  - label: "Features"       description: "Toggle workflow features and gates"
  - label: "Git settings"   description: "branching strategy, commit mode"
```

**Dynamic routing** (action-routing):
```
question: "What would you like to do next?"
header: "Next Step"
options:
  - label: "/dev:build 3"    description: "Execute phase 3 plans"
  - label: "/dev:review 2"   description: "Verify phase 2 results"
  - label: "Something else"  description: "Enter a different command"
```

### When NOT to Use

Do not use AskUserQuestion for:
- Freeform text input (symptom descriptions, task descriptions, open questions)
- Socratic discussion (explore, discuss follow-ups)
- Situations with unbounded response space

Use plain conversational prompts for these cases instead.
```

4. Verify that the "Anti-Patterns" section at the bottom still reads correctly after
   the insertion (no formatting breaks).
  </action>
  <verify>
    node -e "const c=require('fs').readFileSync('plugins/dev/references/ui-formatting.md','utf8'); const a=(c.match(/AskUserQuestion/g)||[]).length; const g=c.includes('gate-prompts.md'); const s=c.includes('AskUserQuestion Patterns'); console.log('AskUserQuestion mentions:', a, '| gate-prompts.md ref:', g, '| Section exists:', s); if(a<5||!g||!s) process.exit(1);"
  </verify>
  <done>
    ui-formatting.md contains an "AskUserQuestion Patterns" section with structure
    definition, rules, 4 common pattern examples, and a "When NOT to Use" subsection.
  </done>
</task>

</tasks>
