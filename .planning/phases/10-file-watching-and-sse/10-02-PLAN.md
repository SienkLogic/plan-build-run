---
phase: "10-file-watching-and-sse"
plan: "10-02"
type: "feature"
wave: 2
depends_on: ["10-01"]
files_modified:
  - "public/js/sse-client.js"
  - "src/views/partials/layout-bottom.ejs"
  - "src/views/partials/footer.ejs"
  - "public/css/layout.css"
autonomous: true
discovery: 0
must_haves:
  truths:
    - "Browser establishes an EventSource connection to /api/events/stream on every page"
    - "On receiving a file-change event, the browser reloads the current page"
    - "EventSource auto-reconnects on network disconnect (built-in browser behavior)"
    - "A connection status indicator shows green dot when connected, gray when disconnected"
    - "The SSE client script loads on every page via layout-bottom.ejs"
  artifacts:
    - "public/js/sse-client.js with EventSource connection and file-change handler"
    - "src/views/partials/layout-bottom.ejs updated with script tag"
    - "src/views/partials/footer.ejs updated with #sse-status indicator element"
    - "public/css/layout.css updated with connection status indicator styles"
  key_links:
    - "layout-bottom.ejs includes a script tag pointing to /js/sse-client.js"
    - "sse-client.js creates EventSource('/api/events/stream')"
    - "sse-client.js listens for 'file-change' event and calls window.location.reload()"
    - "sse-client.js updates the connection status indicator on open/error events"
---

# Plan 10-02: Browser EventSource Client and Connection Status Indicator

## Overview

Add the client-side JavaScript that connects to the SSE endpoint and reloads the page
when file changes are detected. The script is loaded on every page via layout-bottom.ejs.
A small connection status indicator in the footer shows whether the SSE connection is
active (green dot) or disconnected (gray dot).

This is a simple full-page reload approach. HTMX partial content loading will replace
this in Phase 11.

## Tasks

<task id="10-02-T1" type="auto">
  <name>Create SSE client script and update layout-bottom.ejs to load it</name>
  <files>
    public/js/sse-client.js
    src/views/partials/layout-bottom.ejs
  </files>
  <action>
1. Create directory `public/js/` in the test project if it does not exist.

2. Create `public/js/sse-client.js` with the following content:
   ```javascript
   /**
    * SSE client for live dashboard updates.
    * Connects to the SSE endpoint and reloads the page when .planning/ files change.
    * Auto-reconnects on disconnect (built-in EventSource behavior).
    */
   (function () {
     'use strict';

     var indicator = document.getElementById('sse-status');
     var eventSource = new EventSource('/api/events/stream');

     function setConnected(connected) {
       if (!indicator) return;
       indicator.setAttribute('data-connected', connected ? 'true' : 'false');
       indicator.setAttribute('title', connected ? 'Live: connected' : 'Live: disconnected');
     }

     eventSource.onopen = function () {
       console.log('[SSE] Connected to /api/events/stream');
       setConnected(true);
     };

     eventSource.addEventListener('file-change', function (event) {
       var data = JSON.parse(event.data);
       console.log('[SSE] File changed:', data.path, '(' + data.type + ')');
       window.location.reload();
     });

     eventSource.onerror = function () {
       if (eventSource.readyState === EventSource.CLOSED) {
         console.error('[SSE] Connection closed permanently');
         setConnected(false);
       } else if (eventSource.readyState === EventSource.CONNECTING) {
         console.log('[SSE] Reconnecting...');
         setConnected(false);
       }
     };
   })();
   ```

   Key points:
   - Wrapped in IIFE to avoid polluting global scope
   - Uses `var` and `function` syntax (no build step, must work in all browsers)
   - `window.location.reload()` is the simplest approach; HTMX replaces this in Phase 11
   - `onopen` sets the indicator to connected
   - `onerror` sets indicator to disconnected and logs reconnection attempts
   - EventSource.CONNECTING state means the browser is auto-reconnecting (no manual retry needed)
   - EventSource.CLOSED means a fatal error occurred (HTTP error status from server)
   - The `[SSE]` prefix in console logs makes it easy to filter in browser DevTools

3. Open `src/views/partials/layout-bottom.ejs` and replace its entire contents with:
   ```ejs
       </main>
       <%- include('footer') %>
     </div>
     <script src="/js/sse-client.js"></script>
   </body>
   </html>
   ```

   Key changes from Phase 03 version:
   - Added `<script src="/js/sse-client.js"></script>` AFTER the closing `</div>` and BEFORE `</body>`
   - Script is placed at the end of the body (after all page content) for fast page rendering
   - The `/js/` path is served by express.static from the public/ directory
   - Every page that uses layout-bottom.ejs (which is all pages) will load the SSE client
  </action>
  <verify>
    node -e "const fs = require('fs'); const js = fs.readFileSync('D:/Repos/towline-test-project/public/js/sse-client.js','utf-8'); const lb = fs.readFileSync('D:/Repos/towline-test-project/src/views/partials/layout-bottom.ejs','utf-8'); if (!js.includes('EventSource')) throw new Error('sse-client.js missing EventSource'); if (!js.includes('file-change')) throw new Error('sse-client.js missing file-change listener'); if (!js.includes('window.location.reload')) throw new Error('sse-client.js missing reload'); if (!js.includes('sse-status')) throw new Error('sse-client.js missing status indicator reference'); if (!lb.includes('sse-client.js')) throw new Error('layout-bottom.ejs missing script tag'); console.log('PASS: SSE client script and layout-bottom.ejs are wired correctly');"
  </verify>
  <done>
    Every page loads the SSE client script via layout-bottom.ejs. The browser establishes an EventSource connection to /api/events/stream, and file-change events trigger a full page reload.
  </done>
</task>

<task id="10-02-T2" type="auto">
  <name>Add connection status indicator to footer and CSS styles</name>
  <files>
    src/views/partials/footer.ejs
    public/css/layout.css
  </files>
  <action>
1. Open `src/views/partials/footer.ejs` and replace its entire contents with:
   ```ejs
   <footer>
     <small>Towline Dashboard v0.1.0</small>
     <span id="sse-status" data-connected="false" title="Live: disconnected"></span>
   </footer>
   ```

   Key points:
   - The `#sse-status` span is the connection indicator targeted by sse-client.js
   - Starts as `data-connected="false"` (disconnected) until EventSource connects
   - `title` attribute provides hover text describing the connection state
   - The sse-client.js script updates both `data-connected` and `title` dynamically

2. Open `public/css/layout.css` and add the following styles at the end of the file:

   ```css

   /* SSE connection status indicator */
   #sse-status {
     display: inline-block;
     width: 8px;
     height: 8px;
     border-radius: 50%;
     margin-left: 0.5rem;
     vertical-align: middle;
     transition: background-color 0.3s ease;
   }

   #sse-status[data-connected="true"] {
     background-color: var(--status-complete);
   }

   #sse-status[data-connected="false"] {
     background-color: var(--status-not-started);
   }
   ```

   Key points:
   - 8px circle (small, unobtrusive) in the footer next to the version text
   - Reuses `--status-complete` (green) and `--status-not-started` (gray) from status-colors.css
   - CSS transition provides a smooth color change when connection state changes
   - `vertical-align: middle` aligns the dot with the footer text
  </action>
  <verify>
    node -e "const fs = require('fs'); const f = fs.readFileSync('D:/Repos/towline-test-project/src/views/partials/footer.ejs','utf-8'); const c = fs.readFileSync('D:/Repos/towline-test-project/public/css/layout.css','utf-8'); if (!f.includes('sse-status')) throw new Error('footer.ejs missing sse-status element'); if (!f.includes('data-connected')) throw new Error('footer.ejs missing data-connected attribute'); if (!c.includes('#sse-status')) throw new Error('layout.css missing sse-status styles'); if (!c.includes('data-connected')) throw new Error('layout.css missing data-connected selector'); console.log('PASS: connection status indicator in footer with CSS styles');" && npx --prefix D:/Repos/towline-test-project vitest run --reporter=verbose
  </verify>
  <done>
    Footer displays a small connection status indicator dot: green when SSE is connected, gray when disconnected. All existing tests still pass (no regressions from template changes).
  </done>
</task>
