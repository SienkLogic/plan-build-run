<!-- Source: agents/towline-codebase-mapper.md | Purpose: Output format for ARCHITECTURE.md codebase analysis -->
# Architecture

> Analyzed: {date}
> Pattern: {MVC / Layered / Hexagonal / Microservices / Monolith / etc.}

## Pattern Overview

{2-3 paragraphs describing the overall architectural pattern with evidence from the codebase}

**Evidence**: {file paths, import patterns, directory structure that support this classification}

## Layers

| Layer | Purpose | Directory | Key Files |
|-------|---------|-----------|-----------|
| {Presentation} | {UI rendering} | {src/components/} | {App.tsx, Layout.tsx} |
| {API/Routes} | {HTTP handling} | {src/routes/ or src/app/api/} | {users.ts, auth.ts} |
| {Business Logic} | {Core domain} | {src/services/} | {UserService.ts} |
| {Data Access} | {Database interaction} | {src/repositories/ or src/db/} | {UserRepo.ts} |
| {Infrastructure} | {External services} | {src/lib/ or src/integrations/} | {email.ts, storage.ts} |

### Layer Rules

{How layers communicate — what imports what? What are the dependency rules?}

```
Presentation → API → Business → Data Access → Database
                ↓
            Infrastructure
```

## Data Flow

### Request Lifecycle

{How a typical request flows through the system}

```
1. Client sends request
2. → {Router/Framework} routes to handler
3. → {Middleware} runs (auth, validation, logging)
4. → {Controller/Handler} processes request
5. → {Service} executes business logic
6. → {Repository/Model} queries database
7. → Response returns through the stack
```

### State Management

| Context | Approach | Implementation | Files |
|---------|----------|---------------|-------|
| Client state | {Redux / Zustand / Context / etc.} | {how it's structured} | {store files} |
| Server state | {React Query / SWR / etc.} | {how it's used} | {hook files} |
| Session state | {JWT / cookies / etc.} | {how it's managed} | {auth files} |

## Key Abstractions

| Abstraction | Purpose | Implementation | Used By |
|-------------|---------|---------------|---------|
| {Repository} | {Database access} | {Abstract class + implementations} | {Services} |
| {Middleware} | {Cross-cutting concerns} | {Function signature} | {Routes} |
| {DTO/Schema} | {Data validation} | {Zod schemas / class-validator} | {Routes, Services} |

## Entry Points

| Type | File | Config | Notes |
|------|------|--------|-------|
| Web app | {src/app/page.tsx} | {port 3000} | {Next.js App Router} |
| API server | {src/server.ts} | {port 8080} | {Express server} |
| CLI | {src/cli.ts} | - | {Commander.js} |
| Workers | {src/workers/} | {queue config} | {Bull/BullMQ} |
| Cron | {src/cron/} | {schedule} | {node-cron} |

## Error Handling Strategy

| Layer | Pattern | Implementation |
|-------|---------|---------------|
| API | {Error middleware + HTTP status codes} | {src/middleware/error.ts} |
| Service | {Custom error classes} | {src/errors/} |
| Client | {Error boundaries + toast notifications} | {src/components/ErrorBoundary.tsx} |

### Error Flow

```
Service throws AppError → Controller catches → Error middleware formats response → Client displays
```

## Security Architecture

| Aspect | Implementation | Files |
|--------|---------------|-------|
| Authentication | {how auth works} | {files} |
| Authorization | {RBAC / ABAC / etc.} | {files} |
| Input validation | {where and how} | {files} |
| CORS | {configuration} | {files} |
| Rate limiting | {if present} | {files} |
| CSRF protection | {if present} | {files} |
