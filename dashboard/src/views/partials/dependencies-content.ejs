<%- include('breadcrumbs', { breadcrumbs: typeof breadcrumbs !== 'undefined' ? breadcrumbs : [] }) %>

<h1>Phase Dependencies</h1>

<% if (typeof mermaidCode !== 'undefined' && mermaidCode && mermaidCode.trim()) { %>
<article>
  <pre class="mermaid"><%= mermaidCode %></pre>
</article>
<% } else { %>
<%- include('empty-state', { icon: 'ðŸ”—', title: 'No dependency data available', action: '' }) %>
<% } %>

<script src="https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.min.js"></script>
<script>
  (function() {
    function detectDark() {
      var explicit = document.documentElement.dataset.theme;
      if (explicit) return explicit === 'dark';
      return window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
    }
    var mermaidTheme = detectDark() ? 'dark' : 'default';

    // Store original source before mermaid processes it
    document.querySelectorAll('.mermaid').forEach(function(el) {
      el.dataset.source = el.textContent;
    });

    mermaid.initialize({ startOnLoad: true, theme: mermaidTheme, securityLevel: 'loose' });

    // Watch for theme changes and re-render
    var observer = new MutationObserver(function(mutations) {
      mutations.forEach(function(mutation) {
        if (mutation.attributeName === 'data-theme') {
          var newTheme = detectDark() ? 'dark' : 'default';
          mermaid.initialize({ startOnLoad: false, theme: newTheme, securityLevel: 'loose' });
          document.querySelectorAll('.mermaid').forEach(function(el) {
            if (el.dataset.source) {
              el.removeAttribute('data-processed');
              el.innerHTML = el.dataset.source;
            }
          });
          mermaid.run();
        }
      });
    });
    observer.observe(document.documentElement, { attributes: true, attributeFilter: ['data-theme'] });
  })();
</script>
