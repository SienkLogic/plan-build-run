<%- include('breadcrumbs', { breadcrumbs: typeof breadcrumbs !== 'undefined' ? breadcrumbs : [] }) %>
<h1>Todos</h1>

<p><a href="/todos/new" role="button"
      hx-get="/todos/new"
      hx-target="#main-content"
      hx-push-url="true">Create Todo</a></p>

<% const f = typeof filters !== 'undefined' ? filters : { priority: '', status: '', q: '' }; %>
<article>
  <form hx-get="/todos" hx-target="#main-content" hx-push-url="true">
    <div class="grid">
      <label>
        Priority
        <select name="priority" onchange="this.form.requestSubmit()">
          <option value="">All</option>
          <option value="P0"<%= f.priority === 'P0' ? ' selected' : '' %>>P0</option>
          <option value="P1"<%= f.priority === 'P1' ? ' selected' : '' %>>P1</option>
          <option value="P2"<%= f.priority === 'P2' ? ' selected' : '' %>>P2</option>
          <option value="PX"<%= f.priority === 'PX' ? ' selected' : '' %>>PX</option>
        </select>
      </label>
      <label>
        Status
        <select name="status" onchange="this.form.requestSubmit()">
          <option value="">All</option>
          <option value="pending"<%= f.status === 'pending' ? ' selected' : '' %>>pending</option>
        </select>
      </label>
      <label>
        Search
        <input type="search" name="q" value="<%= f.q %>" placeholder="Search titles..."
               hx-get="/todos" hx-target="#main-content" hx-push-url="true"
               hx-trigger="keyup changed delay:300ms, search" hx-include="closest form">
      </label>
    </div>
  </form>
</article>

<% if (todos.length > 0) { %>
<p>
  <button class="secondary"
          hx-post="/todos/bulk-complete?priority=<%= encodeURIComponent(f.priority) %>&status=<%= encodeURIComponent(f.status) %>&q=<%= encodeURIComponent(f.q) %>"
          hx-target="#main-content"
          hx-confirm="Complete all <%= todos.length %> visible todo(s)?">
    Complete All Visible (<%= todos.length %>)
  </button>
</p>
<article>
  <div class="table-wrap">
  <table>
    <thead>
      <tr>
        <th scope="col">ID</th>
        <th scope="col">Title</th>
        <th scope="col">Priority</th>
        <th scope="col">Phase</th>
        <th scope="col">Status</th>
        <th scope="col">Created</th>
      </tr>
    </thead>
    <tbody>
      <% todos.forEach(function(todo) { %>
      <tr>
        <td><%= todo.id %></td>
        <td>
          <a href="/todos/<%= todo.id %>">
            <%= todo.title %>
          </a>
        </td>
        <td>
          <span class="status-badge" data-priority="<%= todo.priority %>">
            <%= todo.priority %>
          </span>
        </td>
        <td><%= todo.phase %></td>
        <td>
          <span class="status-badge" data-status="<%= todo.status %>">
            <%= todo.status %>
          </span>
        </td>
        <td><%= todo.created %></td>
      </tr>
      <% }); %>
    </tbody>
  </table>
  </div>
</article>
<% } else { %>
<article>
  <p>No pending todos found. Add a todo file to <code>.planning/todos/pending/</code> to see it here.</p>
</article>
<% } %>
