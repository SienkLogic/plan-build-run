<div class="config-page">
  <div class="page-header">
    <h1>Config</h1>
    <p class="subtitle">Manage <code>.planning/config.json</code></p>
  </div>

  <% if (!config || !config.version) { %>
    <div class="card">
      <div class="card-body">
        <p>No <code>.planning/config.json</code> found for this project.</p>
      </div>
    </div>
  <% } else { %>

  <form
    hx-post="/api/config"
    hx-target="#config-feedback"
    hx-swap="innerHTML"
    id="config-form"
  >
    <%# ── Common Settings ─────────────────────────────────────────── %>
    <details class="card mb-3" open>
      <summary class="card-header" style="cursor:pointer;list-style:none">
        <h2 class="card-title mb-0">Common Settings</h2>
      </summary>
      <div class="card-body">

        <%# Mode & Depth %>
        <div class="mb-3 row">
          <label for="cfg-mode" class="col-sm-3 col-form-label">Mode</label>
          <div class="col-sm-9">
            <select id="cfg-mode" name="mode" class="form-select">
              <% ['normal', 'autonomous', 'strict', 'relaxed'].forEach(opt => { %>
                <option value="<%= opt %>" <%= config.mode === opt ? 'selected' : '' %>><%= opt %></option>
              <% }); %>
            </select>
          </div>
        </div>

        <div class="mb-3 row">
          <label for="cfg-depth" class="col-sm-3 col-form-label">Depth</label>
          <div class="col-sm-9">
            <select id="cfg-depth" name="depth" class="form-select">
              <% ['minimal', 'standard', 'comprehensive'].forEach(opt => { %>
                <option value="<%= opt %>" <%= config.depth === opt ? 'selected' : '' %>><%= opt %></option>
              <% }); %>
            </select>
          </div>
        </div>

        <div class="mb-3 row">
          <label for="cfg-context-strategy" class="col-sm-3 col-form-label">Context Strategy</label>
          <div class="col-sm-9">
            <select id="cfg-context-strategy" name="context_strategy" class="form-select">
              <% ['conservative', 'balanced', 'aggressive'].forEach(opt => { %>
                <option value="<%= opt %>" <%= config.context_strategy === opt ? 'selected' : '' %>><%= opt %></option>
              <% }); %>
            </select>
          </div>
        </div>

        <%# Features toggles %>
        <% if (config.features && typeof config.features === 'object') { %>
        <fieldset class="mb-3 p-3 border rounded">
          <legend>Features</legend>
          <% for (const [key, val] of Object.entries(config.features)) { %>
          <div class="mb-2">
            <label class="form-check form-switch">
              <input class="form-check-input" type="checkbox" name="features.<%= key %>" value="on" <%= val ? 'checked' : '' %> />
              <span class="form-check-label"><%= key %></span>
            </label>
          </div>
          <% } %>
        </fieldset>
        <% } %>

        <%# Gates toggles %>
        <% if (config.gates && typeof config.gates === 'object') { %>
        <fieldset class="mb-3 p-3 border rounded">
          <legend>Gates</legend>
          <% for (const [key, val] of Object.entries(config.gates)) { %>
          <div class="mb-2">
            <label class="form-check form-switch">
              <input class="form-check-input" type="checkbox" name="gates.<%= key %>" value="on" <%= val ? 'checked' : '' %> />
              <span class="form-check-label"><%= key %></span>
            </label>
          </div>
          <% } %>
        </fieldset>
        <% } %>

        <%# Safety toggles %>
        <% if (config.safety && typeof config.safety === 'object') { %>
        <fieldset class="mb-3 p-3 border rounded">
          <legend>Safety</legend>
          <% for (const [key, val] of Object.entries(config.safety)) { %>
          <div class="mb-2">
            <label class="form-check form-switch">
              <input class="form-check-input" type="checkbox" name="safety.<%= key %>" value="on" <%= val ? 'checked' : '' %> />
              <span class="form-check-label"><%= key %></span>
            </label>
          </div>
          <% } %>
        </fieldset>
        <% } %>

        <%# Model selections %>
        <% if (config.models && typeof config.models === 'object') { %>
        <fieldset class="mb-3 p-3 border rounded">
          <legend>Models</legend>
          <% for (const [key, val] of Object.entries(config.models)) { %>
          <div class="mb-3 row">
            <label for="cfg-model-<%= key %>" class="col-sm-3 col-form-label"><%= key %></label>
            <div class="col-sm-9">
              <input
                id="cfg-model-<%= key %>"
                type="text"
                name="models.<%= key %>"
                value="<%= val %>"
                class="form-control"
              />
            </div>
          </div>
          <% } %>
        </fieldset>
        <% } %>

        <%# Parallelization inputs (toggles for booleans, number for numbers) %>
        <% if (config.parallelization && typeof config.parallelization === 'object') { %>
        <fieldset class="mb-3 p-3 border rounded">
          <legend>Parallelization</legend>
          <% for (const [key, val] of Object.entries(config.parallelization)) { %>
          <% if (typeof val === 'boolean') { %>
          <div class="mb-2">
            <label class="form-check form-switch">
              <input class="form-check-input" type="checkbox" name="parallelization.<%= key %>" value="on" <%= val ? 'checked' : '' %> />
              <span class="form-check-label"><%= key %></span>
            </label>
          </div>
          <% } else if (typeof val === 'number') { %>
          <div class="mb-3 row">
            <label for="cfg-par-<%= key %>" class="col-sm-3 col-form-label"><%= key %></label>
            <div class="col-sm-9">
              <input id="cfg-par-<%= key %>" type="number" name="parallelization.<%= key %>" value="<%= val %>" min="1" class="form-control" />
            </div>
          </div>
          <% } else { %>
          <div class="mb-3 row">
            <label for="cfg-par-<%= key %>" class="col-sm-3 col-form-label"><%= key %></label>
            <div class="col-sm-9">
              <input id="cfg-par-<%= key %>" type="text" name="parallelization.<%= key %>" value="<%= val %>" class="form-control" />
            </div>
          </div>
          <% } %>
          <% } %>
        </fieldset>
        <% } %>

        <%# Planning inputs (toggles for booleans, number for numbers) %>
        <% if (config.planning && typeof config.planning === 'object') { %>
        <fieldset class="mb-3 p-3 border rounded">
          <legend>Planning</legend>
          <% for (const [key, val] of Object.entries(config.planning)) { %>
          <% if (typeof val === 'boolean') { %>
          <div class="mb-2">
            <label class="form-check form-switch">
              <input class="form-check-input" type="checkbox" name="planning.<%= key %>" value="on" <%= val ? 'checked' : '' %> />
              <span class="form-check-label"><%= key %></span>
            </label>
          </div>
          <% } else if (typeof val === 'number') { %>
          <div class="mb-3 row">
            <label for="cfg-plan-<%= key %>" class="col-sm-3 col-form-label"><%= key %></label>
            <div class="col-sm-9">
              <input id="cfg-plan-<%= key %>" type="number" name="planning.<%= key %>" value="<%= val %>" class="form-control" />
            </div>
          </div>
          <% } else { %>
          <div class="mb-3 row">
            <label for="cfg-plan-<%= key %>" class="col-sm-3 col-form-label"><%= key %></label>
            <div class="col-sm-9">
              <input id="cfg-plan-<%= key %>" type="text" name="planning.<%= key %>" value="<%= val %>" class="form-control" />
            </div>
          </div>
          <% } %>
          <% } %>
        </fieldset>
        <% } %>

      </div><%# end card-body %>
    </details>

    <%# ── Advanced (raw JSON) ─────────────────────────────────────── %>
    <details class="card mb-3">
      <summary class="card-header" style="cursor:pointer;list-style:none">
        <h2 class="card-title mb-0">Advanced (Raw JSON)</h2>
      </summary>
      <div class="card-body">
        <p class="config-hint">Edit the full config as JSON. On save, this value overrides the form above.</p>
        <textarea
          id="cfg-raw-json"
          name="rawJson"
          class="form-control config-raw-json font-monospace"
          rows="24"
          spellcheck="false"
        ><%= JSON.stringify(config, null, 2) %></textarea>
        <p class="config-hint">Tip: clear this field to save using the form controls above.</p>
      </div>
    </details>

    <div class="config-actions">
      <button type="submit" class="btn btn-primary">Save Config</button>
      <span id="config-feedback"></span>
    </div>

  </form>

  <% } %>
</div>
