<%- include('breadcrumbs', { breadcrumbs: typeof breadcrumbs !== 'undefined' ? breadcrumbs : [] }) %>
<h1>Milestones</h1>

<%
  // Filter out milestones that the parser already flagged as completed (collapsed in ROADMAP.md)
  var nonCollapsed = active.filter(function(m) { return !m.completed; });

  // From non-collapsed, separate truly active from ones whose phases are all complete
  var trulyActive = nonCollapsed.filter(function(m) {
    var msPhases = (typeof phases !== 'undefined' && phases) ? phases.filter(function(p) { return p.id >= m.startPhase && p.id <= m.endPhase; }) : [];
    var completedPhases = msPhases.filter(function(p) { return p.status === 'complete'; }).length;
    return msPhases.length === 0 || completedPhases < msPhases.length;
  });
  var completedNotArchived = nonCollapsed.filter(function(m) {
    var msPhases = (typeof phases !== 'undefined' && phases) ? phases.filter(function(p) { return p.id >= m.startPhase && p.id <= m.endPhase; }) : [];
    var completedPhases = msPhases.filter(function(p) { return p.status === 'complete'; }).length;
    return msPhases.length > 0 && completedPhases >= msPhases.length;
  });
%>

<% if (trulyActive.length > 0) { %>
<h2>Active</h2>
<% trulyActive.forEach(function(m) {
  var msPhases = (typeof phases !== 'undefined' && phases) ? phases.filter(function(p) { return p.id >= m.startPhase && p.id <= m.endPhase; }) : [];
  var totalPhases = msPhases.length;
  var completedPhases = msPhases.filter(function(p) { return p.status === 'complete'; }).length;
%>
<div class="card mb-3">
  <div class="card-header">
    <strong><%= m.name %></strong>
    <% if (m.goal) { %><small> &mdash; <%= m.goal %></small><% } %>
  </div>
  <div class="card-body">
    <p>
      Phases <%= m.startPhase %> &ndash; <%= m.endPhase %>
    </p>
    <% if (totalPhases > 0) { %>
    <div class="progress mb-2" style="height:0.5rem">
      <div class="progress-bar" role="progressbar"
           style="width:<%= completedPhases / totalPhases * 100 %>%"
           aria-valuenow="<%= completedPhases %>" aria-valuemin="0" aria-valuemax="<%= totalPhases %>">
      </div>
    </div>
    <p><small><%= completedPhases %> of <%= totalPhases %> phases complete</small></p>
    <% } %>
  </div>
</div>
<% }); %>
<% } %>

<% if (completedNotArchived.length > 0) { %>
<h2>Completed (Pending Archive)</h2>
<% completedNotArchived.forEach(function(m) { %>
<div class="card mb-3">
  <div class="card-header">
    <strong><%= m.name %></strong>
    <span class="status-badge status-badge--sm" data-status="complete" style="float:right">completed</span>
  </div>
  <div class="card-body">
    <p>Phases <%= m.startPhase %> &ndash; <%= m.endPhase %></p>
  </div>
</div>
<% }); %>
<% } %>

<% if (archived.length > 0) { %>
<h2>Archived</h2>
<div class="card mb-3">
  <div class="table-responsive">
  <table class="table table-vcenter">
    <thead>
      <tr>
        <th scope="col">Version</th>
        <th scope="col">Name</th>
        <th scope="col">Date</th>
        <th scope="col">Duration</th>
        <th scope="col">Phases</th>
        <th scope="col">Commits</th>
      </tr>
    </thead>
    <tbody>
      <% archived.forEach(function(m) { %>
      <tr>
        <td colspan="6" style="padding:0">
          <details>
            <summary style="padding:0.5rem 1rem;cursor:pointer">
              <div class="row g-2" style="width:100%">
                <div class="col-auto" style="min-width:60px"><a href="/milestones/<%= m.version %>"
                     hx-get="/milestones/<%= m.version %>"
                     hx-target="#main-content"
                     hx-push-url="true">v<%= m.version %></a></div>
                <div class="col" style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis"><%= m.name %></div>
                <div class="col-auto"><%= m.date || 'â€”' %></div>
                <div class="col-auto"><%= m.duration || 'â€”' %></div>
                <div class="col-auto"><%= m.stats && m.stats.phaseCount ? m.stats.phaseCount : 'â€”' %></div>
                <div class="col-auto"><%= m.stats && m.stats.commitCount ? m.stats.commitCount : 'â€”' %></div>
              </div>
            </summary>
            <div style="padding:0.5rem 1rem 1rem">
              <% if (m.stats && m.stats.statsHtml) { %>
              <div><%= m.stats.statsHtml %></div>
              <% } %>
              <% if (m.stats && m.stats.deliverables && m.stats.deliverables.length > 0) { %>
              <h4>Deliverables</h4>
              <ul>
                <% m.stats.deliverables.forEach(function(d) { %>
                <li><a href="/milestones/<%= m.version %>"
                       hx-get="/milestones/<%= m.version %>"
                       hx-target="#main-content"
                       hx-push-url="true"><%= d %></a></li>
                <% }); %>
              </ul>
              <% } %>
            </div>
          </details>
        </td>
      </tr>
      <% }); %>
    </tbody>
  </table>
  </div>
</div>
<% } %>

<% if (active.length === 0 && archived.length === 0) { %>
<%- include('empty-state', { icon: 'ðŸš©', title: 'No milestones yet', action: '' }) %>
<% } %>
