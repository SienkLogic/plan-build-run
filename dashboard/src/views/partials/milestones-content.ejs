<%- include('breadcrumbs', { breadcrumbs: typeof breadcrumbs !== 'undefined' ? breadcrumbs : [] }) %>
<h1>Milestones</h1>

<%
  // Filter out milestones that the parser already flagged as completed (collapsed in ROADMAP.md)
  var nonCollapsed = active.filter(function(m) { return !m.completed; });

  // From non-collapsed, separate truly active from ones whose phases are all complete
  var trulyActive = nonCollapsed.filter(function(m) {
    var msPhases = (typeof phases !== 'undefined' && phases) ? phases.filter(function(p) { return p.id >= m.startPhase && p.id <= m.endPhase; }) : [];
    var completedPhases = msPhases.filter(function(p) { return p.status === 'complete'; }).length;
    return msPhases.length === 0 || completedPhases < msPhases.length;
  });
  var completedNotArchived = nonCollapsed.filter(function(m) {
    var msPhases = (typeof phases !== 'undefined' && phases) ? phases.filter(function(p) { return p.id >= m.startPhase && p.id <= m.endPhase; }) : [];
    var completedPhases = msPhases.filter(function(p) { return p.status === 'complete'; }).length;
    return msPhases.length > 0 && completedPhases >= msPhases.length;
  });
%>

<% if (trulyActive.length > 0) { %>
<h2>Active</h2>
<% trulyActive.forEach(function(m) {
  var msPhases = (typeof phases !== 'undefined' && phases) ? phases.filter(function(p) { return p.id >= m.startPhase && p.id <= m.endPhase; }) : [];
  var totalPhases = msPhases.length;
  var completedPhases = msPhases.filter(function(p) { return p.status === 'complete'; }).length;
%>
<article>
  <header>
    <strong><%= m.name %></strong>
    <% if (m.goal) { %><small> &mdash; <%= m.goal %></small><% } %>
  </header>
  <p>
    Phases <%= m.startPhase %> &ndash; <%= m.endPhase %>
  </p>
  <% if (totalPhases > 0) { %>
  <progress value="<%= completedPhases %>" max="<%= totalPhases %>"></progress>
  <p><small><%= completedPhases %> of <%= totalPhases %> phases complete</small></p>
  <% } %>
</article>
<% }); %>
<% } %>

<% if (completedNotArchived.length > 0) { %>
<h2>Completed (Pending Archive)</h2>
<% completedNotArchived.forEach(function(m) { %>
<article>
  <header>
    <strong><%= m.name %></strong>
    <span class="status-badge status-badge--sm" data-status="complete" style="float:right">completed</span>
  </header>
  <p>Phases <%= m.startPhase %> &ndash; <%= m.endPhase %></p>
</article>
<% }); %>
<% } %>

<% if (archived.length > 0) { %>
<h2>Archived</h2>
<article>
  <div class="table-wrap">
  <table>
    <thead>
      <tr>
        <th scope="col">Version</th>
        <th scope="col">Name</th>
        <th scope="col">Date</th>
        <th scope="col">Duration</th>
        <th scope="col">Phases</th>
        <th scope="col">Commits</th>
      </tr>
    </thead>
    <tbody>
      <% archived.forEach(function(m) { %>
      <tr>
        <td colspan="6" style="padding:0">
          <details>
            <summary style="padding:0.5rem 1rem;cursor:pointer">
              <span class="grid" style="display:inline-grid;grid-template-columns:60px 2fr 1fr 1fr 60px 60px;width:100%;text-align:left;gap:var(--space-sm)">
                <span><a href="/milestones/<%= m.version %>"
                         hx-get="/milestones/<%= m.version %>"
                         hx-target="#main-content"
                         hx-push-url="true">v<%= m.version %></a></span>
                <span style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis"><%= m.name %></span>
                <span><%= m.date || 'â€”' %></span>
                <span><%= m.duration || 'â€”' %></span>
                <span><%= m.stats && m.stats.phaseCount ? m.stats.phaseCount : 'â€”' %></span>
                <span><%= m.stats && m.stats.commitCount ? m.stats.commitCount : 'â€”' %></span>
              </span>
            </summary>
            <div style="padding:0.5rem 1rem 1rem">
              <% if (m.stats && m.stats.statsHtml) { %>
              <div><%= m.stats.statsHtml %></div>
              <% } %>
              <% if (m.stats && m.stats.deliverables && m.stats.deliverables.length > 0) { %>
              <h4>Deliverables</h4>
              <ul>
                <% m.stats.deliverables.forEach(function(d) { %>
                <li><a href="/milestones/<%= m.version %>"
                       hx-get="/milestones/<%= m.version %>"
                       hx-target="#main-content"
                       hx-push-url="true"><%= d %></a></li>
                <% }); %>
              </ul>
              <% } %>
            </div>
          </details>
        </td>
      </tr>
      <% }); %>
    </tbody>
  </table>
  </div>
</article>
<% } %>

<% if (active.length === 0 && archived.length === 0) { %>
<%- include('empty-state', { icon: 'ðŸš©', title: 'No milestones yet', action: '' }) %>
<% } %>
