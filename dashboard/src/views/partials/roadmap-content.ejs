<%- include('breadcrumbs', { breadcrumbs: typeof breadcrumbs !== 'undefined' ? breadcrumbs : [] }) %>
<h1>Project Roadmap</h1>

<% if (phases.length === 0 && (typeof milestones === 'undefined' || milestones.length === 0)) { %>
<div class="card mb-3">
  <div class="card-body">
    <p>No phases found. Add a ROADMAP.md file to your .planning/ directory to see the roadmap here.</p>
  </div>
</div>
<% } else if (phases.length === 0 && typeof milestones !== 'undefined' && milestones.length > 0) { %>
<!-- All milestones completed â€” show summary -->
<div class="card mb-3">
  <div class="card-header"><strong>All Milestones Completed</strong></div>
  <div class="card-body">
    <p>All phases have been archived into milestones.</p>
  </div>
</div>
<% milestones.forEach(function(ms) { %>
<div class="card mb-3">
  <div class="card-header">
    <strong><%= ms.name %></strong>
    <% if (ms.startPhase && ms.endPhase) { %>
      <small class="ms-1">(Phases <%= String(ms.startPhase).padStart(2, '0') %>&ndash;<%= String(ms.endPhase).padStart(2, '0') %>)</small>
    <% } %>
    &nbsp;&mdash;&nbsp;
    <span class="status-badge" data-status="complete">complete</span>
  </div>
  <div class="card-body">
    <% if (ms.goal && ms.goal !== 'Completed') { %>
      <p><small><%= ms.goal %></small></p>
    <% } %>
    <p><a href="/milestones"
          hx-get="/milestones"
          hx-target="#main-content"
          hx-push-url="true">View in Milestones</a></p>
  </div>
</div>
<% }); %>
<% } else { %>

<%
  // Group phases by milestone
  const msGroups = (typeof milestones !== 'undefined' && milestones.length > 0)
    ? milestones.map(m => ({
        ...m,
        phases: phases.filter(p => p.id >= m.startPhase && p.id <= m.endPhase)
      })).filter(g => g.phases.length > 0)
    : [{ name: 'All Phases', goal: '', startPhase: 1, endPhase: 9999, phases: phases }];

  const coveredIds = new Set(msGroups.flatMap(g => g.phases.map(p => p.id)));
  const ungroupedPhases = phases.filter(p => !coveredIds.has(p.id));
%>

<!-- Overall Progress -->
<div class="card mb-3">
  <div class="card-header"><strong>Overall Progress</strong></div>
  <div class="card-body">
    <%
      const totalComplete = phases.filter(p => p.status === 'complete').length;
      const totalPhases = phases.length;
      const pct = totalPhases > 0 ? Math.round((totalComplete / totalPhases) * 100) : 0;
    %>
    <div class="progress mb-2" style="height:0.5rem">
      <div class="progress-bar" role="progressbar"
           style="width:<%= pct %>%"
           aria-valuenow="<%= totalComplete %>" aria-valuemin="0" aria-valuemax="<%= totalPhases %>">
      </div>
    </div>
    <p><%= pct %>% complete (<%= totalComplete %> of <%= totalPhases %> phases)</p>
  </div>
</div>

<% msGroups.forEach(function(group) { %>
<div class="card mb-3">
  <div class="card-header">
    <strong><%= group.name %></strong>
    <% if (group.startPhase && group.endPhase < 9999) { %>
      <small class="ms-1">(Phases <%= String(group.startPhase).padStart(2, '0') %>&ndash;<%= String(group.endPhase).padStart(2, '0') %>)</small>
    <% } %>
    &nbsp;&mdash;&nbsp;
    <%
      const gc = group.phases.filter(p => p.status === 'complete').length;
      const gt = group.phases.length;
    %>
    <span class="status-badge" data-status="<%= gc === gt ? 'complete' : (gc > 0 ? 'in-progress' : 'not-started') %>">
      <%= gc %>/<%= gt %>
    </span>
  </div>
  <div class="card-body">
    <% if (group.goal) { %>
      <p><small><%= group.goal %></small></p>
    <% } %>
    <div class="table-responsive">
    <table class="table table-vcenter">
      <thead>
        <tr>
          <th scope="col">Phase</th>
          <th scope="col">Name</th>
          <th scope="col">Plans</th>
          <th scope="col">Status</th>
          <th scope="col">Depends On</th>
        </tr>
      </thead>
      <tbody>
        <% group.phases.forEach(function(phase) { %>
        <tr>
          <td><%= String(phase.id).padStart(2, '0') %></td>
          <td>
            <a href="/phases/<%= String(phase.id).padStart(2, '0') %>"
               hx-get="/phases/<%= String(phase.id).padStart(2, '0') %>"
               hx-target="#main-content"
               hx-push-url="true">
              <%= phase.name %>
            </a>
          </td>
          <td><%= phase.planCount %></td>
          <td>
            <span class="status-badge" data-status="<%= phase.status %>">
              <%= phase.status.replace('-', ' ') %>
            </span>
          </td>
          <td>
            <% if (phase.dependencies && phase.dependencies.length > 0) { %>
              <% phase.dependencies.forEach(function(dep, idx) { %>
                <a href="/phases/<%= String(dep).padStart(2, '0') %>"
                   hx-get="/phases/<%= String(dep).padStart(2, '0') %>"
                   hx-target="#main-content"
                   hx-push-url="true"><%= String(dep).padStart(2, '0') %></a><% if (idx < phase.dependencies.length - 1) { %>, <% } %>
              <% }); %>
            <% } else { %>
              <small>None</small>
            <% } %>
          </td>
        </tr>
        <% }); %>
      </tbody>
    </table>
    </div>
  </div>
</div>
<% }); %>

<% if (ungroupedPhases.length > 0) { %>
<div class="card mb-3">
  <div class="card-header"><strong>Other Phases</strong></div>
  <div class="card-body">
    <div class="table-responsive">
    <table class="table table-vcenter">
      <thead>
        <tr>
          <th scope="col">Phase</th>
          <th scope="col">Name</th>
          <th scope="col">Plans</th>
          <th scope="col">Status</th>
          <th scope="col">Depends On</th>
        </tr>
      </thead>
      <tbody>
        <% ungroupedPhases.forEach(function(phase) { %>
        <tr>
          <td><%= String(phase.id).padStart(2, '0') %></td>
          <td>
            <a href="/phases/<%= String(phase.id).padStart(2, '0') %>"
               hx-get="/phases/<%= String(phase.id).padStart(2, '0') %>"
               hx-target="#main-content"
               hx-push-url="true">
              <%= phase.name %>
            </a>
          </td>
          <td><%= phase.planCount %></td>
          <td>
            <span class="status-badge" data-status="<%= phase.status %>">
              <%= phase.status.replace('-', ' ') %>
            </span>
          </td>
          <td>
            <% if (phase.dependencies && phase.dependencies.length > 0) { %>
              <% phase.dependencies.forEach(function(dep, idx) { %>
                <a href="/phases/<%= String(dep).padStart(2, '0') %>"
                   hx-get="/phases/<%= String(dep).padStart(2, '0') %>"
                   hx-target="#main-content"
                   hx-push-url="true"><%= String(dep).padStart(2, '0') %></a><% if (idx < phase.dependencies.length - 1) { %>, <% } %>
              <% }); %>
            <% } else { %>
              <small>None</small>
            <% } %>
          </td>
        </tr>
        <% }); %>
      </tbody>
    </table>
    </div>
  </div>
</div>
<% } %>

<% } %>
