<%- include('breadcrumbs', { breadcrumbs: typeof breadcrumbs !== 'undefined' ? breadcrumbs : [] }) %>
<h1>Phase <%= phaseId %>: <%= phaseName %></h1>

<nav class="phase-nav" aria-label="Phase navigation">
  <% if (typeof prevPhase !== 'undefined' && prevPhase) { %>
    <a href="/phases/<%= String(prevPhase.id).padStart(2, '0') %>"
       hx-get="/phases/<%= String(prevPhase.id).padStart(2, '0') %>"
       hx-target="#main-content"
       hx-push-url="true">
      &larr; Phase <%= String(prevPhase.id).padStart(2, '0') %>: <%= prevPhase.name %>
    </a>
  <% } else { %>
    <span></span>
  <% } %>

  <a href="/phases"
     hx-get="/phases"
     hx-target="#main-content"
     hx-push-url="true">All Phases</a>

  <% if (typeof nextPhase !== 'undefined' && nextPhase) { %>
    <a href="/phases/<%= String(nextPhase.id).padStart(2, '0') %>"
       hx-get="/phases/<%= String(nextPhase.id).padStart(2, '0') %>"
       hx-target="#main-content"
       hx-push-url="true">
      Phase <%= String(nextPhase.id).padStart(2, '0') %>: <%= nextPhase.name %> &rarr;
    </a>
  <% } else { %>
    <span></span>
  <% } %>
</nav>

<% if (verification) { %>
<%
  var vStatus = verification.result || verification.status || verification.verdict || 'unknown';
  var verificationCssStatus = 'not-started';
  if (vStatus === 'pass' || vStatus === 'passed') verificationCssStatus = 'complete';
  else if (vStatus === 'fail' || vStatus === 'failed') verificationCssStatus = 'blocked';
  else if (vStatus === 'partial') verificationCssStatus = 'in-progress';
%>
<div class="card">
  <div class="card__header">
    <strong>Verification Status</strong>
    <span style="float:right;">
      <span class="status-badge" data-status="<%= verificationCssStatus %>"><%= vStatus.toUpperCase() %></span>
    </span>
  </div>
  <div class="card__body">
    <% if (verification.verified) { %>
      <p style="margin:0 0 var(--space-sm);">Verified: <%= new Date(verification.verified).toLocaleString() %></p>
    <% } %>
    <% if (verification.score) { %>
      <p style="margin:0 0 var(--space-sm);">
        Score: <%= verification.score.verified %>/<%= verification.score.total_must_haves %> must-haves verified
        <% if (verification.score.failed > 0) { %>
          &nbsp; <strong><%= verification.score.failed %> FAILED</strong>
        <% } %>
      </p>
    <% } %>
    <% if (verification.mustHaves && verification.mustHaves.length > 0) { %>
      <details>
        <summary>Must-Haves (<%= verification.mustHaves.length %>)</summary>
        <ul style="list-style:none;padding:0;margin:var(--space-sm) 0 0;">
          <% verification.mustHaves.forEach(function(mh) { %>
          <li style="display:flex;gap:var(--space-xs);align-items:flex-start;padding:var(--space-xs) 0;border-bottom:1px solid var(--color-border);">
            <span class="status-badge status-badge--sm" data-status="<%= mh.passed ? 'complete' : 'blocked' %>">
              <%= mh.passed ? 'PASS' : 'FAIL' %>
            </span>
            <span style="flex:1;font-size:0.875rem;"><%= mh.text %></span>
          </li>
          <% }); %>
        </ul>
      </details>
    <% } else if (verification.gaps && verification.gaps.length > 0) { %>
      <details>
        <summary>Verification Gaps (<%= verification.gaps.length %>)</summary>
        <ul><% verification.gaps.forEach(function(gap) { %><li><%= gap %></li><% }); %></ul>
      </details>
    <% } %>
  </div>
</div>
<% } %>

<% if (plans.length === 0) { %>
<!-- Empty State -->
<article>
  <p>No plans found for this phase. This phase may not have been planned yet.</p>
</article>
<% } else { %>

<h2>Plans (<%= plans.length %>)</h2>

<!-- Plan Cards -->
<% plans.forEach(function(plan) { %>
<%
  var planStatus = (plan.summary && plan.summary.status) ? plan.summary.status : 'planned';
  var planCssStatus = planStatus === 'built' ? 'complete'
    : planStatus === 'building' ? 'in-progress'
    : planStatus === 'blocked' ? 'blocked'
    : 'not-started';
  var wave = (plan.summary && plan.summary.wave) ? plan.summary.wave : null;
  var taskCount = plan.taskCount || 0;
  var planTitle = plan.planTitle || ('Plan ' + plan.planId);
%>
<div class="card">
  <div class="card__header">
    <span><strong><%= planTitle %></strong></span>
    <span style="display:inline-flex;gap:var(--space-xs);align-items:center;float:right;">
      <% if (wave) { %>
        <span class="status-badge status-badge--sm" data-status="not-started" title="Wave <%= wave %>">W<%= wave %></span>
      <% } %>
      <% if (taskCount > 0) { %>
        <span class="status-badge status-badge--sm" data-status="not-started"><%= taskCount %> task<%= taskCount !== 1 ? 's' : '' %></span>
      <% } %>
      <span class="status-badge" data-status="<%= planCssStatus %>"><%= planStatus.replace(/-/g, ' ').toUpperCase() %></span>
    </span>
  </div>
  <div class="card__body">
    <p style="margin:0 0 var(--space-sm);">
      <a href="/phases/<%= phaseId %>/<%= plan.planId %>/plan"
         hx-get="/phases/<%= phaseId %>/<%= plan.planId %>/plan"
         hx-target="#main-content" hx-push-url="true">View Plan</a>
      <% if (plan.summary) { %>
        &nbsp;|&nbsp;
        <a href="/phases/<%= phaseId %>/<%= plan.planId %>/summary"
           hx-get="/phases/<%= phaseId %>/<%= plan.planId %>/summary"
           hx-target="#main-content" hx-push-url="true">View Summary</a>
      <% } %>
      <% if (verification) { %>
        &nbsp;|&nbsp;
        <a href="/phases/<%= phaseId %>/<%= plan.planId %>/verification"
           hx-get="/phases/<%= phaseId %>/<%= plan.planId %>/verification"
           hx-target="#main-content" hx-push-url="true">View Verification</a>
      <% } %>
    </p>

    <% if (plan.summary) { %>
      <% if (plan.summary.subsystem) { %>
        <p><strong>Subsystem:</strong> <%= plan.summary.subsystem %></p>
      <% } %>
      <% if (plan.summary.key_decisions && plan.summary.key_decisions.length > 0) { %>
        <details>
          <summary>Key Decisions (<%= plan.summary.key_decisions.length %>)</summary>
          <ul><% plan.summary.key_decisions.forEach(function(d) { %><li><%= d %></li><% }); %></ul>
        </details>
      <% } %>
      <% if (plan.summary.key_files && plan.summary.key_files.length > 0) { %>
        <details>
          <summary>Key Files (<%= plan.summary.key_files.length %>)</summary>
          <ul><% plan.summary.key_files.forEach(function(f) { %><li><code><%= f %></code></li><% }); %></ul>
        </details>
      <% } %>
      <% if (plan.summary.deferred && plan.summary.deferred.length > 0) { %>
        <details>
          <summary>Deferred Items (<%= plan.summary.deferred.length %>)</summary>
          <ul><% plan.summary.deferred.forEach(function(item) { %><li><%= item %></li><% }); %></ul>
        </details>
      <% } %>
      <% if (plan.summary.metrics) { %>
        <p style="margin-top:var(--space-sm);">
          <small>
            <% if (plan.summary.metrics.duration_minutes != null) { %>Duration: <%= plan.summary.metrics.duration_minutes %> min<% } %>
            <% if (plan.summary.metrics.commits != null) { %> | Commits: <%= plan.summary.metrics.commits %><% } %>
            <% if (plan.summary.metrics.files_created != null || plan.summary.metrics.files_modified != null) { %>
               | Files: <%= plan.summary.metrics.files_created || 0 %> created, <%= plan.summary.metrics.files_modified || 0 %> modified
            <% } %>
          </small>
        </p>
      <% } %>
    <% } else { %>
      <p><em>Plan file exists but has not been executed yet. No summary available.</em></p>
    <% } %>
  </div>
</div>
<% }); %>

<% } %>

<!-- Commit History Section -->
<%
  var allCommits = [];
  plans.forEach(function(plan) {
    if (plan.commits && plan.commits.length > 0) {
      plan.commits.forEach(function(commit) {
        allCommits.push({ planId: plan.planId, commit: commit });
      });
    }
  });

  // Extract commit type from task string: "NN-NN-T1: feat(scope): msg" -> "feat"
  function commitType(entry) {
    var m = entry.commit.task && entry.commit.task.match(/\b(feat|fix|refactor|test|docs|chore|wip|perf)\b/i);
    return m ? m[1].toLowerCase() : 'chore';
  }

  var typeStatusMap = {
    feat: 'complete', fix: 'in-progress', refactor: 'not-started',
    test: 'not-started', docs: 'not-started', chore: 'not-started',
    wip: 'in-progress', perf: 'complete'
  };
%>

<h2>Commit History (<%= allCommits.length %>)</h2>

<% if (allCommits.length === 0) { %>
<div class="card"><div class="card__body"><p><em>No commits yet for this phase.</em></p></div></div>
<% } else { %>
<ol class="commit-timeline">
  <% allCommits.forEach(function(entry) { %>
  <%
    var ctype = commitType(entry);
    var cStatus = typeStatusMap[ctype] || 'not-started';
    var verifyStatus = entry.commit.verify === 'passed' ? 'complete'
      : entry.commit.verify === 'failed' ? 'blocked' : 'in-progress';
  %>
  <li class="commit-timeline__item">
    <span class="status-badge status-badge--sm" data-status="<%= cStatus %>" title="<%= ctype %>"><%= ctype %></span>
    <code class="commit-timeline__hash"><%= entry.commit.hash %></code>
    <span class="commit-timeline__task"><%= entry.commit.task %></span>
    <span class="commit-timeline__meta">
      plan <strong><%= entry.planId %></strong>
      &middot; <%= entry.commit.files %> file<%= entry.commit.files !== 1 ? 's' : '' %>
      &middot; <span class="status-badge status-badge--sm" data-status="<%= verifyStatus %>"><%= entry.commit.verify %></span>
    </span>
  </li>
  <% }); %>
</ol>
<% } %>
