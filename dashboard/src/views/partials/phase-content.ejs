<h1>Phase <%= phaseId %>: <%= phaseName %></h1>

<p><a href="/">&larr; Back to Dashboard</a></p>

<% if (verification) { %>
<!-- Verification Summary Card -->
<article>
  <header>
    <strong>Verification Status</strong>
  </header>
  <%
    // Map verification status to CSS status-badge data-status values
    var verificationCssStatus = 'not-started';
    if (verification.status === 'passed') verificationCssStatus = 'complete';
    else if (verification.status === 'failed') verificationCssStatus = 'blocked';
    else if (verification.status === 'partial') verificationCssStatus = 'in-progress';
  %>
  <p>
    <span class="status-badge" data-status="<%= verificationCssStatus %>">
      <%= verification.status.toUpperCase() %>
    </span>
    <% if (verification.verified) { %>
      &nbsp; Verified: <%= new Date(verification.verified).toLocaleString() %>
    <% } %>
  </p>
  <% if (verification.score) { %>
    <p>
      Score: <%= verification.score.verified %>/<%= verification.score.total_must_haves %> must-haves verified
    </p>
    <% if (verification.score.failed > 0) { %>
      <p><strong><%= verification.score.failed %> must-haves FAILED</strong></p>
    <% } %>
  <% } %>
  <% if (verification.gaps && verification.gaps.length > 0) { %>
    <details>
      <summary>Verification Gaps (<%= verification.gaps.length %>)</summary>
      <ul>
        <% verification.gaps.forEach(function(gap) { %>
          <li><%= gap %></li>
        <% }); %>
      </ul>
    </details>
  <% } %>
</article>
<% } %>

<% if (plans.length === 0) { %>
<!-- Empty State -->
<article>
  <p>No plans found for this phase. This phase may not have been planned yet.</p>
</article>
<% } else { %>

<h2>Plans (<%= plans.length %>)</h2>

<!-- Plan Cards -->
<% plans.forEach(function(plan) { %>
<article>
  <header>
    <strong>Plan <%= plan.planId %></strong>
    <% if (plan.summary && plan.summary.status) { %>
      &nbsp;
      <span class="status-badge" data-status="<%= plan.summary.status %>">
        <%= plan.summary.status.replace('-', ' ') %>
      </span>
    <% } %>
  </header>

  <% if (plan.summary) { %>

    <% if (plan.summary.subsystem) { %>
      <p><strong>Subsystem:</strong> <%= plan.summary.subsystem %></p>
    <% } %>

    <% if (plan.summary.key_decisions && plan.summary.key_decisions.length > 0) { %>
      <details>
        <summary>Key Decisions (<%= plan.summary.key_decisions.length %>)</summary>
        <ul>
          <% plan.summary.key_decisions.forEach(function(decision) { %>
            <li><%= decision %></li>
          <% }); %>
        </ul>
      </details>
    <% } %>

    <% if (plan.summary.key_files && plan.summary.key_files.length > 0) { %>
      <details>
        <summary>Key Files (<%= plan.summary.key_files.length %>)</summary>
        <ul>
          <% plan.summary.key_files.forEach(function(file) { %>
            <li><code><%= file %></code></li>
          <% }); %>
        </ul>
      </details>
    <% } %>

    <% if (plan.summary.deferred && plan.summary.deferred.length > 0) { %>
      <details>
        <summary>Deferred Items (<%= plan.summary.deferred.length %>)</summary>
        <ul>
          <% plan.summary.deferred.forEach(function(item) { %>
            <li><%= item %></li>
          <% }); %>
        </ul>
      </details>
    <% } %>

    <% if (plan.summary.metrics) { %>
      <p>
        <small>
          <% if (plan.summary.metrics.duration_minutes != null) { %>
            Duration: <%= plan.summary.metrics.duration_minutes %> min
          <% } %>
          <% if (plan.summary.metrics.commits != null) { %>
            | Commits: <%= plan.summary.metrics.commits %>
          <% } %>
          <% if (plan.summary.metrics.files_created != null || plan.summary.metrics.files_modified != null) { %>
            | Files: <%= plan.summary.metrics.files_created || 0 %> created, <%= plan.summary.metrics.files_modified || 0 %> modified
          <% } %>
        </small>
      </p>
    <% } %>

  <% } else { %>
    <!-- Plan exists but not executed yet -->
    <p><em>Plan file exists but has not been executed yet. No summary available.</em></p>
  <% } %>
</article>
<% }); %>

<% } %>

<!-- Commit History Section -->
<%
  // Collect all commits across all plans, tagged with their planId
  var allCommits = [];
  plans.forEach(function(plan) {
    if (plan.commits && plan.commits.length > 0) {
      plan.commits.forEach(function(commit) {
        allCommits.push({ planId: plan.planId, commit: commit });
      });
    }
  });
%>

<h2>Commit History (<%= allCommits.length %>)</h2>

<% if (allCommits.length === 0) { %>
<article>
  <p><em>No commits yet for this phase.</em></p>
</article>
<% } else { %>
<div class="table-wrap">
<table>
  <thead>
    <tr>
      <th>Commit</th>
      <th>Task</th>
      <th>Plan</th>
      <th>Files</th>
      <th>Status</th>
    </tr>
  </thead>
  <tbody>
    <% allCommits.forEach(function(entry) { %>
    <tr>
      <td><code><%= entry.commit.hash %></code></td>
      <td><%= entry.commit.task %></td>
      <td><%= entry.planId %></td>
      <td><%= entry.commit.files %></td>
      <td>
        <span class="status-badge" data-status="<%= entry.commit.verify === 'passed' ? 'complete' : (entry.commit.verify === 'failed' ? 'blocked' : 'in-progress') %>">
          <%= entry.commit.verify %>
        </span>
      </td>
    </tr>
    <% }); %>
  </tbody>
</table>
</div>
<% } %>
