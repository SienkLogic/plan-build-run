<%- include('breadcrumbs', { breadcrumbs: typeof breadcrumbs !== 'undefined' ? breadcrumbs : [] }) %>

<h1>Project Analytics</h1>

<% if (typeof analytics !== 'undefined' && analytics.warning) { %>
<article aria-label="warning" class="pico-background-yellow-100">
  <strong>Warning:</strong> <%= analytics.warning %>
</article>
<% } %>

<% if (typeof analytics !== 'undefined' && analytics.summary) { %>
<div class="grid">
  <article>
    <header>Total Commits</header>
    <strong class="stat-value"><%= analytics.summary.totalCommits %></strong>
    <span class="stat-unit">commits</span>
  </article>
  <article>
    <header>Total Phases</header>
    <strong class="stat-value"><%= analytics.summary.totalPhases %></strong>
    <span class="stat-unit">phases</span>
  </article>
  <article>
    <header>Avg Duration</header>
    <strong class="stat-value"><%= analytics.summary.avgDuration %></strong>
    <span class="stat-unit">days</span>
  </article>
  <article>
    <header>Lines Changed</header>
    <strong class="stat-value"><%= analytics.summary.totalLinesChanged.toLocaleString() %></strong>
    <span class="stat-unit">lines</span>
  </article>
</div>
<% } %>

<% if (typeof analytics !== 'undefined' && analytics.phases && analytics.phases.length > 0) { %>
<article>
  <header>Per-Phase Metrics</header>
  <div class="overflow-auto">
    <table>
      <thead>
        <tr>
          <th>Phase</th>
          <th>Commits</th>
          <th>Duration</th>
          <th>Plans</th>
          <th>Lines Changed</th>
        </tr>
      </thead>
      <tbody>
        <% analytics.phases.sort((a, b) => a.phaseId.localeCompare(b.phaseId)).forEach(phase => { %>
        <tr>
          <td>
            <a href="/phases/<%= phase.phaseId %>"
               hx-get="/phases/<%= phase.phaseId %>"
               hx-target="#main-content"
               hx-push-url="true">
              <%= phase.phaseId %> - <%= phase.phaseName %>
            </a>
          </td>
          <td><%= phase.commitCount %></td>
          <td><%= phase.duration || 'N/A' %></td>
          <td><%= phase.planCount %></td>
          <td><%= phase.linesChanged.toLocaleString() %></td>
        </tr>
        <% }) %>
      </tbody>
    </table>
  </div>
</article>

<% const maxCommits = Math.max(...analytics.phases.map(p => p.commitCount), 1); %>
<article>
  <header>Commits by Phase</header>
  <div style="padding: var(--space-md) var(--space-lg);">
    <% analytics.phases.sort((a, b) => a.phaseId.localeCompare(b.phaseId)).forEach(phase => { %>
    <div class="bar-chart-row">
      <span class="bar-chart-label"><%= phase.phaseId %> - <%= phase.phaseName %></span>
      <div class="bar-chart-bar" style="width: <%= (phase.commitCount / maxCommits * 100) %>%">
        <%= phase.commitCount %>
      </div>
    </div>
    <% }) %>
  </div>
</article>
<% } else if (typeof analytics === 'undefined' || !analytics.summary) { %>
<%- include('empty-state', { icon: 'ðŸ“Š', title: 'No analytics data available', action: '' }) %>
<% } else { %>
<p>No phase data available.</p>
<% } %>
