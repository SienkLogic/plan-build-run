<%- include('breadcrumbs', { breadcrumbs: typeof breadcrumbs !== 'undefined' ? breadcrumbs : [] }) %>

<h1>Project Analytics</h1>

<% if (typeof analytics !== 'undefined' && analytics.warning) { %>
<div class="alert alert-warning" role="alert"><strong>Warning:</strong> <%= analytics.warning %></div>
<% } %>

<% if (typeof analytics !== 'undefined' && analytics.summary) { %>
<div class="row row-cards mb-4">
  <div class="col-6 col-lg-3">
    <div class="card card-sm">
      <div class="card-body">
        <div class="row align-items-center">
          <div class="col">
            <div class="font-weight-medium">Total Commits</div>
            <div class="text-muted small">commits</div>
          </div>
          <div class="col-auto">
            <strong class="stat-value"><%= analytics.summary.totalCommits %></strong>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="col-6 col-lg-3">
    <div class="card card-sm">
      <div class="card-body">
        <div class="row align-items-center">
          <div class="col">
            <div class="font-weight-medium">Total Phases</div>
            <div class="text-muted small">phases</div>
          </div>
          <div class="col-auto">
            <strong class="stat-value"><%= analytics.summary.totalPhases %></strong>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="col-6 col-lg-3">
    <div class="card card-sm">
      <div class="card-body">
        <div class="row align-items-center">
          <div class="col">
            <div class="font-weight-medium">Avg Duration</div>
            <div class="text-muted small">days</div>
          </div>
          <div class="col-auto">
            <strong class="stat-value"><%= analytics.summary.avgDuration %></strong>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="col-6 col-lg-3">
    <div class="card card-sm">
      <div class="card-body">
        <div class="row align-items-center">
          <div class="col">
            <div class="font-weight-medium">Lines Changed</div>
            <div class="text-muted small">lines</div>
          </div>
          <div class="col-auto">
            <strong class="stat-value"><%= analytics.summary.totalLinesChanged.toLocaleString() %></strong>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
<% } %>

<% if (typeof analytics !== 'undefined' && analytics.phases && analytics.phases.length > 0) { %>
<div class="card mb-4">
  <div class="card-header">Per-Phase Metrics</div>
  <div class="card-body table-responsive">
    <table class="table table-vcenter">
      <thead>
        <tr>
          <th>Phase</th>
          <th>Commits</th>
          <th>Duration</th>
          <th>Plans</th>
          <th>Lines Changed</th>
        </tr>
      </thead>
      <tbody>
        <% analytics.phases.sort((a, b) => a.phaseId.localeCompare(b.phaseId)).forEach(phase => { %>
        <tr>
          <td>
            <a href="/phases/<%= phase.phaseId %>"
               hx-get="/phases/<%= phase.phaseId %>"
               hx-target="#main-content"
               hx-push-url="true">
              <%= phase.phaseId %> - <%= phase.phaseName %>
            </a>
          </td>
          <td><%= phase.commitCount %></td>
          <td><%= phase.duration || 'N/A' %></td>
          <td><%= phase.planCount %></td>
          <td><%= phase.linesChanged.toLocaleString() %></td>
        </tr>
        <% }) %>
      </tbody>
    </table>
  </div>
</div>

<% const maxCommits = Math.max(...analytics.phases.map(p => p.commitCount), 1); %>
<div class="card mb-4">
  <div class="card-header">Commits by Phase</div>
  <div class="card-body">
    <% analytics.phases.sort((a, b) => a.phaseId.localeCompare(b.phaseId)).forEach(phase => { %>
    <div class="bar-chart-row">
      <span class="bar-chart-label"><%= phase.phaseId %> - <%= phase.phaseName %></span>
      <div class="bar-chart-bar" style="width: <%= (phase.commitCount / maxCommits * 100) %>%">
        <%= phase.commitCount %>
      </div>
    </div>
    <% }) %>
  </div>
</div>
<% } else if (typeof analytics === 'undefined' || !analytics.summary) { %>
<%- include('empty-state', { icon: 'ðŸ“Š', title: 'No analytics data available', action: '' }) %>
<% } else { %>
<p>No phase data available.</p>
<% } %>

<% if (typeof llmMetrics !== 'undefined' && llmMetrics) { %>
<div class="card mb-4">
  <div class="card-header">Local LLM Offload</div>
  <div class="card-body">
    <div class="row row-cards mb-3">
      <div class="col-6 col-lg">
        <div class="card card-sm">
          <div class="card-body">
            <div class="row align-items-center">
              <div class="col">
                <div class="font-weight-medium">Total Calls</div>
                <div class="text-muted small">calls</div>
              </div>
              <div class="col-auto">
                <strong class="stat-value"><%= llmMetrics.summary.total_calls %></strong>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-6 col-lg">
        <div class="card card-sm">
          <div class="card-body">
            <div class="row align-items-center">
              <div class="col">
                <div class="font-weight-medium">Tokens Saved</div>
                <div class="text-muted small">frontier tokens</div>
              </div>
              <div class="col-auto">
                <strong class="stat-value"><%= llmMetrics.summary.tokens_saved.toLocaleString() %></strong>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-6 col-lg">
        <div class="card card-sm">
          <div class="card-body">
            <div class="row align-items-center">
              <div class="col">
                <div class="font-weight-medium">Cost Saved</div>
                <div class="text-muted small">at $3/M tokens</div>
              </div>
              <div class="col-auto">
                <strong class="stat-value">$<%= llmMetrics.summary.cost_saved_usd.toFixed(4) %></strong>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-6 col-lg">
        <div class="card card-sm">
          <div class="card-body">
            <div class="row align-items-center">
              <div class="col">
                <div class="font-weight-medium">Fallbacks</div>
                <div class="text-muted small"><%= llmMetrics.summary.fallback_count %> fallbacks</div>
              </div>
              <div class="col-auto">
                <strong class="stat-value"><%= llmMetrics.summary.fallback_rate_pct %>%</strong>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-6 col-lg">
        <div class="card card-sm">
          <div class="card-body">
            <div class="row align-items-center">
              <div class="col">
                <div class="font-weight-medium">Latency</div>
                <div class="text-muted small">ms/call</div>
              </div>
              <div class="col-auto">
                <strong class="stat-value"><%= llmMetrics.summary.avg_latency_ms %></strong>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <% if (llmMetrics.byOperation && llmMetrics.byOperation.length > 0) { %>
    <div class="table-responsive">
      <table class="table table-vcenter">
        <thead>
          <tr>
            <th>Operation</th>
            <th>Calls</th>
            <th>Fallbacks</th>
            <th>Tokens Saved</th>
          </tr>
        </thead>
        <tbody>
          <% llmMetrics.byOperation.forEach(op => { %>
          <tr>
            <td><%= op.operation %></td>
            <td><%= op.calls %></td>
            <td><%= op.fallbacks %></td>
            <td><%= op.tokens_saved.toLocaleString() %></td>
          </tr>
          <% }) %>
        </tbody>
      </table>
    </div>
    <% } %>
  </div>
  <div class="card-footer text-muted small">
    Baseline estimate: each local call replaced ~<%= llmMetrics.baseline.estimated_frontier_tokens_without_local.toLocaleString() %> frontier tokens total.
    Advisory only â€” no data collected when local LLM is disabled.
  </div>
</div>
<% } %>
