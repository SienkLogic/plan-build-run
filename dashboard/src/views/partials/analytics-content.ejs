<%- include('breadcrumbs', { breadcrumbs: typeof breadcrumbs !== 'undefined' ? breadcrumbs : [] }) %>

<h1>Project Analytics</h1>

<% if (typeof analytics !== 'undefined' && analytics.warning) { %>
<article aria-label="warning" class="pico-background-yellow-100">
  <strong>Warning:</strong> <%= analytics.warning %>
</article>
<% } %>

<% if (typeof analytics !== 'undefined' && analytics.summary) { %>
<div class="grid">
  <article>
    <header>Total Commits</header>
    <strong class="stat-value"><%= analytics.summary.totalCommits %></strong>
    <span class="stat-unit">commits</span>
  </article>
  <article>
    <header>Total Phases</header>
    <strong class="stat-value"><%= analytics.summary.totalPhases %></strong>
    <span class="stat-unit">phases</span>
  </article>
  <article>
    <header>Avg Duration</header>
    <strong class="stat-value"><%= analytics.summary.avgDuration %></strong>
    <span class="stat-unit">days</span>
  </article>
  <article>
    <header>Lines Changed</header>
    <strong class="stat-value"><%= analytics.summary.totalLinesChanged.toLocaleString() %></strong>
    <span class="stat-unit">lines</span>
  </article>
</div>
<% } %>

<% if (typeof analytics !== 'undefined' && analytics.phases && analytics.phases.length > 0) { %>
<article>
  <header>Per-Phase Metrics</header>
  <div class="overflow-auto">
    <table>
      <thead>
        <tr>
          <th>Phase</th>
          <th>Commits</th>
          <th>Duration</th>
          <th>Plans</th>
          <th>Lines Changed</th>
        </tr>
      </thead>
      <tbody>
        <% analytics.phases.sort((a, b) => a.phaseId.localeCompare(b.phaseId)).forEach(phase => { %>
        <tr>
          <td>
            <a href="/phases/<%= phase.phaseId %>"
               hx-get="/phases/<%= phase.phaseId %>"
               hx-target="#main-content"
               hx-push-url="true">
              <%= phase.phaseId %> - <%= phase.phaseName %>
            </a>
          </td>
          <td><%= phase.commitCount %></td>
          <td><%= phase.duration || 'N/A' %></td>
          <td><%= phase.planCount %></td>
          <td><%= phase.linesChanged.toLocaleString() %></td>
        </tr>
        <% }) %>
      </tbody>
    </table>
  </div>
</article>

<% const maxCommits = Math.max(...analytics.phases.map(p => p.commitCount), 1); %>
<article>
  <header>Commits by Phase</header>
  <div style="padding: var(--space-md) var(--space-lg);">
    <% analytics.phases.sort((a, b) => a.phaseId.localeCompare(b.phaseId)).forEach(phase => { %>
    <div class="bar-chart-row">
      <span class="bar-chart-label"><%= phase.phaseId %> - <%= phase.phaseName %></span>
      <div class="bar-chart-bar" style="width: <%= (phase.commitCount / maxCommits * 100) %>%">
        <%= phase.commitCount %>
      </div>
    </div>
    <% }) %>
  </div>
</article>
<% } else if (typeof analytics === 'undefined' || !analytics.summary) { %>
<%- include('empty-state', { icon: 'ðŸ“Š', title: 'No analytics data available', action: '' }) %>
<% } else { %>
<p>No phase data available.</p>
<% } %>

<% if (typeof llmMetrics !== 'undefined' && llmMetrics) { %>
<article>
  <header>Local LLM Offload</header>
  <div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(140px,1fr))">
    <article>
      <header>Total Calls</header>
      <strong class="stat-value"><%= llmMetrics.summary.total_calls %></strong>
      <span class="stat-unit">calls</span>
    </article>
    <article>
      <header>Tokens Saved</header>
      <strong class="stat-value"><%= llmMetrics.summary.tokens_saved.toLocaleString() %></strong>
      <span class="stat-unit">frontier tokens</span>
    </article>
    <article>
      <header>Cost Saved</header>
      <strong class="stat-value">$<%= llmMetrics.summary.cost_saved_usd.toFixed(4) %></strong>
      <span class="stat-unit">at $3/M tokens</span>
    </article>
    <article>
      <header>Fallbacks</header>
      <strong class="stat-value"><%= llmMetrics.summary.fallback_rate_pct %>%</strong>
      <span class="stat-unit"><%= llmMetrics.summary.fallback_count %> fallbacks</span>
    </article>
    <article>
      <header>Latency</header>
      <strong class="stat-value"><%= llmMetrics.summary.avg_latency_ms %></strong>
      <span class="stat-unit">ms/call</span>
    </article>
  </div>
  <% if (llmMetrics.byOperation && llmMetrics.byOperation.length > 0) { %>
  <div class="overflow-auto" style="margin-top: var(--space-md);">
    <table>
      <thead>
        <tr>
          <th>Operation</th>
          <th>Calls</th>
          <th>Fallbacks</th>
          <th>Tokens Saved</th>
        </tr>
      </thead>
      <tbody>
        <% llmMetrics.byOperation.forEach(op => { %>
        <tr>
          <td><%= op.operation %></td>
          <td><%= op.calls %></td>
          <td><%= op.fallbacks %></td>
          <td><%= op.tokens_saved.toLocaleString() %></td>
        </tr>
        <% }) %>
      </tbody>
    </table>
  </div>
  <% } %>
  <footer style="color: var(--pico-muted-color); font-size: 0.85em;">
    Baseline estimate: each local call replaced ~<%= llmMetrics.baseline.estimated_frontier_tokens_without_local.toLocaleString() %> frontier tokens total.
    Advisory only â€” no data collected when local LLM is disabled.
  </footer>
</article>
<% } %>
