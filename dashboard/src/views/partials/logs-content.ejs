<%- include('breadcrumbs', { breadcrumbs: typeof breadcrumbs !== 'undefined' ? breadcrumbs : [] }) %>
<h1>Logs</h1>

<% if (!logFiles || logFiles.length === 0) { %>
<%- include('empty-state', { icon: 'L', title: 'No log files found', action: 'Log files appear in .planning/logs/ when PBR hooks run with local LLM routing enabled.' }) %>
<% } else { %>

<div class="logs-layout" style="display:flex;gap:var(--spacing-md);align-items:flex-start">

  <%# File browser sidebar %>
  <aside style="min-width:220px;max-width:260px;flex-shrink:0">
    <article>
      <header><strong>Log Files</strong></header>
      <ul style="list-style:none;padding:0;margin:0">
        <% logFiles.forEach(function(lf) { %>
        <li style="padding:0.25rem 0;border-bottom:1px solid var(--card-border)">
          <a href="/logs?file=<%= lf.name %>"
             hx-get="/logs?file=<%= lf.name %>"
             hx-target="#main-content"
             hx-push-url="true"
             <% if (selectedFile === lf.name) { %>aria-current="page"<% } %>>
            <%= lf.name %>
          </a>
          <br>
          <small><%= Math.round(lf.size / 1024) %> KB &middot; <%= lf.modified ? lf.modified.slice(0,10) : '' %></small>
        </li>
        <% }); %>
      </ul>
    </article>
  </aside>

  <%# Main log viewer %>
  <div style="flex:1;min-width:0">
    <% if (selectedFile) { %>

    <%# Filter controls %>
    <form hx-get="/logs"
          hx-target="#main-content"
          hx-push-url="true"
          style="display:flex;gap:0.5rem;flex-wrap:wrap;margin-bottom:var(--spacing-sm)">
      <input type="hidden" name="file" value="<%= selectedFile %>">
      <input type="text" name="type" placeholder="Type filter (e.g. tool_use)"
             value="<%= typeof filters !== 'undefined' ? filters.type : '' %>"
             style="width:200px">
      <input type="search" name="q" placeholder="Search entries..."
             value="<%= typeof filters !== 'undefined' ? filters.q : '' %>"
             style="flex:1;min-width:160px">
      <button type="submit">Filter</button>
      <% if (typeof filters !== 'undefined' && (filters.type || filters.q)) { %>
      <a href="/logs?file=<%= selectedFile %>"
         hx-get="/logs?file=<%= selectedFile %>"
         hx-target="#main-content"
         hx-push-url="true"
         role="button" class="secondary">Clear</a>
      <% } %>
    </form>

    <%# Auto-scroll toggle + live indicator %>
    <div style="display:flex;align-items:center;gap:1rem;margin-bottom:var(--spacing-sm)">
      <label style="display:flex;align-items:center;gap:0.4rem;cursor:pointer">
        <input type="checkbox" id="auto-scroll-toggle" checked style="margin:0">
        <small>Auto-scroll</small>
      </label>
      <span id="live-indicator" class="status-badge" data-status="active" style="display:none">LIVE</span>
    </div>

    <%# Entry list: SSE target + initial content %>
    <div id="log-entries-wrap"
         hx-ext="sse"
         sse-connect="/logs/stream?file=<%= selectedFile %>"
         sse-swap="log-entry"
         hx-swap="beforeend"
         hx-target="#log-entries"
         style="position:relative">
      <%- include('log-entries-content') %>
    </div>

    <%# Pagination %>
    <% if (logData && logData.total > logData.pageSize) { %>
    <nav style="display:flex;gap:0.5rem;margin-top:var(--spacing-sm);align-items:center">
      <% const totalPages = Math.ceil(logData.total / logData.pageSize); %>
      <% if (logData.page > 1) { %>
      <a href="/logs?file=<%= selectedFile %>&page=<%= logData.page - 1 %>&type=<%= (filters || {}).type || '' %>&q=<%= (filters || {}).q || '' %>"
         hx-get="/logs?file=<%= selectedFile %>&page=<%= logData.page - 1 %>&type=<%= (filters || {}).type || '' %>&q=<%= (filters || {}).q || '' %>"
         hx-target="#main-content"
         hx-push-url="true"
         role="button" class="secondary">&larr; Prev</a>
      <% } %>
      <small>Page <%= logData.page %> of <%= totalPages %> (<%= logData.total %> entries)</small>
      <% if (logData.page < totalPages) { %>
      <a href="/logs?file=<%= selectedFile %>&page=<%= logData.page + 1 %>&type=<%= (filters || {}).type || '' %>&q=<%= (filters || {}).q || '' %>"
         hx-get="/logs?file=<%= selectedFile %>&page=<%= logData.page + 1 %>&type=<%= (filters || {}).type || '' %>&q=<%= (filters || {}).q || '' %>"
         hx-target="#main-content"
         hx-push-url="true"
         role="button" class="secondary">Next &rarr;</a>
      <% } %>
    </nav>
    <% } %>

    <% } else { %>
    <p>Select a log file to view entries.</p>
    <% } %>
  </div>
</div>

<script>
(function () {
  const wrap = document.getElementById('log-entries-wrap');
  const toggle = document.getElementById('auto-scroll-toggle');
  const indicator = document.getElementById('live-indicator');

  if (!wrap || !toggle) return;

  // Show live indicator when SSE connects
  wrap.addEventListener('htmx:sseOpen', () => {
    if (indicator) indicator.style.display = '';
  });
  wrap.addEventListener('htmx:sseClose', () => {
    if (indicator) indicator.style.display = 'none';
  });

  // Auto-scroll: when a new log-entry SSE event adds content, scroll to bottom
  wrap.addEventListener('htmx:afterSwap', () => {
    if (toggle && toggle.checked) {
      const list = document.getElementById('log-entries');
      if (list) list.scrollTop = list.scrollHeight;
    }
  });
})();
</script>
<% } %>
