<%- include('breadcrumbs', { breadcrumbs: typeof breadcrumbs !== 'undefined' ? breadcrumbs : [] }) %>
<h1>Logs</h1>

<% if (!logFiles || logFiles.length === 0) { %>
<%- include('empty-state', { icon: 'L', title: 'No log files found', action: 'Log files appear in .planning/logs/ when PBR hooks run with local LLM routing enabled.' }) %>
<% } else { %>

<div class="d-flex gap-3 align-items-start">

  <%# File browser sidebar %>
  <aside style="min-width:220px;max-width:260px;flex-shrink:0">
    <div class="card">
      <div class="card-header"><strong>Log Files</strong></div>
      <div class="list-group list-group-flush">
        <% logFiles.forEach(function(lf) { %>
        <a href="/logs?file=<%= lf.name %>"
           hx-get="/logs?file=<%= lf.name %>"
           hx-target="#main-content"
           hx-push-url="true"
           class="list-group-item list-group-item-action<% if (selectedFile === lf.name) { %> active<% } %>">
          <%= lf.name %>
          <br><small class="text-muted"><%= Math.round(lf.size / 1024) %> KB &middot; <%= lf.modified ? lf.modified.slice(0,10) : '' %></small>
        </a>
        <% }); %>
      </div>
    </div>
  </aside>

  <%# Main log viewer %>
  <div style="flex:1;min-width:0">
    <% if (selectedFile) { %>

    <%# Filter controls %>
    <form hx-get="/logs"
          hx-target="#main-content"
          hx-push-url="true"
          class="d-flex flex-wrap gap-2 mb-2">
      <input type="hidden" name="file" value="<%= selectedFile %>">
      <input type="text" name="type" placeholder="Type filter (e.g. tool_use)"
             value="<%= typeof filters !== 'undefined' ? filters.type : '' %>"
             class="form-control" style="width:200px">
      <input type="search" name="q" placeholder="Search entries..."
             value="<%= typeof filters !== 'undefined' ? filters.q : '' %>"
             class="form-control flex-grow-1" style="min-width:160px">
      <button type="submit" class="btn btn-outline-secondary">Filter</button>
      <% if (typeof filters !== 'undefined' && (filters.type || filters.q)) { %>
      <a href="/logs?file=<%= selectedFile %>"
         hx-get="/logs?file=<%= selectedFile %>"
         hx-target="#main-content"
         hx-push-url="true"
         class="btn btn-outline-secondary">Clear</a>
      <% } %>
    </form>

    <%# Auto-scroll toggle + live indicator %>
    <div class="d-flex align-items-center gap-3 mb-2">
      <label class="d-flex align-items-center gap-2" style="cursor:pointer">
        <input type="checkbox" id="auto-scroll-toggle" checked style="margin:0">
        <small>Auto-scroll</small>
      </label>
      <span id="live-indicator" class="status-badge" data-status="active" style="display:none">LIVE</span>
    </div>

    <%# Entry list: SSE target + initial content %>
    <div id="log-entries-wrap"
         hx-ext="sse"
         sse-connect="/logs/stream?file=<%= selectedFile %>"
         sse-swap="log-entry"
         hx-swap="beforeend"
         hx-target="#log-entries"
         style="position:relative">
      <%- include('log-entries-content') %>
    </div>

    <%# Pagination %>
    <% if (logData && logData.total > logData.pageSize) { %>
    <nav class="d-flex gap-2 mt-2 align-items-center">
      <% const totalPages = Math.ceil(logData.total / logData.pageSize); %>
      <% if (logData.page > 1) { %>
      <a href="/logs?file=<%= selectedFile %>&page=<%= logData.page - 1 %>&type=<%= (filters || {}).type || '' %>&q=<%= (filters || {}).q || '' %>"
         hx-get="/logs?file=<%= selectedFile %>&page=<%= logData.page - 1 %>&type=<%= (filters || {}).type || '' %>&q=<%= (filters || {}).q || '' %>"
         hx-target="#main-content"
         hx-push-url="true"
         class="btn btn-outline-secondary">&larr; Prev</a>
      <% } %>
      <small>Page <%= logData.page %> of <%= totalPages %> (<%= logData.total %> entries)</small>
      <% if (logData.page < totalPages) { %>
      <a href="/logs?file=<%= selectedFile %>&page=<%= logData.page + 1 %>&type=<%= (filters || {}).type || '' %>&q=<%= (filters || {}).q || '' %>"
         hx-get="/logs?file=<%= selectedFile %>&page=<%= logData.page + 1 %>&type=<%= (filters || {}).type || '' %>&q=<%= (filters || {}).q || '' %>"
         hx-target="#main-content"
         hx-push-url="true"
         class="btn btn-outline-secondary">Next &rarr;</a>
      <% } %>
    </nav>
    <% } %>

    <% } else { %>
    <div class="text-center py-4 text-muted">
      <p style="font-size:1.5rem;margin-bottom:0.5rem">&#8592;</p>
      <p>Select a log file from the list to view entries.</p>
    </div>
    <% } %>
  </div>
</div>

<script>
(function () {
  const wrap = document.getElementById('log-entries-wrap');
  const toggle = document.getElementById('auto-scroll-toggle');
  const indicator = document.getElementById('live-indicator');

  if (!wrap || !toggle) return;

  // Show live indicator when SSE connects
  wrap.addEventListener('htmx:sseOpen', () => {
    if (indicator) indicator.style.display = '';
  });
  wrap.addEventListener('htmx:sseClose', () => {
    if (indicator) indicator.style.display = 'none';
  });

  // Auto-scroll: when a new log-entry SSE event adds content, scroll to bottom
  wrap.addEventListener('htmx:afterSwap', () => {
    if (toggle && toggle.checked) {
      const list = document.getElementById('log-entries');
      if (list) list.scrollTop = list.scrollHeight;
    }
  });
})();
</script>
<% } %>
